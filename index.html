<!DOCTYPE html>
<html>
<head>
  <base target="_top">
<style>
    /* -------------------- GENERAL & LOGIN STYLES -------------------- */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f7f9fb;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #333;
      flex-direction: column; 
    }
    .main-box {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 380px;
      text-align: center;
    }
    .logo { color: #e53935; font-size: 28px; font-weight: bold; margin-bottom: 5px; }
    h2 { font-size: 20px; margin-bottom: 10px; font-weight: 500; }
    .demo-text { font-size: 12px; color: #777; margin-bottom: 25px; }
    
    /* GUEST INPUT STYLE (General for all inputs/selects) */
    input[type="text"], input[type="number"], input[type="password"], input[type="email"],
    input[type="date"], input[type="time"]
    { 
      width: calc(100% - 20px); 
      padding: 10px; 
      margin-bottom: 15px; 
      border: 1px solid #ccc; 
      border-radius: 5px; 
      box-sizing: border-box; 
    }

    /* KRITIKAL FIX: Tiyakin na ang SELECT ay naka-inherit ng tamang width at walang margin sa ilalim */
    .filter-group-general select {
        width: 100% !important; 
        height: 40px !important; 
        padding: 8px 10px !important;
        margin-bottom: 0px !important; /* Dapat 0 para pantay sa button */
    }
    
    /* I-override ang general input style para sa select/input sa filter bar */
    .filter-group-general input[type="date"] {
        padding: 8px 10px !important;
        height: 40px !important;
        margin-bottom: 0 !important;
        box-sizing: border-box;
    }

    label { text-align: left; display: block; width: 100%; font-size: 14px; margin-bottom: 5px; font-weight: 600; }
    
    /* Override for Filter Labels */
    .filter-group-general label {
        margin-bottom: 5px !important; /* Konting space lang sa ilalim ng label */
        width: 100% !important;
    }

    button { background-color: #e53935; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; }
    button:hover { background-color: #c62828; }

    /* New Style: Login Error Feedback */
    .input-error {
      border: 1px solid #e53935 !important; 
    }

    .error-message {
      background-color: #ffe5e5; 
      color: #c62828; 
      border: 1px solid #c62828;
      border-radius: 5px;
      padding: 10px;
      font-size: 14px;
      text-align: center;
      margin-bottom: 15px; 
      display: none; 
    }

    /* -------------------- DASHBOARD STYLES -------------------- */
    #dashboardView {
      display: none; 
      position: absolute; 
      top: 0;
      left: 0;
      width: 100%;
      height: 100%; 
      background-color: #f7f9fb;
      box-shadow: none; 
      padding: 0;
      max-width: none;
    }
    .top-header { background-color: #212121; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; height: 40px; }
    .header-logo { color: #e53935; font-size: 24px; font-weight: bold; }
    .user-dropdown-container { position: relative; cursor: pointer; padding: 5px 10px; border-radius: 3px; transition: background-color 0.2s; }
    .user-dropdown-container:hover { background-color: rgba(255, 255, 255, 0.1); }
    .user-dropdown-menu { position: absolute; top: 100%; right: 0; background-color: white; color: #333; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); border-radius: 5px; min-width: 180px; z-index: 1000; display: none; margin-top: 10px; }
    .user-dropdown-menu.visible { display: block; }
    .dropdown-item { padding: 10px 15px; cursor: pointer; font-size: 14px; white-space: nowrap; border-bottom: 1px solid #eee; }
    .dropdown-item:last-child { border-bottom: none; }
    .dropdown-item:hover { background-color: #f5f5f5; }
    .dropdown-item.header { font-weight: bold; color: #e53935; background-color: #fff; border-bottom: 1px solid #ddd; cursor: default; }
    .nav-tabs { background-color: white; border-bottom: 1px solid #ddd; padding: 0 20px; display: flex; }
    .nav-tab { padding: 15px 20px; cursor: pointer; color: #555; font-size: 14px; font-weight: 600; position: relative; }
    .nav-tab.active { color: #e53935; border-bottom: 3px solid #e53935; }
    
@media (min-width: 1024px) {
        /* Magkatabi na sila (flex-row) */
        .main-content-area {
            flex-direction: row; 
            align-items: flex-start;
            
            min-height: calc(100vh - 112px); /* Gawing MIN-HEIGHT */
            height: auto; /* Gawing auto height */
            
            overflow: visible; /* Gawing VISIBLE ang overflow */
        }

 .left-panel {
            flex: 0 0 60%; 
            max-width: 60%;
            
            /* KRITIKAL: ALISIN ANG FIXED HEIGHT AT GUMAMIT NG MIN-HEIGHT */
            height: auto; /* Alisin ang 100% height */
            min-height: calc(100vh - 112px - 48px); /* Para hindi masyadong maliit */
            
            overflow-y: visible; /* Gawing VISIBLE ang overflow */
            padding: 24px; /* Desktop Padding: p-6 (24px) */
        }
    }

    /* --- RIGHT PANEL (Interactive Map) --- */
    .right-panel {
        /* MOBILE DEFAULT: Hidden */
        display: none; 
        
        /* Styling: bg-gray-200 */
        background-color: #e5e7eb; 
        border-left: 1px solid #d1d5db;
        
        /* Padding: p-6 (24px) */
        padding: 24px; 
        box-sizing: border-box;
        flex-direction: column; 
    }

    /* --- 2. RIGHT PANEL (Gray Container - 40% Width) --- */
    .right-panel {
        flex: 4; 
        background-color: #e5e7eb; 
        border-left: 1px solid #d1d5db;
        height: 100%; 
        box-sizing: border-box;
        overflow: hidden; 
        display: flex;
        flex-direction: column; 
    }

    /* --- RIGHT PANEL TITLE --- */
    .fp-outside-title {
        width: 100%;
        text-align: left;
        font-size: 1.25rem; 
        font-weight: 600;   
        color: #111;
        margin-top: 0;
        margin-bottom: 16px; 
        flex-shrink: 0;
    }

    /* Ibalik ang cursor sa default dahil wala nang drag */
    .fp-white-box {
        cursor: default !important; 
        overflow: visible !important; 
        height: auto !important; 
    }

    .fp-white-box:active {
        cursor: grabbing; 
    }
    
    /* --- NEW: STRICT WRAPPER (Ito ang magdidikta ng coordinates) --- */
    .fp-inner-wrapper {
        transform: none !important; 
        display: block;
    }
    
    /* 3. Zoom Control Buttons (Floating) */
    .zoom-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 50; 
    }
    .zoom-btn {
        width: 36px;
        height: 36px;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 18px;
        font-weight: bold;
        color: #555;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .zoom-btn:hover {
        background-color: #f0f0f0;
    }

    /* --- UPDATED MARKER (Enable Mouse Events) --- */
    .fp-viewer-marker {
        position: absolute;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 10;
        width: 100px; 
        transform: translate(-50%, -50%);
        pointer-events: auto; 
        cursor: help; 
    }

    /* --- TOOLTIP STYLE (Hidden by default) --- */
    .fp-tooltip {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        bottom: 45px; 
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(33, 33, 33, 0.95); 
        color: #fff;
        padding: 10px;
        border-radius: 6px;
        font-size: 12px;
        line-height: 1.4;
        text-align: center;
        width: max-content; 
        min-width: 120px;
        transition: opacity 0.2s ease-in-out;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 100; 
    }

    /* Arrow sa ilalim ng tooltip (Optional design) */
    .fp-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: rgba(33, 33, 33, 0.95) transparent transparent transparent;
    }

    /* --- SHOW TOOLTIP ON HOVER --- */
    .fp-viewer-marker:hover .fp-tooltip {
        visibility: visible;
        opacity: 1;
    }

    /* --- LEGEND STYLE (Updated Position) --- */
    .fp-legend {
        position: absolute;
        top: 15px;  
        left: 15px; 
        background-color: rgba(255, 255, 255, 0.9); 
        padding: 8px 12px;
        border-radius: 6px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        border: 1px solid #ccc;
        z-index: 50;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .legend-item {
        display: flex;
        align-items: center;
    }

    .legend-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        margin-right: 8px;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .legend-text {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        font-family: Arial, sans-serif;
    }

    /* Colors for Legend */
    .l-green { background-color: #2ecc71; }
    .l-red { background-color: #e53935; }

    /* Dot Style */
    .fp-viewer-dot {
        width: 18px;
        height: 18px;
        border: 2px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        margin-bottom: 2px;
    }
    
    /* --- STRONG BLINKING ANIMATION --- */
    @keyframes blink-red {
        0% {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.7);
        }
        50% {
            opacity: 0.4; 
            transform: scale(1.3); 
            box-shadow: 0 0 0 10px rgba(229, 57, 53, 0);
        }
        100% {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(229, 57, 53, 0);
        }
    }

    /* --- UPDATED DOT STYLES --- */
    .dot-available { 
        background-color: #2ecc71; 
    } 

    .dot-occupied { 
        background-color: #e53935 !important; 
        animation: blink-red 1s infinite ease-in-out !important; 
        border: 2px solid white; 
        display: block; 
    }  

    .dot-approval { 
        background-color: #f1c40f; 
    }

    /* --- UPDATED LABEL STYLE --- */
    .fp-viewer-label {
        background-color: #ffffff; 
        padding: 6px 12px; 
        border-radius: 15px; 
        font-size: 13px; 
        font-weight: bold; 
        color: #222; 
        text-align: center;
        white-space: nowrap; 
        box-shadow: 0 3px 6px rgba(0,0,0,0.3); 
        margin-top: 5px; 
        pointer-events: none; 
        z-index: 30; 
    }

    /* --- 2. THE IMAGE (Updated with White Border) --- */
    .fp-image-tag {
        width: 100% !important;  
        height: auto !important; 
        display: block;
        object-fit: contain;
        border: 10px solid white; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
        box-sizing: border-box; 
        border-radius: 4px; 
    }


    /* 3. Image sa loob ng white box */
    .fp-image-container {
        width: 100%;
        height: 100%;
        background-size: contain; 
        background-repeat: no-repeat;
        background-position: center;
    }

    /* FINAL FIX: FILTER BAR ALIGNMENT & STYLE */
    .filter-group-general {
        display: flex !important; /* KRITIKAL */
        gap: 20px; 
        margin-bottom: 20px;
        flex-shrink: 0;
        width: 100%;
        flex-wrap: wrap; 
        align-items: flex-end; /* Pantay sa ilalim */
        padding: 0 !important;
    }
    
    /* OVERRIDE para sa filter bar select boxes */
    .filter-group-general select {
        width: 100% !important; 
        height: 40px !important; 
        padding: 8px 10px !important;
        margin-bottom: 0px !important; 
    }

    .filter-group-general label {
        margin-bottom: 5px !important; 
        width: 100% !important;
    }

  /* ITO ANG FINAL STYLE PARA SA TOGGLE BUTTON */
    #calendarToggleButton {
        background-color: white !important;
        color: #2196F3 !important;
        border: 1px solid #2199f380 !important;
        font-weight: 600 !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: all 0.2s;
        /* TANGGALIN ANG FIXED HEIGHT (40px) at PADDING para mag-auto-adjust */
        height: auto !important; /* Dapat auto height */
        padding: 8px 10px !important; /* Konting padding lang */
        margin-bottom: 0 !important;
        margin-top: 0 !important;
        
        /* KRITIKAL: Display as a single, centered row */
        display: flex !important; 
        justify-content: center;
        align-items: center;
        gap: 5px; /* Space sa pagitan ng icon at text */
        line-height: 1.2; 
    }

    #calendarToggleButton:hover {
        background-color: #f0f0f0 !important;
    }
    
    /* END OF FINAL FIX */

    .filter-group-general input[type="date"], .filter-group-general select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .no-items-message { color: #777; margin-top: 50px; }
    .layout-icon { font-size: 50px; color: #bbb; margin-bottom: 10px; }
    .custom-view-container { }
    .custom-view-header h3 { font-size: 24px; color: #333; margin: 0 0 5px 0; }
    .custom-view-header p { color: #777; margin: 0; font-size: 14px; }
    .custom-filters-box { 
        display: flex; 
        gap: 20px; 
        padding: 20px; 
        border: none; 
        border-radius: 5px; 
        background-color: white; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
    }
    .custom-filters-box input[type="date"], .custom-filters-box select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    .custom-filters-box > div { display: flex; flex-direction: column; }
    #listOnlyView { width: 100%; margin: 0 auto; padding: 0; }
    .list-only-header h3 { font-size: 24px; color: #333; margin-bottom: 10px; }
    .list-box { background-color: white; padding: 20px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .list-box p { color: #777; margin: 0; }
    .app-footer { width: 100%; text-align: center; padding: 10px 0; font-size: 12px; color: #777; background-color: #f7f9fb; border-top: 1px solid #eee; }

    /* Styles for Profile View */
    #profileView { width: 100%; max-width: 500px; margin: 0 auto; }
    .profile-heading { font-size: 24px; color: #333; margin-bottom: 20px; }
    .password-form-box { background-color: white; padding: 30px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); }
    .password-form-box h4 { color: #e53935; font-size: 18px; margin-top: 0; margin-bottom: 20px; font-weight: 500; }
    .password-form-box label { margin-bottom: 0px; font-weight: normal; font-size: 13px; color: #555; }
    .password-form-box input[type="password"] { width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 3px; }
    .password-hint { font-size: 12px; color: #777; margin-top: -15px; margin-bottom: 20px; display: block; text-align: left; }
    .save-changes-button { background-color: #e53935; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: bold; float: right; }
    .demo-notice { margin-top: 20px; padding: 15px; background-color: #fffbe5; border: 1px solid #ffe680; border-radius: 5px; display: flex; align-items: center; font-size: 13px; color: #665200; }
    .demo-notice strong { font-size: 18px; margin-right: 10px; color: #ffc107; }

    /* New: Modal/Dialog Styles (Updated for Forms) */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); 
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        display: none; 
    }
    .modal-dialog {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 350px;
        text-align: center;
    }
    .modal-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 0; 
        padding: 15px 20px; 
        border-bottom: 1px solid #eee; 
    }
    .modal-title { font-size: 18px; font-weight: bold; color: #333; }
    .modal-close {
        font-size: 24px;
        font-weight: 300;
        color: #95a5a6;
        cursor: pointer;
        transition: color 0.2s;
        line-height: 1;
    }
    .modal-close:hover { color: #333; }
    .modal-body p { font-size: 14px; color: #555; margin-bottom: 25px; }
    .modal-footer { text-align: right; }
    .modal-ok-button { background-color: #4CAF50; color: white; padding: 10px 25px; border: none; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 14px; }
    .modal-ok-button:hover { background-color: #45a049; }

    /* NEW: Styles for a cleaner removal header */
    .removal-modal-header {
        background-color: white !important; 
        border-radius: 5px 5px 0 0;
        border-bottom: 1px solid #ddd !important;
    }
    .removal-modal-header .modal-title {
        color: #333 !important; 
        font-weight: 600 !important;
    }
    .removal-modal-header .modal-close {
        color: #aaa !important; 
    }


    /* New: Admin Dashboard Layout */
    #adminDashboardContainer {
        display: none; 
        width: 100%;
        height: 100%;
        padding-top: 20px;
        display: flex; 
    }

    .admin-sidebar {
        width: 200px; 
        padding: 0 20px;
        border-right: 1px solid #ddd;
        background-color: white;
        height: 100%;
    }
    .admin-sidebar h4 {
        font-size: 14px;
        color: #e53935;
        font-weight: bold;
        margin-top: 0;
        margin-bottom: 20px;
    }
    .admin-nav-item {
        padding: 10px 10px;
        margin-bottom: 5px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
    }
    .admin-nav-item:hover {
        background-color: #f0f0f0;
    }
    .admin-nav-item.active {
        background-color: #ffe5e5;
        color: #e53935;
        font-weight: bold;
    }
    .admin-nav-item span {
        margin-left: 10px;
    }

    .admin-content {
        flex-grow: 1;
        padding: 0 40px;
        background-color: #f7f9fb;
    }
    .admin-content h1 {
        font-size: 28px;
        font-weight: bold;
        margin-top: 0;
        margin-bottom: 30px;
    }

    /* Users Management List Styles (UPDATED) */
    .users-list-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start; 
        margin-bottom: 0px;
        padding: 0;
        box-shadow: none;
        background-color: transparent;
        border-bottom: 1px solid #ddd; 
    }
    .users-list-header div {
        /* FIX: Added space for the icon in the user management header */
        padding-bottom: 15px; 
        display: flex;
        align-items: center;
    }
    .users-list-header div p {
        /* FIX: Style for the description text */
        font-size: 13px;
        color: #777;
        margin: 0;
        margin-left: 10px;
        margin-top: 2px;
    }
    .add-new-user-btn {
        background-color: #e53935; 
        color: white;
        padding: 10px 15px; /* Bigger padding for a bigger button */
        border: none;
        border-radius: 5px; /* Bigger border radius */
        font-size: 14px; /* Bigger font size */
        font-weight: bold; /* Bold text */
        cursor: pointer;
        margin-top: 0px; 
        align-self: flex-start;
        height: auto; /* Auto height */
        width: auto; /* Auto width */
    }
    .add-new-user-btn:hover {
        background-color: #c62828;
    }

    /* NEW: Container for User/Resource List to fix border issue in Categories Tab */
    .users-list-container {
        border-radius: 5px; 
        overflow: hidden; 
        border: 1px solid #ddd;
    }

    /* UPDATED: User Card Styles (Used for Admin Resources List too) */
    .user-card {
        background-color: white;
        padding: 15px;
        border-radius: 0px; 
        box-shadow: none;
        margin-bottom: 0px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #eee; 
        padding-left: 15px; /* FIX: Added padding for list item */
        padding-right: 15px; /* FIX: Added padding for list item */
    }
    .user-card:first-of-type {
        border-top: none;
    }
    .user-details {
        font-size: 14px;
        flex-grow: 1; 
        padding-left: 0; /* Removed unnecessary left padding */
    }
    .user-details strong {
        font-size: 16px; /* FIX: Bigger size for name */
        color: #e53935; /* FIX: Red color for name */
        display: block;
        margin-bottom: 5px; /* Added margin space for details */
        font-weight: 500;
    }
    .user-details small {
        color: #777;
        line-height: 1.5;
        font-size: 13px; /* FIX: Adjusted font size */
        display: block; /* Make it a full line */
    }
    .user-card button {
        background-color: #f0f0f0; /* FIX: Light gray background for edit */
        color: #555;
        padding: 5px 10px;
        border: 1px solid #ddd; /* FIX: Light gray border for edit */
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        font-weight: normal;
        margin-left: 10px;
        height: 30px;
        width: 50px;
    }
    /* FIX: Remove Button is now only used in Resources tab, Edit in Users tab uses default gray button */
    .user-card .remove-resource-btn {
        background-color: #e53935; 
        color: white;
        border: none;
        width: 70px;
        margin-left: 5px;
    }


    /* 1. Modal Container */
    .form-modal-dialog {
        display: flex !important;
        flex-direction: column !important;
        max-height: 85vh; /* Slightly shorter for better centering */
        width: 100%;
        max-width: 420px !important; /* Standard professional width */
        background-color: white;
        border-radius: 12px; /* More rounded corners */
        box-shadow: 0 10px 30px rgba(0,0,0,0.15); /* Soft, deep shadow */
        margin: auto;
        position: relative;
        overflow: hidden;
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; /* Clean font */
    }

    /* 2. Header */
    .form-modal-header {
        flex-shrink: 0;
        padding: 20px 25px;
        border-bottom: 1px solid #f0f0f0;
        background-color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .form-modal-header .modal-title {
        font-size: 18px;
        font-weight: 600; /* Semi-bold */
        color: #2c3e50; /* Darker, professional gray/blue */
    }
    /* 3. Body (Inputs) */
    .form-modal-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 25px;
        background-color: #fff;
    }

    .form-group { margin-bottom: 20px; }

    .form-group label {
        font-size: 13px;
        font-weight: 600;
        color: #5f6368; /* Subdued label color */
        margin-bottom: 8px;
        display: block;
        text-transform: uppercase; /* Small caps for labels */
        letter-spacing: 0.5px;
    }

    /* Input Styling */
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="date"],
    .form-group input[type="time"],
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 12px 15px; /* Comfortable padding */
        font-size: 14px;
        color: #333;
        border: 1px solid #dfe1e5; /* Google-like light border */
        border-radius: 6px;
        box-sizing: border-box;
        background-color: #fff;
        transition: all 0.2s ease;
        outline: none;
    }

    /* Focus State */
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        border-color: #e53935; /* A.Space Red */
        box-shadow: 0 0 0 3px rgba(229, 57, 53, 0.1); /* Soft glow */
        outline: none;
    }
    /* Date/Time Groups Side-by-Side Fix */
    .date-time-row {
        display: flex;
        gap: 15px;
    }
    .date-time-row > div { flex: 1; }


    .form-group label {
        font-size: 13px;
        font-weight: 600;
        color: #444;
        margin-bottom: 5px;
        display: block;
    }
    /* NOTE: Ang mga ito ay na-override na ng general input style sa taas */
    .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 8px 10px;       
            font-size: 14px;         
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;  
        }
        
    .checkbox-group {
        display: flex;
        gap: 20px;
        margin-top: 10px;
        margin-bottom: 20px;
    }
    .checkbox-group label {
        font-weight: normal;
        margin-bottom: 0;
        font-size: 14px;
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    .checkbox-group input[type="checkbox"] {
        margin-right: 5px;
        width: auto;
        padding: 0;
        margin-top: 0;
    }
    
    /* 1. Footer Container (The Wrapper) */
    .form-modal-footer {
        display: flex !important;          
        flex-direction: row !important;    
        justify-content: space-between;    
        gap: 15px;                         
        padding: 20px 25px;
        border-top: 1px solid #eee;
        background-color: #fff;
    }

    /* 2. General Button Style (Shared) */
    .form-modal-footer button {
        flex: 1 1 0px !important;          
        width: 100% !important;            
        margin: 0 !important;              
        padding: 12px 0 !important;        
        height: 48px;                      
        border-radius: 6px;                
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;            
    }

    /* 3. Cancel Button (Boxy Outline Style) */
    .cancel-button {
        background-color: #ffffff !important;
        color: #555 !important;
        border: 1px solid #ccc !important; 
    }
    .cancel-button:hover {
        background-color: #f5f5f5 !important;
        border-color: #bbb !important;
    }

 /* 4. Reserve Button (Solid Red Style) */
.add-user-button {
    /* PALITAN ITO: background-color: #e53935 !important; */
    background-color: #e53935; /* Normal Red (for default create/save actions) */
    color: white !important;
    /* ... */
}
    .add-user-button:hover {
        background-color: #d32f2f !important;
    }
    .add-user-button:active {
        transform: translateY(1px); 
    }

    /* --- ITEM LIST GRID --- */
    #itemListArea {
        display: grid;
        grid-template-columns: 1fr; 
        gap: 24px; 
        padding-top: 0; 
        background-color: transparent !important; 
        box-shadow: none !important;
    }

    /* Medium Screens (md): 2 Columns */
    @media (min-width: 768px) {
        #itemListArea {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    /* Extra Large Screens (xl): 3 Columns */
    @media (min-width: 1280px) {
        #itemListArea {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .resource-card-user {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px; 
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08); 
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: transform 0.2s;
    }
    .resource-card-user:hover {
        transform: translateY(-5px); 
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    .resource-header-user {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    .resource-name-user {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }
    .status-tag {
        font-size: 11px;
        font-weight: 600;
        padding: 3px 8px;
        border-radius: 12px;
        margin-left: 10px;
        white-space: nowrap;
    }
    .status-available { background-color: #e8f5e9; color: #4CAF50; border: 1px solid #a5d6a7; }
    .approval-tag {
        font-size: 11px;
        font-weight: 600;
        padding: 3px 8px;
        border-radius: 12px;
        margin-left: 10px;
        white-space: nowrap;
        background-color: #fffde7;
        color: #ffb300;
        border: 1px solid #ffecb3;
    }
    .resource-details-user {
        font-size: 13px;
        color: #777;
        margin-bottom: 10px;
    }
    .amenities-container {
        margin-top: 10px;
        margin-bottom: 20px;
    }
    .amenity-tag {
        display: inline-block;
        font-size: 11px;
        background-color: #f0f0f0;
        color: #555;
        padding: 4px 8px;
        border-radius: 15px;
        margin-right: 5px;
        margin-bottom: 5px;
    }
    .reserve-button-user {
        background-color: #e53935;
        color: white;
        padding: 10px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
    }
    .reserve-button-user:hover {
        background-color: #c62828;
    }


    /* NEW: CSS para sa Resources Tab sa Admin */
    .resource-type-header {
        padding: 15px 15px; 
        font-size: 16px;
        font-weight: 600; 
        cursor: default; 
        background-color: #fcfcfc; 
        border-bottom: 1px solid #eee; 
        border-top: 1px solid #ddd; 
    }
    .resource-type-section:first-child .resource-type-header {
        border-top: none; 
    }
    .resource-type-header:hover {
        background-color: #fcfcfc; 
    }
    .resource-type-section:last-child .resource-type-header {
        border-bottom: none;
    }
    .resource-items-list {
        padding: 0 0 10px 0; 
        background-color: white; 
        border-bottom: 1px solid #ddd;
    }
    .resource-type-section:last-child .resource-items-list {
        border-bottom: none; 
    }
    .no-resource-message {
        font-size: 12px;
        color: #777;
        padding: 5px 15px;
        font-style: italic;
    }

    /* NEW: Categories Grid Styles (FIXED colors) */
    .categories-grid {
        display: grid;
        grid-template-columns: 1fr 1fr; 
        gap: 30px; 
    }
    .category-panel {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #ddd;
    }
    .category-panel h4 {
        font-size: 18px;
        font-weight: 600;
        margin-top: 0;
        margin-bottom: 20px;
        border-bottom: 2px solid #e53935; 
        padding-bottom: 10px;
    }
    .category-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 14px;
        background-color: white; 
    }
    .category-item:last-of-type {
        border-bottom: none;
    }
    .category-actions button {
        width: auto;
        padding: 5px 10px;
        font-size: 11px;
        font-weight: 500;
        margin-left: 5px;
        border-radius: 3px;
        cursor: pointer;
        border: none;
        color: white; 
    }
    /* FIX: Rename Button - Gray */
    .category-actions .rename-btn {
        background-color: #757575; 
    }
    /* FIX: Remove Button - Red */
    .category-actions .remove-btn {
        background-color: #e53935; 
    }

    /* FIX: Add Form Input/Button Styles */
    .category-add-form {
        display: flex;
        margin-top: 20px;
        padding-top: 10px;
        border-top: 1px solid #eee;
    }
    .category-add-form input[type="text"] {
        flex-grow: 1;
        margin-right: 10px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: auto; 
    }
    .category-add-form .add-category-btn {
        width: 80px;
        padding: 8px 10px;
        font-size: 12px;
        font-weight: bold;
        background-color: #e53935; 
        color: white; 
    }
    /* FIX: Button Group */
    #addResourceButtons {
        display: flex;
        gap: 10px;
    }
    #addResourceButtons .add-resource-btn {
        width: auto;
        padding: 10px 15px;
        font-size: 14px;
    }

    /* NEW RENAME MODAL SPECIFIC STYLES */
    .rename-modal-dialog {
        max-width: 350px;
    }
    .rename-modal-dialog .form-group input[type="text"] {
        width: 100%;
    }
    /* NEW: Reservation Modal Specific UI Fixes */
    .form-modal-body input[type="date"],
    .form-modal-body input[type="time"] {
        width: 100%; 
        margin-bottom: 0;
        height: 40px; 
        font-size: 14px;
    }

    .form-modal-body textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        margin-top: 5px; 
        font-size: 14px;
        color: #333;
    }
    .reservation-card {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        padding: 20px;
        margin-bottom: 20px;
        display: flex; 
        flex-direction: column;
    }

    .reservation-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .reservation-name {
        font-size: 18px;
        font-weight: bold;
        color: #e53935; 
    }
    .reservation-type {
        font-size: 14px;
        color: #777;
        margin-top: 2px;
    }

    .status-tag.cancelled { 
        background-color: #fce4ec; 
        color: #e53935;
        border: 1px solid #f48fb1;
    }

    .status-tag.approved {
        background-color: #e8f5e9; 
        color: #4CAF50; 
        border: 1px solid #a5d6a7;
    }

    .status-tag.pending {
        background-color: #fffde7; 
        color: #ffb300;
        border: 1px solid #ffecb3;
    }

    .reservation-details {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        color: #333;
        padding-bottom: 10px;
    }

    .reservation-details span strong {
        font-weight: 600;
        margin-right: 5px;
        color: #555;
    }

    .cancel-button-reservation {
        background-color: #e53935; 
        color: white; 
        padding: 8px 15px; 
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        margin-top: 10px;
        width: auto; 
        align-self: flex-start;
    }
    /* NEW: Styles for Approval Buttons */
    .approval-action-buttons {
        margin-top: 10px;
        display: flex;
        justify-content: flex-end; 
        gap: 10px;
        padding-top: 15px; 
        border-top: 1px solid #eee;
    }

    .reject-button, .approve-button {
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        width: 100px; 
    }

    .reject-button {
        background-color: #f44336; 
        color: white;
    }
    .reject-button:hover {
        background-color: #d32f2f;
    }

    .approve-button {
        background-color: #4CAF50; 
        color: white;
    }
    .approve-button:hover {
        background-color: #388e3c;
    }

    /* Dagdag sa inyong <style> block: */
    .status-tag.status-in-use { 
        background-color: #ffe5e5; 
        color: #e53935; 
        border: 1px solid #ff9999; 
    }
    /* --- NEW VEHICLE CARD STYLES --- */
    .vehicle-card-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: left;
    }

    .vehicle-image-box {
        width: 100%;
        height: 180px; 
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 15px;
        overflow: hidden;
        background-color: #fff;
    }

    .vehicle-image-box img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain; 
    }

    .vehicle-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        width: 100%;
        margin-bottom: 5px;
    }

    .vehicle-title-group {
        flex: 1;
    }

    .vehicle-name {
        font-size: 18px;
        font-weight: 700; 
        color: #001f3f; 
        margin: 0;
    }

    .vehicle-model {
        font-size: 14px;
        color: #666;
        margin-top: 2px;
    }

    .vehicle-badges {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        justify-content: flex-end;
    }

    /* Badge overrides */
    .v-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 12px;
    }
    .v-avail { background-color: #e8f5e9; color: #2e7d32; }
    .v-approval { background-color: #fff8e1; color: #fbc02d; }

    .vehicle-info-row {
        margin-top: 15px;
        font-size: 14px;
        color: #444;
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    .vehicle-info-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .vehicle-icon {
        width: 20px;
        text-align: center;
        color: #777;
    }

    .booked-by-box {
        background-color: #f5f7f9; 
        border-radius: 5px;
        padding: 12px;
        margin-top: 15px;
        margin-bottom: 15px;
        width: 100%;
        font-size: 13px;
        color: #333;
    }

    .booked-by-label {
        font-weight: 600;
        color: #555;
        margin-bottom: 3px;
        display: block;
    }

    .reserve-btn-full {
        background-color: #d32f2f; 
        color: white;
        width: 100%;
        padding: 12px;
        border-radius: 5px;
        border: none;
        font-weight: bold;
        font-size: 15px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
    }

    .reserve-btn-full:hover { background-color: #b71c1c; }
    .reserve-btn-full:disabled { background-color: #ccc; cursor: not-allowed; }
    /* Add these styles */

    /* Style for the file input to look cleaner */
    .custom-file-input {
        background-color: #f0f4f8; 
        padding: 10px;
        border-radius: 5px;
        border: none;
        width: 100%;
        font-size: 14px;
        color: #555;
    }

    /* Red Button Override for "Add Seat" */
    #submitAddResourceButton {
        background-color: #d32f2f; 
    }
    #submitAddResourceButton:hover {
        background-color: #b71c1c;
    }

    /* Cancel Button - White with Border */
    .cancel-button {
        background-color: white;
        color: #333;
        border: 1px solid #ccc;
    }
    /* --- SHUTTLE / CAR SEAT CARD STYLE (Screenshot Match) --- */
    .shuttle-card-wrapper {
        background-color: white;
        border: 1px solid #eee; 
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 160px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .shuttle-card-wrapper:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }

    .shuttle-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 5px;
    }

    .shuttle-title {
        font-size: 16px;
        font-weight: bold;
        color: #333;
        margin: 0;
    }

    .shuttle-badge {
        background-color: #e3f2fd; 
        color: #1976d2; 
        font-size: 11px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 12px;
        white-space: nowrap;
    }

    .shuttle-subtext-group {
        margin-bottom: 20px;
    }

    .shuttle-route {
        font-size: 12px;
        color: #777;
        margin-bottom: 8px;
        display: block;
    }

    .shuttle-seat-info {
        font-size: 13px;
        color: #555;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .view-seats-btn {
        background-color: #d32f2f; 
        color: white;
        width: 100%;
        padding: 10px 0;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .view-seats-btn:hover {
        background-color: #b71c1c; 
    }
    /* --- NEW SEAT MAP STYLES (Based on Image) --- */
    .van-layout {
        position: relative;
        width: 320px; 
        height: 240px; 
        background-color: #fcfcfc; 
        border: 1px solid #ddd;
        border-radius: 10px;
        margin: 0 auto;
    }

    .seat {
        position: absolute;
        width: 40px;
        height: 40px;
        border-radius: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .seat.available {
        background-color: #e8f5e9; 
        color: #4CAF50; 
        border-color: #4CAF50; 
    }

    .seat.available:hover {
        background-color: #c8e6c9;
    }

    .seat.selected {
        background-color: #e53935; 
        color: white;
        border-color: #e53935;
        transform: scale(1.05);
    }

    .seat.booked {
        background-color: #cfd8dc; 
        color: #78909c; 
        border-color: #78909c;
        cursor: not-allowed;
        text-decoration: none; 
    }

    .seat.driver {
        background-color: #424242; 
        color: white;
        border-color: #424242;
        cursor: default;
        font-size: 12px;
    }

    /* Positioning the seats (Based on the van layout in your screenshot) */
    /* Rows sa Kanan (Driver Side) */
    .seat-D { top: 30px; right: 20px; }
    .seat-1 { top: 180px; right: 20px; } 
    .seat-2 { top: 30px; right: 100px; }
    .seat-3 { top: 80px; right: 100px; }
    .seat-4 { top: 130px; right: 100px; }

    /* Rows sa Gitna at Kaliwa (Passenger Side) */
    .seat-5 { top: 30px; left: 100px; }
    .seat-6 { top: 80px; left: 100px; }
    .seat-7 { top: 130px; left: 100px; }

    /* Rows sa Likod Kaliwa */
    .seat-8 { top: 30px; left: 20px; }
    .seat-9 { top: 80px; left: 20px; }
    .seat-10 { top: 130px; left: 20px; }
    .seat-11 { top: 180px; left: 20px; }

    /* --- NEW SEAT EDITOR STYLES --- (Gaya mula sa iyong huling instruction)*/
    .seat-editor {
        position: absolute; 
        width: 35px; 
        height: 35px;
        border-radius: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 13px;
        font-weight: bold;
        cursor: grab; 
        background-color: #1e88e5; 
        color: white;
        border: 2px solid #0d47a1;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 10; 
        user-select: none; 
    }

    .seat-editor:active {
        cursor: grabbing;
        z-index: 20; 
    }

    .seat-editor.selected-for-removal {
        outline: 3px dashed #e53935; 
        opacity: 0.8;
    }

    /* NEW: Reservation List Item Style (Admin View) */
    .reservation-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
        background-color: white;
    }
    .reservation-list-item:last-child {
        border-bottom: none;
    }
    /* I-ensure na may space sa pagitan ng columns */
    .reservation-list-item span {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        padding: 0 5px; 
    }
    .reservation-list-item .resource-col { width: 25%; font-weight: 500; }
    .reservation-list-item .user-col { width: 25%; color: #777; }
    .reservation-list-item .time-col { width: 30%; font-size: 13px; }
    .reservation-list-item .status-col { width: 10%; text-align: center; }
    .reservation-list-item .actions-col { width: 10%; text-align: center; }

    .reservation-list-item .cancel-admin-btn {
        background-color: #e53935; 
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        width: 70px;
    }
    .reservation-list-item .cancel-admin-btn:hover { background-color: #c62828; }
    /* NEW: Status Tag Styles for Admin View (Para ma-iba sa My Reservations) */
    .status-tag.admin-approved { background-color: #e8f5e9; color: #4CAF50; border: 1px solid #a5d6a7; }
    .status-tag.admin-pending { background-color: #fffde7; color: #ffb300; border: 1px solid #ffecb3; }
    .status-tag.admin-cancelled,
    .status-tag.admin-rejected { background-color: #fce4ec; color: #e53935; border: 1px solid #f48fb1; }

    /* NEW: Floor Plan List Item (Users Card Style Re-use) */
    .floor-plan-item {
        background-color: white;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #eee;
    }
    .floor-plan-item:first-of-type {
        border-top: none;
    }
    .floor-plan-details {
        display: flex;
        align-items: center;
        flex-grow: 1;
        gap: 15px;
    }
    .floor-plan-thumbnail {
        width: 60px;
        height: 40px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 3px;
        overflow: hidden;
        flex-shrink: 0; 
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px; 
        color: #bbb;
        background-size: cover; 
        background-position: center;
    }
    .plan-text h4 {
        font-size: 14px;
        font-weight: 500;
        color: #e53935;
        margin: 0;
    }
    .plan-text p {
        font-size: 12px;
        color: #777;
        margin: 2px 0 0 0;
    }
    .floor-plan-actions button {
        width: auto;
        padding: 5px 10px;
        font-size: 12px;
        font-weight: 500;
        margin-left: 10px;
        border-radius: 3px;
        cursor: pointer;
        border: 1px solid #ddd;
        color: #333; 
        background-color: #f0f0f0;
    }
    .floor-plan-actions .upload-new-btn {
        background-color: #e53935; 
        color: white;
        border: none;
    }
    /* --- FLOOR PLAN EDITOR STYLES --- */
    .fp-editor-container {
        flex-grow: 1;              
        width: 100%;
        background-color: #333;    
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;          
        border-radius: 4px;
        padding: 10px;             
        box-sizing: border-box;
        min-height: 400px;
    }

    /* Ang Wrapper ng Image (Dito nakadikit ang Green Dots) */
        #fpImageWrapper {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            display: flex; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
        }

        /* Ang Image Mismo */
        #fpEditorImageElement {
            display: block;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
        }

    .fp-background-image {
        width: 100%;
        height: 100%;
        background-size: contain; 
        background-repeat: no-repeat;
        background-position: center;
        pointer-events: none; 
    }

    /* Ang Marker (Green Dot + Label) */
    /* Markers inside Editor */
    .fp-marker {
        position: absolute; 
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: grab;
        z-index: 100; 
        width: 100px; 
        transform: translate(-50%, -50%); 
    }

    .fp-marker:active {
        cursor: grabbing;
        z-index: 200;
    }

    /* Green Circle */
    .fp-dot {
        width: 20px;
        height: 20px;
        background-color: #2ecc71; 
        border: 2px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        margin-bottom: 4px;
    }

    /* Resource Name Label */
    .fp-label {
        background-color: rgba(255, 255, 255, 0.9);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        color: #333;
        text-align: center;
        white-space: nowrap;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        pointer-events: none; 
    }
    /* Special Style para lang sa Floor Plan Editor Modal */
        #floorPlanEditorModal .form-modal-dialog {
            max-width: 90vw !important;  
            max-height: 90vh !important; 
            width: 1000px; 
        }

        #floorPlanEditorModal .form-modal-body {
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            padding: 15px;
        }

    /* --- SEAT TOOLTIP STYLES --- */
    .seat {
        position: relative; 
    }

    /* Ang Tooltip Box */
    .seat-tooltip {
        visibility: hidden;
        width: 120px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 100;
        bottom: 125%; 
        left: 50%;
        margin-left: -60px; 
        font-size: 11px;
        font-weight: normal;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Arrow sa ilalim ng tooltip */
    .seat-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }

    /* Ipakita kapag tinutok (hover) sa booked seat */
    .seat.booked:hover .seat-tooltip {
        visibility: visible;
        opacity: 1;
    }

    /* I-enable ang mouse events sa booked seats para gumana ang hover */
    .seat.booked {
        pointer-events: auto !important; 
        cursor: not-allowed; 
    }
    /* --- DYNAMIC CARD BACKGROUNDS --- */

    /* Border: Gray-200 (Light Gray) sa lahat ng cards */
    .resource-card-user, 
    .shuttle-card-wrapper {
        border: 1px solid #e5e7eb !important; 
        transition: background-color 0.3s ease, transform 0.2s;
    }

    /* Available: Green-50 (Very Light Green) - For Rooms/Desks/Seats */
    .bg-available {
        background-color: #f0fdf4 !important; 
    }

    /* In Use / Full: Red-50 (Very Light Red) - For All Types */
    .bg-in-use {
        background-color: #fef2f2 !important; 
    }

    /* Neutral: White - For Available Vehicles */
    .bg-neutral {
        background-color: #ffffff !important; 
    }

    .resource-card-user:hover,
    .shuttle-card-wrapper:hover {
        transform: translateY(-5px);
    }
    /* -------------------- PROFESSIONAL MOBILE STYLES -------------------- */

    /* Default: Hide Burger & Mobile Icon on Desktop */
    .hamburger-btn { display: none; background: none; border: none; cursor: pointer; padding: 0; }
    .mobile-user-icon { display: none; }
    .desktop-text { display: inline; }

    /* TABLET & MOBILE VIEW (Max-width: 768px) */
    @media (max-width: 768px) {
        
        /* 1. Header Layout Fixes */
        .top-header {
            padding: 0 15px; 
            height: 55px; 
            justify-content: space-between; 
        }
        
        .header-logo {
            font-size: 20px; 
        }

        /* 2. Show Burger Icon on Left */
        .hamburger-btn {
            display: block;
            margin-right: 10px; 
            opacity: 0.9;
            transition: opacity 0.2s;
        }
        .hamburger-btn:active { opacity: 0.5; }

        /* 3. User Profile Adjustments (Right Side) */
        .user-dropdown-container {
            font-size: 13px; 
            background-color: rgba(255,255,255,0.1); 
            padding: 5px 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
        }
        
        /* Hide "Welcome" text to save space on very small screens */
        .desktop-text { display: none; } 
        .mobile-user-icon { display: inline-block; margin-left: 5px; font-size: 16px; }
        
        /* 4. PROFESSIONAL SLIDING MENU */
        .nav-tabs {
            display: block; 
            position: fixed; 
            top: 55px; 
            left: 0;
            width: 100%;
            background-color: #ffffff;
            flex-direction: column;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); 
            border-bottom: none;
            padding: 0;
            z-index: 1000;
        }

        /* Class to Open Menu */
        .nav-tabs.mobile-visible {
            max-height: 400px; 
            border-bottom: 4px solid #e53935;
        }

        /* 5. Menu Items Styling */
        .nav-tab {
            width: 100%;
            padding: 16px 20px; 
            font-size: 15px;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
            text-align: left;
            background-color: white;
            box-sizing: border-box; 
        }

        .nav-tab:active {
            background-color: #f9f9f9;
        }

        /* Active State in Menu */
        .nav-tab.active {
            background-color: #fff0f0; 
            color: #e53935;
            font-weight: 700;
            border-left: 4px solid #e53935; 
            border-bottom: 1px solid #f0f0f0;
        }

        /* 6. Fix Layouts */
        .main-box {
            width: 90%;
            padding: 20px;
        }

        .main-content-area {
            flex-direction: column;
            height: auto; 
            overflow: visible;
        }
        
        /* Stack Panels (Resource View) */
        #resourceViewWrapper {
            flex-direction: column !important;
        }

        .left-panel, .right-panel {
            width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            padding: 15px !important;
            overflow: visible !important;
            flex: none !important;
        }
        
        /* Hide floor plan by default on mobile unless toggled (optional) */
        .right-panel { 
            display: none !important; 
            margin-top: 20px;
            height: 300px !important; 
        }
        
        /* Grid fix */
        #itemListArea { grid-template-columns: 1fr !important; gap: 15px; }
        .categories-grid { grid-template-columns: 1fr !important; }
    }

    /* Animation */
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* --- 1. DESKTOP RESET (Ensure Desktop looks correct) --- */
    @media (min-width: 769px) {
        #adminDashboardContainer {
            flex-direction: row !important;
            align-items: stretch !important;
        }
        .admin-sidebar {
            width: 200px !important;
            height: 100% !important;
            flex-direction: column !important;
            position: static !important;
            overflow: visible !important;
            border-bottom: none !important;
            border-right: 1px solid #ddd !important;
            display: block !important; 
            padding: 0 20px !important;
        }
        .admin-sidebar h4 { display: block !important; }
        
        /* Reset Sidebar Items */
        .admin-nav-item {
            width: auto !important;
            border-radius: 4px !important;
            background-color: transparent !important;
            border: none !important;
            margin-bottom: 5px !important;
        }
        .admin-nav-item.active {
            background-color: #ffe5e5 !important;
            color: #e53935 !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Restore Table Headers */
        #reservationsTableHeader { display: flex !important; }

        /* Restore Row Layout for Lists */
        .reservation-list-item {
            flex-direction: row !important;
            align-items: center !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            margin-bottom: 0 !important;
        }
        
        /* Reset Columns */
        .reservation-list-item span { width: auto !important; padding: 0 5px !important; }
        .reservation-list-item .resource-col { width: 25% !important; border: none !important; margin: 0 !important; }
        .reservation-list-item .user-col { width: 25% !important; }
        .reservation-list-item .time-col { width: 30% !important; }
        .reservation-list-item .status-col { width: 10% !important; margin: 0 !important; display: block !important; text-align: center !important; }
        .reservation-list-item .actions-col { width: 10% !important; margin: 0 !important; text-align: center !important; }
        .reservation-list-item .cancel-admin-btn { width: 70px !important; }

        /* Remove Mobile Labels */
        .reservation-list-item .user-col::before,
        .reservation-list-item .time-col::before { content: none !important; }
    }

    /* --- 2. MOBILE ADMIN STYLES (Apply ONLY to Mobile) --- */
    @media (max-width: 768px) {
        
        /* Stack Container Vertically */
        #adminDashboardContainer {
            flex-direction: column !important;
            padding-top: 0 !important;
            background-color: #f7f9fb;
        }

        /* Horizontal Scrollable Menu */
        .admin-sidebar {
            width: 100% !important;
            height: auto !important;
            padding: 10px 15px !important;
            border-right: none !important;
            border-bottom: 1px solid #eee !important;
            background-color: white !important;
            position: sticky !important;
            top: 55px; 
            z-index: 900;
            display: flex !important;
            flex-direction: row !important;
            overflow-x: auto !important;
            gap: 10px;
            white-space: nowrap;
        }
        
        .admin-sidebar h4 { display: none !important; }

        .admin-nav-item {
            flex-shrink: 0;
            margin-bottom: 0 !important;
            padding: 8px 16px !important;
            background-color: #f5f5f5 !important;
            border-radius: 20px !important;
            font-size: 13px;
            border: 1px solid #eee !important;
            width: auto !important; 
        }

        .admin-nav-item.active {
            background-color: #e53935 !important;
            color: white !important;
            border-color: #e53935 !important;
            box-shadow: 0 2px 5px rgba(229, 57, 53, 0.3) !important;
        }

        /* Content Area */
        .admin-content {
            padding: 20px 15px !important;
        }
        
        /* Reservations as Cards */
        #reservationsTableHeader { display: none !important; }

        .reservation-list-item {
            flex-direction: column !important;
            align-items: flex-start !important;
            background: white;
            margin-bottom: 15px !important;
            border: 1px solid #eee !important;
            border-radius: 8px !important;
            padding: 15px !important;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03) !important;
        }

        .reservation-list-item span {
            width: 100% !important;
            padding: 2px 0 !important;
            text-align: left !important;
            white-space: normal;
        }

        .reservation-list-item .resource-col {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            border-bottom: 1px solid #f5f5f5 !important;
            padding-bottom: 8px !important;
            margin-bottom: 8px !important;
        }

        .reservation-list-item .user-col::before { content: "User: "; font-weight: bold; color: #777; }
        .reservation-list-item .time-col::before { content: "Time: "; font-weight: bold; color: #777; }

        .reservation-list-item .status-col {
            margin-top: 10px !important;
            display: flex !important;
            justify-content: flex-start !important;
            text-align: left !important;
        }

        .reservation-list-item .actions-col {
            margin-top: 10px !important;
            width: 100% !important;
        }
        
        .reservation-list-item .cancel-admin-btn {
            width: 100% !important;
            padding: 10px !important;
        }
        
        /* User Management Mobile Tweaks */
        .users-list-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .add-new-user-btn {
            width: 100%;
            margin-top: 10px;
        }
        .user-card {
            flex-direction: column;
            align-items: flex-start;
        }
        .user-card button {
            width: 100%;
            margin-left: 0;
            margin-top: 5px;
        }
        
        /* Resource Buttons Grid */
        #addResourceButtons { flex-wrap: wrap; }
        #addResourceButtons .add-resource-btn { flex: 1 1 45%; text-align: center; }
    }
    
    /* SPECIFIC CENTERING FOR CAR & VEHICLE ONLY */
    /* 1. Fix Spacing between Filter Box and Cards */
  .custom-view-container {
    margin-bottom: 30px !important; 
    width: 100%;
}

    /* 2. Style the Filter Box (White Box) */
    .custom-filters-box {
        padding: 25px !important;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

.left-panel.centered-view-mode {
    margin: 0 auto !important;       
    max-width: 1000px !important;    
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;  
    
    /* KRITIKAL: TANGGALIN ANG MGA ITO - Hayaan ang browser ang mag-scroll */
    overflow-y: visible !important; /* Dapat visible para ang body scrollbar ang gumana */
    padding-bottom: 0px !important; /* TANGGALIN ANG EXTRA PADDING */
}

    /* Ensure children inside centered mode fit well */
    .left-panel.centered-view-mode > div {
        width: 100% !important;
    }

    /* Grid Adjustment for Centered Mode */
    .left-panel.centered-view-mode #itemListArea {
        justify-content: center !important; 
    }

    /* --- Existing Card Spacing Fix (Keep this) --- */
    .resource-card-user,
    .shuttle-card-wrapper {
        padding: 20px 25px !important;
    }
    
    /* --- SSO BUTTON STYLES (Screenshot Match) --- */
    .separator-container {
      display: flex;
      align-items: center;
      text-align: center;
      margin: 20px 0;
    }

    .separator-line {
      flex-grow: 1;
      border-bottom: 1px solid #ccc;
    }

    .separator-text {
      margin: 0 10px;
      color: #666;
      font-size: 14px;
      font-weight: 500;
    }

    .sso-button {
      background-color: white;
      color: #333;
      border: 1px solid #ccc;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .sso-button:hover {
      background-color: #f8f9fa;
      border-color: #999;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .sso-button:active {
      background-color: #eee;
    }
    
    /* PROFESSIONAL FORM STYLES (PRO-UI) */
    /* 1. Layout Helpers */
    .pro-form-row {
        display: flex;
        gap: 15px; 
        margin-bottom: 15px;
    }

    .pro-form-col {
        flex: 1; 
        display: flex;
        flex-direction: column;
    }

    /* 2. Modern Input Fields */
    .pro-input, 
    .pro-select, 
    .pro-textarea {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        color: #333;
        background-color: #fff;
        border: 1px solid #dfe1e5; 
        border-radius: 6px; 
        transition: all 0.2s ease-in-out;
        box-sizing: border-box;
    }

    .pro-input:focus, 
    .pro-select:focus, 
    .pro-textarea:focus {
        border-color: #e53935; 
        box-shadow: 0 0 0 3px rgba(229, 57, 53, 0.1); 
        outline: none;
    }

    /* 3. Professional Labels */
    .pro-label {
        font-size: 12px;
        font-weight: 600;
        color: #5f6368; 
        margin-bottom: 6px;
        text-transform: uppercase; 
        letter-spacing: 0.5px;
    }

    /* 4. Styled Checkbox Group */
    .pro-checkbox-group {
        display: flex;
        gap: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 6px;
        border: 1px dashed #ccc;
    }

    .pro-checkbox-label {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: #333;
        cursor: pointer;
        font-weight: 500;
    }

    .pro-checkbox-label input {
        margin-right: 8px;
        accent-color: #e53935; 
        width: 16px;
        height: 16px;
    }

    /* 5. Modern File Input */
    .pro-file-wrapper {
        position: relative;
        width: 100%;
    }
    /* FIX: Better File Input Alignment */
    .file-input-row {
        display: flex;
        align-items: center; 
        gap: 10px;
        width: 100%;
    }

    .pro-file-input {
        flex-grow: 1;
        border: 1px solid #ccc; 
        padding: 8px; 
        height: 42px; 
        box-sizing: border-box;
        background-color: #fff;
    }
    .pro-file-input:hover {
        background-color: #f0f0f0;
        border-color: #e53935;
    }

    /* 6. Modal Footer Tweaks */
    .form-modal-footer {
        background-color: #f8f9fa; 
        border-top: 1px solid #eee;
        padding: 15px 25px;
    }

    /* 7. Helper text */
    .pro-hint {
        font-size: 11px;
        color: #888;
        margin-top: 4px;
        font-style: italic;
    }
    /* FIX: Seat Configuration Box */
    #resourceSeatDetailsGroup {
        padding: 20px !important; 
        border: 1px dashed #ccc;
        background-color: #fcfcfc; 
    }

    /* FIX: Restrictions Alignment */
    .access-restrictions-row {
        display: flex;
        align-items: center; 
        gap: 15px;
        height: 40px; 
    }

    .access-label {
        font-size: 12px;
        font-weight: 700;
        color: #555;
        text-transform: uppercase;
        margin-right: 5px;
    }

    /* FIX: Customize Map Button */
    .customize-map-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        height: 45px;
        font-size: 14px;
        font-weight: 600;
    }
    /* FIX: Wider Edit Layout Modal */
    #editLayoutModal .form-modal-dialog {
        max-width: 650px !important; 
        width: 95%; 
    }

    /* FIX: Seat Editor Container */
    #seatLayoutEditor {
        width: 100% !important; 
        max-width: 500px; 
        height: 400px !important; 
        margin: 0 auto 20px auto; 
        background-color: #fcfcfc;
        border: 2px dashed #ccc;
        position: relative;
        overflow: hidden; 
        box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        border-radius: 8px;
    }

    /* FIX: Seat Editor Buttons Layout */
    .seat-editor-actions {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px; 
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
        width: 100%;
    }

    /* Button Style Fix */
    .seat-editor-actions button {
        flex: 1; 
        max-width: 140px; 
        min-width: 100px; 
        height: auto; 
        padding: 10px 5px; 
        font-size: 13px;
        line-height: 1.2; 
        white-space: normal; 
        display: flex;
        flex-direction: column; 
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    /* Specific Button Colors */
    #addSeatButton { background-color: #d32f2f; color: white; border: none; }
    #addSeatButton:hover { background-color: #b71c1c; }

    #removeSelectedButton { background-color: white; color: #333; border: 1px solid #ccc; }
    #removeSelectedButton:hover { background-color: #f5f5f5; }

    #saveLayoutButton { background-color: #d32f2f; color: white; border: none; }
    #saveLayoutButton:hover { background-color: #b71c1c; }

    /* FIX: Scrollable Modal Structure */
    .form-modal-dialog {
        display: flex !important;           
        flex-direction: column !important;  
        
        /* KRITIKAL: Palakihin ang max height para mas malaki ang espasyo sa screen */
        max-height: 95vh !important;        
        width: 100%;
        
        /* Palakihin din ang max width para hindi masikip ang content sa loob */
        max-width: 550px;                   
        
        margin: 0 auto;                     
        position: relative;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    /* Header: Bawal lumiit */
.form-modal-header {
    flex-shrink: 0; 
    border-bottom: 1px solid #eee;
}

/* Body: Ito ang magkakaroon ng SCROLLBAR */
.form-modal-body {
    overflow-y: auto !important;  
    flex-grow: 1;                 
    padding: 20px;                
    
    /* KRITIKAL: Siguraduhin na ang BODY ay may maximum height */
    max-height: none !important; /* Hayaan itong lumaki hanggang sa ma-fill ang dialog */
}

/* Footer: Bawal lumiit at laging nasa baba */
.form-modal-footer {
    flex-shrink: 0; 
    border-top: 1px solid #eee;
    background-color: #fff;       
    z-index: 10;                  
}
    /* --- NEW: HELP CENTER FAQ STYLES --- */
    .faq-item {
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-bottom: 15px;
        background-color: white;
        overflow: hidden; 
    }

    .faq-header {
        padding: 15px 20px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f9f9f9;
        transition: background-color 0.2s;
    }

    .faq-header:hover {
        background-color: #f0f0f0;
    }

    .faq-icon {
        width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        color: #e53935;
        transition: transform 0.3s ease;
    }

    /* Default icon is + */
    .faq-icon::before {
        content: '+';
    }

    .faq-item.active .faq-header {
        background-color: #e53935; 
        color: white;
        border-bottom: 1px solid #c62828;
    }

    /* Icon change to - when active */
    .faq-item.active .faq-icon {
        transform: rotate(180deg);
        color: white; 
    }
    .faq-item.active .faq-icon::before {
        content: '-';
    }

    /* --- UPDATED FAQ CONTENT STYLES --- */
    .faq-content {
        max-height: 0; 
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        background-color: white; 
    }

    /* Inner container: Dito ilalagay ang padding, at ito ang titingnan ng scrollHeight */
    .faq-content > * {
        padding: 15px 20px; 
        padding-top: 0; 
        padding-bottom: 0;
        margin: 0;
    }

    /* I-override ang padding/margin ng listahan para maging malinis */
    .faq-content ul, .faq-content ol {
        padding: 0 20px 15px 40px; 
        margin-top: 5px;
    }

    /* Paragraph: Para magkaroon ng tamang space sa taas at baba */
    .faq-content p {
        padding: 15px 20px 0 20px;
        margin: 0;
    }

    /* Tiyakin na ang huling item sa content ay may bottom padding */
    .faq-content.active > *:last-child {
        padding-bottom: 20px; 
    }
    
    #seatSelectionModal .form-modal-dialog {
        max-width: 600px !important; 
        width: 95%; 
        padding: 0;
    }
    
    /* Style for Calendar View (Simple List for now) */
    .calendar-event-list {
        max-height: 250px; 
        overflow-y: auto;
        padding-right: 10px; 
    }
    .calendar-event {
        border-bottom: 1px solid #eee;
        padding: 8px 0;
        font-size: 13px;
        display: flex;
        justify-content: space-between;
    }
    .calendar-event:last-child { border-bottom: none; }
    .event-name { font-weight: bold; color: #333; }
    .event-time { color: #e53935; font-weight: 600; font-size: 12px; }
    .event-details { color: #777; font-size: 12px; margin-left: 10px; }

    /* --- ADMIN FILTERS & SORTING --- */
    .admin-filter-bar {
        display: flex;
        gap: 15px;
        padding: 15px;
        background-color: white;
        border: 1px solid #ddd;
        border-bottom: none; 
        border-radius: 5px 5px 0 0;
        align-items: center;
        flex-wrap: wrap;
    }

    .admin-filter-bar input, 
    .admin-filter-bar select {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 13px;
    }

    .admin-filter-bar input[type="text"] {
        flex-grow: 1; 
        min-width: 200px;
    }

    .clear-filter-btn {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        color: #333;
        cursor: pointer;
        font-weight: 600;
    }
    .clear-filter-btn:hover { background-color: #e0e0e0; }

    /* Sortable Headers */
    .sortable-header {
        cursor: pointer;
        user-select: none;
        position: relative;
        transition: background-color 0.2s;
    }
    .sortable-header:hover {
        background-color: #e0e0e0;
    }
    .sortable-header::after {
        content: ''; 
        font-size: 10px;
        margin-left: 5px;
        color: #999;
    }
    .sortable-header.asc::after { content: ''; color: #333; }
    .sortable-header.desc::after { content: ''; color: #333; }

    /* --- NEW FULL CALENDAR MOCK-UP STYLES --- */
    .full-calendar-mock {
        border: 1px solid #ddd;
        border-radius: 5px;
        overflow: hidden;
        background-color: white;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .calendar-header-mock {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }

    .nav-arrow-mock {
        cursor: pointer;
        font-size: 20px;
        padding: 5px 10px;
        color: #777;
        user-select: none;
    }
    .nav-arrow-mock:hover {
        color: #e53935;
    }

    .calendar-grid-mock {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        border-top: 1px solid #ddd;
    }

    .day-header-mock {
        text-align: center;
        padding: 10px 0;
        font-size: 13px;
        font-weight: 600;
        color: #777;
        border-bottom: 1px solid #eee;
    }

    .day-cell-mock {
        min-height: 100px;
        border-right: 1px solid #eee;
        border-bottom: 1px solid #eee;
        padding: 5px;
        font-size: 14px;
        vertical-align: top;
        position: relative;
        cursor: pointer;
    }

    .day-cell-mock:nth-child(7n) { /* Last column (Sunday) */
        border-right: none;
    }
    
    .day-cell-mock.other-month {
        background-color: #fcfcfc;
        color: #bbb;
    }

    .day-number-mock {
        display: block;
        font-weight: bold;
        text-align: right;
        margin-bottom: 5px;
        color: #333;
    }

    .day-cell-mock.other-month .day-number-mock {
        color: #bbb;
    }
    
    .event-indicator-mock {
        font-size: 11px;
        padding: 2px 4px;
        margin-top: 2px;
        margin-bottom: 2px;
        border-radius: 3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        background-color: #d1e7ff; /* Blue background */
        color: #0056b3;
    }
    
    /* Current Date Style */
    .day-cell-mock.today-mock {
        background-color: #fffde7; /* Light yellow background */
        border: 2px solid #ffcc00;
        padding: 3px; /* Adjusted padding due to border */
    }
    /* I-ADD o I-UPDATE ito sa inyong <style> block, sa bandang Modal Styles */

/* Para lang sa Confirm Action Modal Footer (Flex Container) */
#confirmActionModal .modal-footer {
    display: flex;
    justify-content: flex-end; /* I-align sa kanan */
    gap: 10px;
    padding: 15px 20px;
}

/* Gawing pantay ang lapad ng buttons at alisin ang extra styles */
#confirmActionModal .modal-footer button {
    /* Fixed Width: Para pantay sa 100px */
    width: 100px !important; 
    /* Fixed Height/Padding: Para consistent ang size */
    padding: 8px 10px !important; 
    height: auto !important;
    
    /* Font style para consistent */
    font-size: 14px !important;
    font-weight: bold !important;
}

/* I-restore ang style ng Cancel button (sa ibang modals, nakikita na malaki ito) */
#confirmActionModal .modal-footer .cancel-button {
    background-color: white !important;
    color: #333 !important;
    border: 1px solid #ccc !important;
}
/* I-ADD ang rule na ito sa huling bahagi ng inyong <style> block */

/* Final Fix: Green Hover para sa executeActionButton (Approve) */
#confirmActionModal .modal-footer #executeActionButton {
    /* Ang background-color ay na-set sa JS. Pilitin natin ang hover effect. */
    transition: background-color 0.2s, border-color 0.2s; /* Para may animation */
}

#confirmActionModal .modal-footer #executeActionButton:hover {
    /* Ito ang dapat mag-override sa lahat ng Red rules */
    background-color: #388e3c !important; /* DARK GREEN */
    border-color: #388e3c !important;
}

/* Para sa Rejected button (para maging consistent din ang hover) */
#confirmActionModal .modal-footer #executeActionButton[style*="#e53935"]:hover {
    background-color: #c62828 !important; /* DARK RED */
    border-color: #c62828 !important;
}

/* Tiyakin na ang Cancel button hover ay white/light red */
#confirmActionModal .modal-footer .cancel-button:hover {
    background-color: #fff0f0 !important; 
    color: #e53935 !important;
    border-color: #e53935 !important;
}
/* NEW: SCROLL LOCK FOR MODALS */
.modal-open {
    overflow: hidden !important; /* Itago ang scrollbar ng body */
    touch-action: none;          /* I-disable ang touch scrolling sa mobile */
}
</style>
</head>
<body>

<!-- -------------------- LOGIN VIEW -------------------- -->
<div class="main-box" id="loginView">
  <div class="logo">A.Space</div>
  <h2>Sign in to your account</h2>
  <div class="demo-text">
  </div>
  <form id="loginForm">
    <label for="email">Email address</label>
    <input type="text" id="email" name="email" placeholder="e.g., admin.superuser@example.com" required>

<label for="password">Password</label>
<input type="password" id="password" name="password" placeholder="Password" required>
<div style="text-align: right; margin-bottom: 20px;">
    <!-- Pinalitan ang href="#" ng "javascript:void(0)" para bawal mag-reload -->
    <a href="javascript:void(0)" id="forgotPasswordLink" style="color: #e53935; text-decoration: none; font-size: 13px; font-weight: 600; cursor: pointer;">Forgot Password?</a>
</div>

<!-- Error Message Box -->
<div id="loginErrorMessage" class="error-message">
    Invalid email or password. Please try again.
</div>

<button type="submit">Sign In</button>
  </form>
  <!-- IDAGDAG ITO SA ILALIM NG FORM PERO NASA LOOB PA RIN NG "main-box" -->

<div class="separator-container">
  <div class="separator-line"></div>
  <div class="separator-text">OR</div>
  <div class="separator-line"></div>
</div>

<button type="button" class="sso-button" id="ssoLoginBtn">
  Sign in with SSO
</button>
</div>
<!-- -------------------- DASHBOARD VIEW -------------------- -->
<div id="dashboardView">
<!-- Top Header Bar (Professional Mobile Layout) -->
<div class="top-header">
    
    <!-- LEFT SIDE: Burger Icon + Logo -->
    <div style="display: flex; align-items: center; gap: 15px;">
        
        <!-- Burger Icon (Visible only on Mobile) -->
        <button id="mobileMenuBtn" class="hamburger-btn">
            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>

        <!-- Logo -->
        <div class="header-logo">A.Space</div>
    </div>
    
    <!-- RIGHT SIDE: User Profile -->
    <div class="user-dropdown-container" id="userDropdownToggle">
        <!-- Sa mobile, pwedeng icon o short text lang para di masikip -->
        <span class="desktop-text">Welcome, </span><span id="userNameRole" class="user-name-text">User</span> <span class="desktop-text"></span>
        
        <!-- Mobile User Icon (Optional Fallback) -->
        <span class="mobile-user-icon"></span>

        <!-- Dropdown Menu -->
        <div class="user-dropdown-menu" id="userDropdownMenu">
            <div class="dropdown-item header">
                <span id="dropdownUserName"></span> 
                <small id="dropdownUserBU" style="display: block; font-weight: normal; color: #777;"></small>
            </div>
            <div class="dropdown-item" data-item="profile" id="myProfileLink">My Profile</div>
            <div class="dropdown-item" data-item="admin-dashboard" id="adminDashboardLink">Admin Dashboard</div>
            <div class="dropdown-item" data-item="help" id="helpLink">Help</div>
            <div class="dropdown-item" id="logoutLink">Logout</div>
        </div>
    </div>

</div>

<!-- Navigation Tabs -->
<div class="nav-tabs" id="navTabs">
    <div class="nav-tab" data-item="room">Reserve a Room</div>
    <div class="nav-tab" data-item="desk">Reserve a Desk</div>
    <div class="nav-tab" data-item="car">Reserve a Car Seat</div>
    <div class="nav-tab" data-item="vehicle">Reserve a Vehicle</div>
    <div class="nav-tab" data-item="my-reservations">My Reservations</div>
    <div class="nav-tab" data-item="approvals" id="approvalsTab">Approvals</div>
</div>

<!-- Main Content Area -->
<div class="main-content-area" id="mainContentArea">
    
    <!-- 1. USER RESOURCE VIEW (For Room, Desk, Car, etc.) -->
    <div id="resourceViewWrapper" style="display: none; width: 100%; display: flex; gap: 20px; align-items: flex-start;">
        
        <div class="left-panel" id="leftPanel" style="flex: 1;">
            
    <!-- 1. GENERAL Filters (Room/Desk) - FINAL FIXED SIZE AND ALIGNMENT -->
    <!-- Display: none ay hahawakan ng JS, ang .filter-group-general ang may hawak ng display: flex; -->
    <div class="filter-group-general" id="generalFilters" style="display: none;"> 
        
        <!-- FILTER 1: Location - Fixed Width (150px) -->
        <div style="width: 150px; flex-shrink: 0;"> 
            <label for="locationFilter" style="margin-bottom: 5px;">Location</label> 
            <select id="locationFilter" style="width: 100%;"> <option>All Locations</option> </select> 
        </div>
        
        <!-- FILTER 2: Category - Fixed Width (150px) -->
        <div style="width: 150px; flex-shrink: 0;"> 
            <label for="categoryFilter" style="margin-bottom: 5px;">Category</label> 
            <select id="categoryFilter" style="width: 100%;"> <option>All Categories</option> </select> 
        </div>
        
   <div style="flex-shrink: 0; display: flex; align-items: flex-end; margin-left: auto;">
            <button id="calendarToggleButton" style="display: none; width: 100%; min-width: 150px;">
                <!-- Dito na ilalagay ang icon at text (na hindi na kailangan ng line-break) -->
                <span> Show Calendar</span>
            </button>
        </div>
    </div>

           <!-- 2. CAR SEAT VIEW -->
    <div id="carSeatView" class="custom-view-container" style="display: none;">
        <div class="custom-view-header"> <h3>Reserve a Car Seat</h3> <p>Reserve a seat in a company shuttle or carpool vehicle.</p> </div>
        <div class="custom-filters-box">
            <!-- ADDED ID: carRouteFilter -->
            <div> <label>Route/Service</label> <select id="carRouteFilter"> <option>All Services</option> </select> </div>
            <!-- ADDED ID: carLocationFilter -->
            <div> <label>Pickup Location</label> <select id="carLocationFilter"> <option>All Locations</option> </select> </div>
            <div> <label>Date</label> <input type="date"> </div>
        </div>
    </div>

<!-- NEW HTML FOR VEHICLE REQUEST FORM (Palitan ang laman ng vehicleView) -->
<div id="vehicleView" class="custom-view-container" style="display: none; max-width: 550px; margin: 0 auto;">
    <div class="custom-view-header"> 
        <h3 style="font-size: 24px;">Vehicle Request Form</h3> 
        <p>Submit a request for a company vehicle for your official business trip.</p> 
    </div>

    <!-- NEW FORM: Gagamit tayo ng bagong form ID para sa Vehicle Request -->
    <form id="vehicleRequestForm" class="custom-filters-box" style="flex-direction: column; align-items: stretch; gap: 20px;">
        
        <!-- ROW 1: DATE & TIME -->
        <div class="pro-form-row">
            <div class="pro-form-col">
                <label class="pro-label" for="reqDate">Date Needed</label>
                <input type="date" id="reqDate" name="date" class="pro-input" required>
            </div>
            <div class="pro-form-col">
                <label class="pro-label" for="reqTime">Time Needed</label>
                <input type="time" id="reqTime" name="startTime" class="pro-input" value="08:00" required>
            </div>
        </div>

        <!-- ROW 2: DURATION & PASSENGERS -->
        <div class="pro-form-row">
            <div class="pro-form-col">
                <label class="pro-label" for="reqReturnTime">Expected Return Time</label>
                <input type="time" id="reqReturnTime" name="endTime" class="pro-input" value="17:00" required>
            </div>
            <div class="pro-form-col">
                <label class="pro-label" for="reqPax">No. of Passengers (including requester)</label>
                <input type="number" id="reqPax" name="participants" class="pro-input" min="1" value="1" required>
            </div>
        </div>

        <!-- ROW 3: DESTINATION & PURPOSE -->
        <div class="pro-form-row">
            <div class="pro-form-col">
                <label class="pro-label" for="reqDestination">Destination / Route</label>
                <input type="text" id="reqDestination" name="destination" class="pro-input" placeholder="e.g., Makati Office to Taguig Site" required>
            </div>
        </div>

        <div class="pro-form-row">
             <div class="pro-form-col">
                <label class="pro-label" for="reqPurpose">Purpose of Trip</label>
                <textarea id="reqPurpose" name="notes" class="pro-textarea" rows="3" placeholder="Briefly describe the purpose..." required></textarea>
            </div>
        </div>
        
        <p class="pro-hint" style="text-align: center; margin-top: 5px;">Note: This request will be sent to an Approver/Admin for assignment and confirmation.</p>

        <button type="submit" id="submitVehicleRequestButton" style="margin-top: 10px;">Submit Vehicle Request</button>
        
        <!-- Hidden fields for reservation logic -->
        <input type="hidden" id="reqResourceName" name="resourceName" value="Vehicle Request">
        <input type="hidden" id="reqRequesterEmail" name="requesterEmail">
        <input type="hidden" id="reqResourceType" name="resourceType" value="vehicle">

    </form>
</div>

<!-- NEW: Calendar Display Container (Ito ang lalabas/magtatago) -->
<div id="availabilityCalendarDisplay" style="display: none; margin-bottom: 20px; width: 100%;">
    <!-- Ginawa nating mas simplified ang container, at ang 'Calendar Availability' title ay ililipat sa loob ng grid -->
    <div id="availabilityCalendarView" style="padding: 0;">
        <p style="text-align: center; color: #777;">Loading calendar...</p>
    </div>
</div>

<!-- NEW: MOCK CALENDAR MODAL (for viewing a specific day's events) -->
<div class="modal-overlay" id="dayEventsModal">
    <div class="modal-dialog" style="max-width: 450px;">
        <div class="modal-header removal-modal-header">
            <span class="modal-title" id="dayEventsTitle">Reservations for [Date]</span>
            <span class="modal-close" onclick="document.getElementById('dayEventsModal').style.display='none';">&times;</span>
        </div>
        
        <div class="modal-body" style="padding: 20px; max-height: 400px; overflow-y: auto;">
            <div id="dayEventsList">
                <p style="color: #777; text-align: center;">No reservations for this day.</p>
            </div>
        </div>
    </div>
</div>

            <!-- Item List Area (Main display for Resource Cards) -->
            <div class="item-list-area" id="itemListArea" style="display: none;">
                <p class="no-items-message" id="noItemsMessage" style="padding-top: 0;"></p>
            </div>
        </div>

        <!-- Right Panel (Interactive Layout) -->
        <div class="right-panel" id="rightPanel" style="display: none;"> 
            <h3 id="layoutTitle"></h3>
            <div class="layout-icon"></div>
            <p></p>
            <p style="font-size: 12px;" id="layoutSubtitle"></p>
        </div>
    </div>
    
    <!-- 2. MY RESERVATIONS / APPROVALS (List-Only View) -->
    <div id="listOnlyView" style="display: none; width: 100%; max-width: 800px; margin: 0 auto;">
        <div class="list-only-header"> <h3 id="listOnlyTitle"></h3> </div>
        <div id="reservationListContainer" class="list-box" style="padding: 20px; box-shadow: none; border: none;">
            <p id="listOnlyMessage-temp" style="text-align: center; color: #777; padding: 0;">Loading...</p> 
        </div>
    </div>
    
    <!-- 3. MY PROFILE VIEW -->
    <div id="profileView" style="display: none; width: 100%; max-width: 500px; margin: 0 auto;">
        <div class="profile-heading">My Profile</div>
        <div class="password-form-box">
            <h4>Change Password</h4>
            <form id="changePasswordForm">
                <label>Current Password</label>
                <input type="password" name="currentPassword" required>
                <label>New Password</label>
                <input type="password" name="newPassword" required>
                <span class="password-hint">Must be at least 6 characters long.</span>
                <label>Confirm New Password</label>
                <input type="password" name="confirmNewPassword" required>
                <button type="submit" class="save-changes-button">Save Changes</button>
                <div style="clear: both;"></div>
            </form>
        </div>
        <div class="demo-notice">
            <strong>!</strong>
            <div>
                <strong>Demo Notice</strong><br>
                Password changes are for demonstration purposes and will not persist after you log out.
            </div>
        </div>
    </div>
    
    <!-- 5. NEW: HELP CENTER VIEW -->
<div id="helpView" style="display: none; width: 100%; max-width: 800px; margin: 0 auto; padding-top: 20px;">
    
    <div style="text-align: center; margin-bottom: 40px;">
        <h1 style="font-size: 32px; font-weight: 500; margin-bottom: 5px;">Help Center</h1>
        <p style="color: #777;">Find answers to frequently asked questions.</p>
    </div>
    
    <!-- FAQ ACCORDION CONTAINER -->
    <div id="faqContainer">
        
        <!-- 1. How do I make a reservation? -->
        <div class="faq-item">
            <div class="faq-header">
                How do I make a reservation?
                <span class="faq-icon"></span>
            </div>
            <div class="faq-content">
                <p>You can reserve a Room, Desk, Car Seat, or Vehicle from their respective pages in the main navigation. The general process is:</p>
                <ol>
                    <li>Navigate to the correct reservation page (e.g., "Reserve a Room").</li>
                    <li>Use the filters at the top to select a Location, Category, and (if applicable) Date. This will show you all available options that match your criteria and are accessible to your Business Unit.</li>
                    <li>Click the "Reserve Now" or "View Seats" button on the card for the resource you want to book.</li>
                    <li>Fill out the reservation form with the required details (date, time, etc.) and submit.</li>
                </ol>
            </div>
        </div>
        
        <!-- 2. What do the different colors on Room/Desk cards mean? -->
        <div class="faq-item">
            <div class="faq-header">
                What do the different colors on Room/Desk cards mean?
                <span class="faq-icon"></span>
            </div>
            <div class="faq-content">
                <ul>
                    <li><span style="color: #2ecc71; font-weight: bold;">Green Background:</span> The resource is currently available.</li>
                    <li><span style="color: #e53935; font-weight: bold;">Red Background:</span> The resource is currently in use. The card will show who has it reserved and until when.</li>
                    <li><span style="color: #e67e22; font-weight: bold;">"Approval Required" Badge:</span> This resource requires a manager's approval to book. Your reservation will be 'Pending' until it is approved or rejected.</li>
                </ul>
            </div>
        </div>

        <!-- 3. How does booking a Car Seat work? -->
        <div class="faq-item">
            <div class="faq-header">
                How does booking a Car Seat work?
                <span class="faq-icon"></span>
            </div>
            <div class="faq-content">
                <p>Booking a car seat is for shared vehicles like shuttles.</p>
                <ol>
                    <li>Select the date for your travel. The cards will show how many seats are available on each shuttle for that day.</li>
                    <li>Click "View Seats" to open an interactive layout of the vehicle.</li>
                    <li>In the layout, click on an available <span style="color: #4CAF50; font-weight: bold;">green</span> seat to select it. Reserved seats are shown in gray. Your selected seat will turn <span style="color: #e53935; font-weight: bold;">red</span>.</li>
                    <li>Fill in the required time and notes, then click "Reserve Seat".</li>
                </ol>
            </div>
        </div>

        <!-- 4. How do I view or cancel my reservations? -->
        <div class="faq-item">
            <div class="faq-header">
                How do I view or cancel my reservations?
                <span class="faq-icon"></span>
            </div>
            <div class="faq-content">
                <p>Navigate to the <strong>"My Reservations"</strong> page. Here you will see a list of all your past, present, and future bookings. For any upcoming reservation that is still in 'Pending' or 'Approved' status, you will see a "Cancel Reservation" button.</p>
            </div>
        </div>

        <!-- 5. What are Roles and Business Units (BU)? -->
        <div class="faq-item">
            <div class="faq-header">
                What are Roles and Business Units (BU)?
                <span class="faq-icon"></span>
            </div>
            <div class="faq-content">
                <p><strong>Roles define what you can do:</strong></p>
                <ul>
                    <li><strong>User:</strong> Can make and manage their own reservations.</li>
                    <li><strong>Approver:</strong> Can approve or reject pending reservation requests from other users. They have access to the "Approvals" page.</li>
                    <li><strong>Admin:</strong> Has full control over the system, including managing users, spaces, and all reservations via the "Admin Dashboard".</li>
                </ul>
                <p><strong>Business Units (BU) define what you can access:</strong></p>
                <ul>
                    <li>Some resources may be restricted to certain BUs (e.g., LLI or ALAND).</li>
                    <li>The system automatically filters what you can see based on your assigned BU.</li>
                </ul>
            </div>
        </div>
        
        <!-- 6. How do I manage my account? -->
        <div class="faq-item">
            <div class="faq-header">
                How do I manage my account?
                <span class="faq-icon"></span>
            </div>
            <div class="faq-content">
                <p>Click on your name in the top-right corner of the header to open the user menu.</p>
                <ul>
                    <li><strong>My Profile:</strong> Allows you to change your password.</li>
                    <li><strong>Notifications:</strong> The bell icon in the header shows you recent updates about your reservations (e.g., confirmed, cancelled). Click it or the menu link to see your notification history.</li>
                    <li><strong>Logout:</strong> Securely logs you out of the application.</li>
                </ul>
            </div>
        </div>

    </div>
    <p style="text-align: center; font-size: 12px; color: #999; margin-top: 30px;">
        This is a demonstration application. Some features are simulated and do not connect to live services like email or calendars.
    </p>
</div>

    <!-- 4. ADMIN DASHBOARD CONTAINER -->
    <div id="adminDashboardContainer" style="display: none; width: 100%; height: 100%; padding-top: 20px;"> <!-- Fixed: removed 'display: flex' to rely on JS or default CSS 'display: none' -->
        <!-- Side Navigation -->
       <div class="admin-sidebar">
    <h4>Admin Tools</h4>
    <div class="admin-nav-item active" data-admin-view="users" id="adminUsersLink">
        <span class="admin-icon"></span><span>Users</span>
    </div>
    <div class="admin-nav-item" data-admin-view="spaces">
        <span class="admin-icon"></span><span>Spaces</span>
    </div>
    <div class="admin-nav-item" data-admin-view="reservations">
        <span class="admin-icon"></span><span>Reservations</span>
    </div>
    <!-- IDAGDAG ITO SA CODE NINYO -->
    <div class="admin-nav-item" data-admin-view="reports">
        <span class="admin-icon"></span><span>Reports</span>
    </div>
    <!-- END OF ADDITION -->
    <div class="admin-nav-item" data-admin-view="import">
        <span class="admin-icon"></span><span>Import Users</span>
    </div>
</div>
        
        <!-- Main Content (UPDATED CONTENT INSIDE) -->
        <div class="admin-content">

            <!-- NEW: Spaces Management View -->
            <div id="adminSpacesView" style="display: none;">
                <h1>Spaces Management</h1>
                
                <!-- Tab Navigation for Spaces Management -->
                <div class="nav-tabs" style="background-color: transparent; padding: 0; margin-bottom: 20px;" id="spacesNavTabs">
                    <div class="nav-tab active" data-space-tab="resources" style="padding: 10px 0; margin-right: 30px;">Resources</div>
                    <div class="nav-tab" data-space-tab="categories" style="padding: 10px 0; margin-right: 30px;">Categories</div>
                    <div class="nav-tab" data-space-tab="floor-plans" style="padding: 10px 0;">Floor Plans</div>
                </div>
                
                <!-- Resources Tab Content -->
                <div id="resourcesTabContent" style="display: block;">
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Manage Resources</h3>
                        <!-- UPDATED (Remove 'Add Vehicle' button) -->
<div id="addResourceButtons">
    <button class="add-resource-btn" style="background-color: #e53935; color: white;">Add Room</button>
    <button class="add-resource-btn" style="background-color: #757575; color: white;">Add Desk</button>
    <button class="add-resource-btn" style="background-color: #757575; color: white;">Add Car Seat</button>
</div>
                    </div>

                    <!-- List Container for ALL Resource Types -->
                    <div class="users-list-container">
                        
                        <!-- Meeting Rooms Section -->
                        <div class="resource-type-section" data-type="room">
                            <div class="resource-type-header" style="border-top: none;">Meeting Rooms</div>
                            <div class="resource-items-list" id="roomList">
                                <div class="no-resource-message">No rooms added yet.</div>
                            </div>
                        </div>
                        
                        <!-- Desks Section -->
                        <div class="resource-type-section" data-type="desk">
                            <div class="resource-type-header">Desks</div>
                            <div class="resource-items-list" id="deskList">
                                <div class="no-resource-message">No desks added yet.</div>
                            </div>
                        </div>
                        
                        <!-- Car Seats (Shuttles) Section -->
                        <div class="resource-type-section" data-type="car">
                            <div class="resource-type-header">Car Seats (Shuttles)</div>
                            <div class="resource-items-list" id="carList">
                                <div class="no-resource-message">No car seats added yet.</div>
                            </div>
                        </div>
                        

                    </div>
                </div>
                
                <!-- Categories Tab Content -->
                <div id="categoriesTabContent" style="display: none;">
                    
                    <p style="color: #777; margin-bottom: 30px;">
                        Add, rename, or remove categories for different types of spaces.
                    </p>
                    
                    <div class="categories-grid">
                        <!-- Meeting Room Categories -->
                        <div class="category-panel">
                            <h4>Meeting Room Categories</h4>
                            <div id="roomCategoryList">
                                <!-- Data will be loaded here -->
                            </div>
                            <div class="category-add-form">
                                <input type="text" placeholder="New category name" data-type="room">
                                <button class="add-category-btn">Add</button>
                            </div>
                        </div>

                        <!-- Desk Categories -->
                        <div class="category-panel">
                            <h4>Desk Categories</h4>
                            <div id="deskCategoryList">
                                <!-- Data will be loaded here -->
                            </div>
                            <div class="category-add-form">
                                <input type="text" placeholder="New category name" data-type="desk">
                                <button class="add-category-btn">Add</button>
                            </div>
                        </div>

                        <!-- Car Seat Categories (UPDATED ID at data-type) -->
                        <div class="category-panel">
                            <h4>Car Seat Categories</h4>
                            <div id="seatCategoryList"> <!-- <--- UPDATED: car -> seat -->
                                <!-- Data will be loaded here -->
                            </div>
                            <div class="category-add-form">
                                <input type="text" placeholder="New category name" data-type="seat"> <!-- <--- UPDATED: car -> seat -->
                                <button class="add-category-btn">Add</button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Sa loob ng <div id="floorPlansTabContent" style="display: none;"></div> -->
<div id="floorPlansTabContent" style="display: none;">
    
    <p style="color: #777; margin-bottom: 30px;">
        Upload a new floor plan image for each category and edit indicator positions.
    </p>
    
    <!-- Room Floor Plans Section -->
    <h3 style="font-size: 20px; font-weight: 600; margin-top: 0; margin-bottom: 15px;">Room Floor Plans</h3>
    <div class="users-list-container" id="roomFloorPlanList">
        <!-- List items will be rendered here -->
    </div>

    <!-- Desk Floor Plans Section -->
    <h3 style="font-size: 20px; font-weight: 600; margin-top: 30px; margin-bottom: 15px;">Desk Floor Plans</h3>
    <div class="users-list-container" id="deskFloorPlanList">
        <!-- List items will be rendered here -->
    </div>
    
    <!-- Note: Hindi kasama ang Car Seat/Vehicle plans base sa screenshot. -->

</div>

<!-- NEW: UPLOAD MODAL (Re-use ang form-modal-dialog style) -->
<div class="modal-overlay" id="floorPlanUploadModal">
    <div class="form-modal-dialog" style="max-width: 450px;">
        <div class="form-modal-header">
            <span class="modal-title" id="uploadModalTitle">Upload Floor Plan for [Category]</span>
            <span class="modal-close" onclick="document.getElementById('floorPlanUploadModal').style.display='none';">&times;</span>
        </div>
        
        <form id="floorPlanUploadForm" enctype="multipart/form-data">
            <input type="hidden" id="uploadPlanType" name="type">
            <input type="hidden" id="uploadPlanCategoryName" name="categoryName">

            <div class="form-modal-body">
                <div class="form-group">
                    <label for="floorPlanPhoto">Floor Plan Image (.png, .jpg)</label>
                    <input type="file" id="floorPlanPhoto" name="floorPlanPhoto" class="custom-file-input" accept="image/*" required>
                </div>
            </div>
        
            <div class="form-modal-footer">
                <button type="button" class="cancel-button" onclick="document.getElementById('floorPlanUploadModal').style.display='none';">Cancel</button>
                <button type="submit" class="add-user-button" style="background-color: #e53935;" id="submitFloorPlanUploadButton">Upload</button>
            </div>
        </form>
    </div>
</div>

            </div>
            <!-- End of Spaces Management View -->
            
           <!-- NEW: Reservations Management View with Filters -->
<div id="adminReservationsView" style="display: none;">
    <h1>Reservations Management</h1>
    
    <!-- 1. FILTER BAR -->
    <div class="admin-filter-bar">
        <!-- Search Text -->
        <input type="text" id="adminSearchInput" placeholder=" Search Resource, User, or Type..." onkeyup="applyAdminFilters()">
        
        <!-- Date Filter -->
        <input type="date" id="adminDateFilter" onchange="applyAdminFilters()">
        
        <!-- Status Filter -->
        <select id="adminStatusFilter" onchange="applyAdminFilters()">
            <option value="All">All Status</option>
            <option value="Pending">Pending Only</option>
            <option value="Approved">Approved Only</option>
            <option value="Rejected">Rejected</option>
            <option value="Cancelled">Cancelled</option>
        </select>

        <!-- Clear Button -->
        <button class="clear-filter-btn" onclick="clearAdminFilters()">Clear Filters</button>
    </div>

    <!-- 2. TABLE/LIST CONTAINER -->
    <div class="list-box" style="padding: 0; border: 1px solid #ddd; border-top: none; border-radius: 0 0 5px 5px; overflow: hidden;">
        
        <!-- HEADER (Clickable for Sorting) -->
<div id="reservationsTableHeader" style="display: flex; justify-content: space-between; padding: 10px 15px; background-color: #f0f0f0; font-size: 12px; font-weight: bold; color: #555; border-bottom: 1px solid #ddd;">
    
    <!-- Gagamitin natin ang data-column para malinis at maiwasan ang error -->
    <span class="sortable-header" style="width: 25%;" data-column="resource">RESOURCE</span>
    <span class="sortable-header" style="width: 25%;" data-column="user">USER</span>
    <span class="sortable-header" style="width: 30%;" data-column="date">DATE & TIME</span>
    <span class="sortable-header" style="width: 10%; text-align: center;" data-column="status">STATUS</span>
    
    <span style="width: 10%; text-align: center;">ACTIONS</span>
</div>
        
        <!-- List Container -->
        <div id="adminReservationsList">
            <p style="text-align: center; color: #777; padding: 20px;">Loading reservations...</p>
        </div>
    </div>
</div>

<!-- NEW: Reports/Analytics View (Objective #5) -->
<div id="adminReportsView" style="display: none;">
    <h1>Utilization Reports</h1>
    <p style="color: #555; margin-bottom: 20px;">
        Space utilization and analytics to evaluate reserved hours per resource.
    </p>
    
    <div class="list-box" style="padding: 0; border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">
        <h3 style="padding: 15px; font-size: 16px; font-weight: 600; margin: 0; background-color: #f7f7f7; border-bottom: 1px solid #ddd;">
            Reserved Hours per Resource
        </h3>
        
        <!-- Report Table Header -->
        <div id="reportsTableHeader" style="display: flex; justify-content: space-between; padding: 10px 15px; background-color: #f0f0f0; font-size: 12px; font-weight: bold; color: #555;">
            <span style="width: 45%;">RESOURCE NAME</span>
            <span style="width: 35%;">DATE</span>
            <span style="width: 20%; text-align: right;">TOTAL HOURS</span>
        </div>
        
        <!-- Report List Container -->
        <div id="adminReportsList">
            <p style="text-align: center; color: #777; padding: 20px;">Click 'Generate Report' to load data.</p>
        </div>
    </div>
    <button id="generateReportButton" style="width: 200px; margin-top: 20px; background-color: #2196F3;">Generate Report</button>
</div>
<!-- END OF ADDITION -->


<!-- NEW: Import Users Management View -->
<div id="adminImportUsersView" style="display: none; padding: 20px; background-color: white; border-radius: 5px; border: 1px solid #ddd;">
    <h1>Import Users</h1>
    
    <p style="color: #555; margin-bottom: 20px;">
        This feature allows bulk user enrollment via local **CSV** file upload.
        <br><strong>Required Columns (in order):</strong> Email, Password, Role, Name, Business Unit
    </p>
    
    <!-- Bagong Form para sa File Upload -->
    <form id="importUsersForm" enctype="multipart/form-data">
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <label for="csvFile" style="font-size: 14px; font-weight: 500; color: #333;">Upload CSV File (.csv)</label>
            
            <!-- Palitan ang ID at Name ng Input Field -->
            <input type="file" id="csvFile" name="csvFile" accept=".csv" class="pro-file-input" required>
            
            <!-- Button na Hindi na Disabled -->
            <button type="submit" id="submitImportButton" style="background-color: #e53935; color: white; padding: 10px 15px; border: none; border-radius: 5px; font-size: 14px; font-weight: bold; width: 250px;">
                Upload & Import CSV
            </button>
        </div>
    </form>
    
    <p style="font-size: 12px; color: #777; margin-top: 5px;">
        Note: The system enforces **@gmail.com** domain restriction and checks for duplicate emails.
    </p>
    
    <!-- Dito lalabas ang Report Summary -->
    <div id="importReportContainer" style="margin-top: 30px; padding: 15px; border-radius: 5px; background-color: #f7f7f7; border: 1px solid #eee; display: none;">
        <h3 style="margin-top: 0; font-size: 16px; font-weight: 600;">Import Summary</h3>
        <p id="importSummaryText" style="margin: 5px 0; font-size: 14px;"></p>
        <div id="importErrorDetails" style="margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; display: none;">
            <p style="color: #e53935; font-weight: bold; font-size: 14px; margin-bottom: 5px;">Skipped / Error Details:</p>
            <ul id="importErrorList" style="list-style-type: disc; margin-left: 20px; font-size: 13px; color: #333;"></ul>
        </div>
    </div>
</div>

            <!-- Users Management View (Dati nang nandoon) -->
            <div id="adminUsersView" style="display: block;"> 
                <h1>Users Management</h1>
                
                <div class="users-list-header">
                    <!-- FIX: Idinagdag ang icon () -->
                    <div>
                        <span class="admin-icon" style="font-size: 20px;"></span>
                        <h3 style="font-size: 16px; font-weight: 500; margin: 0;">All Users</h3>
                        <p>Add, edit, or manage user roles and permissions.</p>
                    </div>
                    <!-- FIX: Ginawa nang "Add New User" ang text -->
                    <button class="add-new-user-btn">Add New User</button>
                </div>
                
                <!-- New container para ma-apply ang border-radius sa listahan -->
                <div class="users-list-container">
                    <div id="usersList">
                        <!-- Users will be populated here -->
                    </div>
                </div>
            </div>

        </div>
    </div>

</div>
                
<!-- Footer -->
<div class="app-footer">
     2025 A.Space Demo. All rights reserved.
</div>
</div>

<!-- ADD NEW USER MODAL (PROFESSIONAL) -->
<div class="modal-overlay" id="addUserModal">
    <div class="form-modal-dialog" style="max-width: 500px;"> <!-- Pinalapad konti -->
        <div class="form-modal-header">
            <span class="modal-title">Create New Account</span>
            <span class="modal-close" onclick="document.getElementById('addUserModal').style.display='none';">&times;</span>
        </div>
        
        <form id="addNewUserForm">
            <div class="form-modal-body">
                
                <!-- ROW 1: NAMES -->
                <div class="pro-form-row">
                    <div class="pro-form-col" style="flex: 1.5;"> <!-- Mas malapad ang First Name -->
                        <label class="pro-label" for="userFirstName">First Name</label>
                        <input type="text" id="userFirstName" name="firstName" class="pro-input" placeholder="Juan" required>
                    </div>
                    <div class="pro-form-col">
                        <label class="pro-label" for="userMiddleName">M.I.</label>
                        <input type="text" id="userMiddleName" name="middleName" class="pro-input" placeholder="D.">
                    </div>
                </div>
                
                <div class="pro-form-row">
                    <div class="pro-form-col">
                        <label class="pro-label" for="userLastName">Last Name</label>
                        <input type="text" id="userLastName" name="lastName" class="pro-input" placeholder="Dela Cruz" required>
                    </div>
                </div>

                <!-- ROW 2: CONTACT & UNIT -->
                <div class="pro-form-row">
                    <div class="pro-form-col" style="flex: 2;">
                        <label class="pro-label" for="userEmail">Email Address</label>
                        <input type="email" id="userEmail" name="email" class="pro-input" placeholder="user@gmail.com" required>
                    </div>
                    <div class="pro-form-col">
                        <label class="pro-label" for="userBusinessUnit">Business Unit</label>
                        <select id="userBusinessUnit" name="businessUnit" class="pro-select">
                            <option>LLI</option>
                            <option>ALAND</option>
                        </select>
                    </div>
                </div>

                <!-- ROW 3: PASSWORDS -->
                <div class="pro-form-row">
                    <div class="pro-form-col">
                        <label class="pro-label" for="userPassword">Password</label>
                        <input type="password" id="userPassword" name="password" class="pro-input" placeholder="" required>
                    </div>
                    <div class="pro-form-col">
                        <label class="pro-label" for="userConfirmPassword">Confirm</label>
                        <input type="password" id="userConfirmPassword" name="confirmPassword" class="pro-input" placeholder="" required>
                    </div>
                </div>
                
                <!-- ROW 4: ROLES -->
                <div style="margin-top: 10px;">
                    <label class="pro-label">Assign Roles</label>
                    <div class="pro-checkbox-group">
                        <label class="pro-checkbox-label"><input type="checkbox" name="roles" value="user" checked> User</label>
                        <label class="pro-checkbox-label"><input type="checkbox" name="roles" value="admin"> Admin</label>
                        <label class="pro-checkbox-label"><input type="checkbox" name="roles" value="approver"> Approver</label>
                    </div>
                </div>

            </div>
        
            <div class="form-modal-footer">
                <button type="button" class="cancel-button" onclick="document.getElementById('addUserModal').style.display='none';">Cancel</button>
                <button type="submit" class="add-user-button">Create User</button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT USER MODAL (UPDATED) -->
<div class="modal-overlay" id="editUserModal">
    <div class="form-modal-dialog">
        <div class="form-modal-header">
            <span class="modal-title" id="editModalTitle">Edit User</span>
            <span class="modal-close" onclick="document.getElementById('editUserModal').style.display='none';">&times;</span>
        </div>
        
        <form id="editUserForm">
            <!-- Hidden field para i-store ang Original Email -->
            <input type="hidden" id="editOriginalEmail" name="originalEmail"> 

            <div class="form-modal-body">
                
                <!-- NEW NAME FIELDS -->
                <div class="form-group">
                    <label for="editUserFirstName">First Name</label>
                    <input type="text" id="editUserFirstName" name="firstName" required>
                </div>

                <div class="form-group">
                    <label for="editUserMiddleName">Middle Name (Optional)</label>
                    <input type="text" id="editUserMiddleName" name="middleName">
                </div>

                <div class="form-group">
                    <label for="editUserLastName">Last Name</label>
                    <input type="text" id="editUserLastName" name="lastName" required>
                </div>
                
                <div class="form-group">
                    <label for="editUserEmail">Email</label>
                    <input type="email" id="editUserEmail" name="newEmail" required>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <label for="editUserPassword">New Password (Leave blank to keep current)</label>
                    <input type="password" id="editUserPassword" name="newPassword" placeholder="Min. 6 characters">
                </div>

                <div class="form-group">
                    <label for="editUserConfirmPassword">Confirm New Password</label>
                    <input type="password" id="editUserConfirmPassword" name="confirmPassword" placeholder="Required if changing password">
                </div>
                
                <div class="form-group">
                    <label>Roles</label>
                    <div class="checkbox-group" id="editRolesCheckboxGroup">
                        <!-- Checkboxes will be populated by JS -->
                        <label><input type="checkbox" name="editRoles" value="user"> User</label>
                        <label><input type="checkbox" name="editRoles" value="admin"> Admin</label>
                        <label><input type="checkbox" name="editRoles" value="approver"> Approver</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editUserBusinessUnit">Business Unit</label>
                    <select id="editUserBusinessUnit" name="businessUnit">
                        <option>LLI</option>
                        <option>ALAND</option>
                    </select>
                </div>
            </div>
        
            <div class="form-modal-footer">
                <button type="button" class="cancel-button" onclick="document.getElementById('editUserModal').style.display='none';">Cancel</button>
                <button type="submit" class="add-user-button">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- RENAME CATEGORY MODAL (REMOVED: The logic is now disabled) -->


<!-- NEW CONFIRM REMOVAL MODAL (Kept for Category/Resource Removal) -->
<div class="modal-overlay" id="confirmRemovalModal">
    <div class="modal-dialog" style="max-width: 350px; padding: 0;">
        <!-- Pinalitan ang header classes para maging white/clean -->
        <div class="modal-header removal-modal-header"> 
            <span class="modal-title">Confirm Removal</span>
            <span class="modal-close" onclick="document.getElementById('confirmRemovalModal').style.display='none';">&times;</span>
        </div>
        <div class="modal-body" style="text-align: left; padding: 20px 20px 10px 20px;">
            <!-- Data storage for the confirmation action -->
            <input type="hidden" id="removeCategoryType">
            <input type="hidden" id="removeCategoryName">
            
            <p id="removalModalMessage" style="margin-bottom: 20px; font-size: 14px;">Are you sure you want to remove the item? This action cannot be undone.</p>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; padding: 15px 20px;">
            <button class="cancel-button" style="width: 80px;" onclick="document.getElementById('confirmRemovalModal').style.display='none';">Cancel</button>
            <button class="add-user-button" id="executeRemovalButton" style="background-color: #e53935; width: 80px;">Remove</button>
        </div>
    </div>
</div>


<!-- ADD RESOURCE MODAL (PROFESSIONAL & SHARED) -->
<div class="modal-overlay" id="addResourceModal">
    <div class="form-modal-dialog" style="max-width: 550px;">
        <div class="form-modal-header">
            <span class="modal-title" id="addResourceModalTitle">Add New Resource</span>
            <span class="modal-close" onclick="document.getElementById('addResourceModal').style.display='none';">&times;</span>
        </div>
        
        <form id="addNewResourceForm" enctype="multipart/form-data">
            <input type="hidden" id="addResourceType" name="type">

           <div class="form-modal-body">
    
    <!-- 1. NAME -->
    <div style="margin-bottom: 15px;">
        <label class="pro-label" for="resourceName">Resource Name / Description</label>
        <input type="text" id="resourceName" name="name" class="pro-input" placeholder="e.g. Conference Room A or Toyota Innova" required>
    </div>
    
    <!-- 2. VEHICLE SPECIFIC (Model & Plate) -->
    <div id="resourceModelGroup" style="display: none;">
        <div class="pro-form-row">
            <div class="pro-form-col">
                <label class="pro-label">Vehicle Model</label>
                <input type="text" id="resourceModel" name="model" class="pro-input" placeholder="e.g. HiAce GL Grandia">
            </div>
            <div class="pro-form-col">
                <label class="pro-label">Plate Number</label>
                <input type="text" id="resourcePlateNumber" name="plateNumber" class="pro-input" placeholder="ABC 1234">
            </div>
        </div>
    </div>

    <!-- 3. PHOTOS (With Alignment Fix) -->
    <div id="resourcePhotoGroup" style="display: none; margin-bottom: 15px;">
        <label class="pro-label">Vehicle Photo</label>
        <input type="file" name="vehiclePhoto" class="pro-file-input">
    </div>

    <div id="resourceSeatGroup" style="display: none; margin-bottom: 15px;">
        <label class="pro-label">Seat Layout Image (Background)</label>
        <div class="pro-form-row" style="align-items: stretch;"> <!-- Stretch para same height -->
            <div class="pro-form-col" style="flex: 2;">
                <input type="file" id="resourceSeatPhoto" name="seatPhoto" class="pro-file-input" style="height: 42px;"> <!-- Force Height -->
            </div>
            <div class="pro-form-col" style="flex: 1;">
                <!-- Preview Box (Same Height 42px) -->
                <div id="resourceSeatPhotoPreview" style="height: 42px; border: 1px solid #dfe1e5; border-radius: 6px; background-color: #f8f9fa; background-size: cover; background-position: center;"></div>
            </div>
        </div>
    </div>

    <!-- 4. LOCATION & CAPACITY -->
    <div class="pro-form-row">
        <div class="pro-form-col">
            <label class="pro-label" for="resourceLocation">Location / Garage</label>
            <select id="resourceLocation" name="location" class="pro-select">
                <option>Makati</option>
                <option>Pasig</option>
                <option>Taguig</option>
            </select>
        </div>
        <div class="pro-form-col">
            <label class="pro-label" for="resourceCapacity">Capacity (Pax)</label>
            <input type="number" id="resourceCapacity" name="capacity" class="pro-input" min="1" value="5">
        </div>
    </div>

    <!-- 5. CATEGORY & FLOOR -->
    <div class="pro-form-row">
        <div class="pro-form-col">
            <label class="pro-label" for="resourceCategory">Category</label>
            <select id="resourceCategory" name="category" class="pro-select" required>
                <!-- JS Populates this -->
            </select>
        </div>
        <div class="pro-form-col" id="resourceFloorGroup">
            <label class="pro-label" for="resourceFloor">Floor / Area</label>
            <input type="text" id="resourceFloor" name="floor" class="pro-input" placeholder="e.g. 12th Floor">
        </div>
    </div>
    
    <!-- 6. SEAT CONFIGURATION (Improved Padding) -->
    <div id="resourceSeatDetailsGroup" style="display: none; background: #fcfcfc; padding: 20px; border-radius: 6px; border: 1px dashed #ccc; margin-bottom: 15px;">
        <h4 style="margin: 0 0 15px 0; font-size: 12px; font-weight: 700; color: #e53935; text-transform: uppercase;">Seat Configuration</h4>
        
        <div class="pro-form-row">
            <div class="pro-form-col">
                <label class="pro-label">Total Seat Count</label>
                <input type="number" id="resourceSeatCount" name="seatCount" class="pro-input" value="12">
            </div>
            <div class="pro-form-col">
                <label class="pro-label">Vehicle Type Layout</label>
                <select id="resourceVehicleLayout" name="vehicleLayout" class="pro-select">
                    <option value="Van">Van</option>
                    <option value="Bus">Bus</option>
                    <option value="Coaster">Coaster</option>
                </select>
            </div>
        </div>
        <!-- Centered Button -->
        <button type="button" id="openSeatLayoutEditorBtn" class="edit-layout-btn customize-map-btn" style="width: 100%; background-color: #fff; color: #333; border: 1px solid #ccc; margin-top: 5px;">
            <span></span> Customize Seat Map (Drag & Drop)
        </button>
    </div>

    <!-- 7. AMENITIES (Room Only) -->
    <div id="resourceAmenitiesGroup" style="margin-bottom: 15px;">
        <label class="pro-label">Amenities</label>
        <div class="pro-checkbox-group" style="flex-wrap: wrap;">
            <label class="pro-checkbox-label"><input type="checkbox" name="amenities" value="Projector"> Projector</label>
            <label class="pro-checkbox-label"><input type="checkbox" name="amenities" value="Whiteboard"> Whiteboard</label>
            <label class="pro-checkbox-label"><input type="checkbox" name="amenities" value="Video Conference"> Video Conf.</label>
            <label class="pro-checkbox-label"><input type="checkbox" name="amenities" value="Large Display"> TV/Display</label>
        </div>
    </div>

    <!-- 8. RESTRICTIONS (Aligned) -->
    <div style="border-top: 1px solid #eee; padding-top: 15px;">
        <label class="pro-label">Restrictions</label>
        
        <!-- Aligned Access Row -->
        <div class="pro-checkbox-group access-restrictions-row" style="margin-bottom: 5px;">
            <span class="access-label">Access:</span>
            <label class="pro-checkbox-label"><input type="checkbox" name="accessibleBU" value="LLI"> LLI</label>
            <label class="pro-checkbox-label"><input type="checkbox" name="accessibleBU" value="ALAND"> ALAND</label>
        </div>
        <small class="pro-hint" style="display: block; margin-bottom: 10px;">Leave unchecked to allow everyone.</small>

        <div>
            <label class="pro-checkbox-label">
                <input type="checkbox" name="requiresApproval"> 
                <span style="color: #e53935; font-weight: 600;">Require Admin Approval</span>
            </label>
        </div>
    </div>

</div>
            
            <div class="form-modal-footer">
                <button type="button" class="cancel-button" onclick="document.getElementById('addResourceModal').style.display='none';">Cancel</button>
                <button type="submit" class="add-user-button" id="submitAddResourceButton">Save Resource</button>
            </div>
            
            <!-- Hidden Data -->
            <input type="hidden" id="addSeatLayoutData" name="seatLayoutData" value="{}">
        </form>
    </div>
</div>

<!-- REVISED EDIT RESOURCE MODAL (MATCHING ADD MODAL DESIGN) -->
<div class="modal-overlay" id="editResourceModal">
    <div class="form-modal-dialog" style="max-width: 550px;">
        <div class="form-modal-header">
            <span class="modal-title" id="editResourceModalTitle">Edit Resource</span>
            <span class="modal-close" onclick="document.getElementById('editResourceModal').style.display='none';">&times;</span>
        </div>
        
        <form id="editResourceForm" enctype="multipart/form-data">
            <!-- Hidden fields -->
            <input type="hidden" id="editResourceType" name="type">
            <input type="hidden" id="editResourceOriginalName" name="originalName">

            <div class="form-modal-body">
                
                <!-- 1. NAME -->
                <div style="margin-bottom: 15px;">
                    <label class="pro-label" for="editResourceName">Resource Name / Description</label>
                    <input type="text" id="editResourceName" name="name" class="pro-input" required>
                </div>

                <!-- 2. VEHICLE SPECIFIC (Model & Plate) -->
                <div id="editResourceModelGroup" style="display: none;">
                    <div class="pro-form-row">
                        <div class="pro-form-col">
                            <label class="pro-label">Vehicle Model</label>
                            <input type="text" id="editResourceModel" name="model" class="pro-input">
                        </div>
                        <div class="pro-form-col">
                            <label class="pro-label">Plate Number</label>
                            <input type="text" id="editResourcePlateNumber" name="plateNumber" class="pro-input">
                        </div>
                    </div>
                </div>

                <!-- 3. PHOTOS (Vehicle & Seat) -->
                <!-- Container for Vehicle Photo -->
                <div id="editResourcePhotoGroup" style="display: none; margin-bottom: 15px;">
                    <label class="pro-label">Current Vehicle Photo</label>
                    <div id="editVehicleCurrentImage" style="height: 100px; border: 1px solid #dfe1e5; border-radius: 6px; margin-bottom: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; background-color: #f9f9f9;"></div>
                    
                    <label class="pro-label">Replace Photo</label>
                    <input type="file" name="vehiclePhoto" id="editVehiclePhotoInputId" class="pro-file-input">
                    <div style="margin-top: 5px;">
                        <label class="pro-checkbox-label" style="font-size: 12px;"><input type="checkbox" name="removePhoto" value="true"> Remove Current Photo</label>
                    </div>
                </div>

                <!-- Container for Seat Layout Image -->
                <div id="editResourceSeatGroup" style="display: none; margin-bottom: 15px;">
                    <label class="pro-label">Current Seat Layout Image</label>
                    <div id="editSeatCurrentImage" style="height: 100px; border: 1px solid #dfe1e5; border-radius: 6px; margin-bottom: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; background-color: #f9f9f9;"></div>

                    <label class="pro-label">Replace Image</label>
                    <input type="file" id="editResourceSeatPhoto" name="seatPhoto" class="pro-file-input">
                     <div style="margin-top: 5px;">
                        <label class="pro-checkbox-label" style="font-size: 12px;"><input type="checkbox" name="removePhoto" value="true"> Remove Current Image</label>
                    </div>
                </div>

                <!-- 4. LOCATION & CAPACITY -->
                <div class="pro-form-row">
                    <div class="pro-form-col" id="editLocationCol">
                        <label class="pro-label" for="editResourceLocation">Location / Garage</label>
                        <select id="editResourceLocation" name="location" class="pro-select">
                            <option>Makati</option>
                            <option>Pasig</option>
                            <option>Taguig</option>
                        </select>
                    </div>
                    <!-- Capacity Input (Hidden for Seats) -->
                    <div class="pro-form-col" id="editCapacityCol">
                        <label class="pro-label" for="editResourceCapacity">Capacity (Pax)</label>
                        <input type="number" id="editResourceCapacity" name="capacity" class="pro-input" min="1">
                    </div>
                </div>

                <!-- 5. CATEGORY & FLOOR -->
                <div class="pro-form-row">
                    <div class="pro-form-col">
                        <label class="pro-label" for="editResourceCategory">Category</label>
                        <select id="editResourceCategory" name="category" class="pro-select" required>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="pro-form-col" id="editResourceFloorGroup">
                        <label class="pro-label" for="editResourceFloor">Floor / Area</label>
                        <input type="text" id="editResourceFloor" name="floor" class="pro-input">
                    </div>
                </div>

                <!-- 6. SEAT CONFIGURATION (Red Dashed Box style) -->
                <div id="editResourceSeatDetailsGroup" style="display: none; background: #fcfcfc; padding: 20px; border-radius: 6px; border: 1px dashed #ccc; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 15px 0; font-size: 12px; font-weight: 700; color: #e53935; text-transform: uppercase;">Seat Configuration</h4>
                    
                    <div class="pro-form-row">
                        <div class="pro-form-col">
                            <label class="pro-label">Total Seat Count</label>
                            <input type="number" id="editResourceSeatCount" name="seatCount" class="pro-input">
                        </div>
                        <div class="pro-form-col">
                            <label class="pro-label">Vehicle Type Layout</label>
                            <select id="editResourceVehicleLayout" name="vehicleLayout" class="pro-select">
                                <option value="Van">Van</option>
                                <option value="Bus">Bus</option>
                                <option value="Coaster">Coaster</option>
                            </select>
                        </div>
                    </div>
                    <!-- Customize Button -->
                    <button type="button" id="editSeatLayoutEditorBtn" class="edit-layout-btn customize-map-btn" style="width: 100%; background-color: #fff; color: #333; border: 1px solid #ccc; margin-top: 5px;">
                        <span></span> Customize Seat Map (Drag & Drop)
                    </button>
                </div>

                <!-- 7. AMENITIES (Room Only) -->
                <div id="editResourceAmenitiesGroup" style="margin-bottom: 15px; display: none;">
                    <label class="pro-label">Amenities</label>
                    <div class="pro-checkbox-group" id="editAmenitiesCheckboxGroup" style="flex-wrap: wrap;">
                        <!-- Checkboxes created by JS -->
                    </div>
                </div>

                <!-- 8. RESTRICTIONS -->
                <div style="border-top: 1px solid #eee; padding-top: 15px;">
                    <label class="pro-label">Restrictions</label>
                    
                    <div class="pro-checkbox-group access-restrictions-row" style="margin-bottom: 5px;" id="editAccessibleBUCheckboxGroup">
                        <span class="access-label">Access:</span>
                        <label class="pro-checkbox-label"><input type="checkbox" name="accessibleBU" value="LLI"> LLI</label>
                        <label class="pro-checkbox-label"><input type="checkbox" name="accessibleBU" value="ALAND"> ALAND</label>
                    </div>
                    <small class="pro-hint" style="display: block; margin-bottom: 10px;">Leave unchecked to allow everyone.</small>

                    <div>
                        <label class="pro-checkbox-label">
                            <input type="checkbox" name="requiresApproval" id="editRequiresApproval"> 
                            <span style="color: #e53935; font-weight: 600;">Require Admin Approval</span>
                        </label>
                    </div>
                </div>

            </div>
            
            <div class="form-modal-footer">
                <button type="button" class="cancel-button" onclick="document.getElementById('editResourceModal').style.display='none';">Cancel</button>
                <button type="submit" class="add-user-button" id="submitEditResourceButton">Save Changes</button>
            </div>
            
            <input type="hidden" id="editSeatLayoutData" name="seatLayoutData" value="{}">
        </form>
    </div>
</div>


<!-- NEW RESERVATION MODAL (PROFESSIONAL UI) -->
<div class="modal-overlay" id="reservationModal">
    <div class="form-modal-dialog">
        
        <!-- Header -->
        <div class="form-modal-header">
            <span class="modal-title" id="reservationModalTitle">Reserve: [Resource Name]</span>
            <span class="modal-close" onclick="document.getElementById('reservationModal').style.display='none';">&times;</span>
        </div>
        
        <form id="reservationForm">
            <!-- Hidden fields -->
            <input type="hidden" id="reserveResourceName" name="resourceName"> 
            <input type="hidden" id="reserveRequesterEmail" name="requesterEmail"> 
            <input type="hidden" id="reserveResourceType" name="resourceType"> 

            <div class="form-modal-body">
                
                <!-- Date -->
                <div class="form-group">
                    <label for="reserveDate">Date</label>
                    <input type="date" id="reserveDate" name="date" required>
                </div>

                <!-- Time Row (Side by Side) -->
                <div class="form-group date-time-row">
                    <div>
                        <label for="reserveStartTime">Start Time</label>
                        <input type="time" id="reserveStartTime" name="startTime" value="14:00" required> 
                    </div>
                    <div>
                        <label for="reserveEndTime">End Time</label>
                        <input type="time" id="reserveEndTime" name="endTime" value="15:00" required> 
                    </div>
                </div>

                <!-- Participants (Using Smart Input) -->
                <div class="form-group" id="reserveParticipantsGroup"> 
                    <label for="reserveParticipants">Participants</label>
                    <input type="text" id="reserveParticipants" name="participants" list="emailSuggestions" placeholder="Add guests (comma separated)..." autocomplete="off">
                    <datalist id="emailSuggestions"></datalist>
                </div>

                <!-- Notes -->
                <div class="form-group">
                    <label for="reserveNotes">Notes (Optional)</label>
                    <textarea id="reserveNotes" name="notes" rows="3" placeholder="Additional details..."></textarea> 
                </div>
            </div>
        
            <!-- Footer with Equal Buttons -->
            <div class="form-modal-footer">
                <button type="button" class="cancel-button" onclick="document.getElementById('reservationModal').style.display='none';">Cancel</button>
                <button type="submit" class="add-user-button" id="submitReserveButton">Reserve Now</button>
            </div>
        </form>
    </div>
</div>

<!-- SUCCESS MODAL -->
<div class="modal-overlay" id="successModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <span class="modal-title" id="modalTitle">Success</span>
            <span class="modal-close" onclick="document.getElementById('successModal').style.display='none';">&times;</span>
        </div>
        <div class="modal-body">
            <p id="modalMessage">Password changed successfully.</p>
        </div>
        <div class="modal-footer">
            <button class="modal-ok-button" onclick="document.getElementById('successModal').style.display='none';">OK</button>
        </div>
    </div>
</div>

<!-- NEW SEAT SELECTION MODAL -->
<div class="modal-overlay" id="seatSelectionModal">
    <div class="form-modal-dialog" style="max-width: 480px; padding: 0;"> 
        <div class="form-modal-header">
            <span class="modal-title" id="seatModalTitle">Reserve a seat on [Shuttle Name] for [Date]</span>
            <span class="modal-close" onclick="document.getElementById('seatSelectionModal').style.display='none';">&times;</span>
        </div>
        
        <form id="seatReservationForm">
            <!-- Hidden fields -->
            <input type="hidden" id="seatReserveResourceName" name="resourceName"> 
            <input type="hidden" id="seatReserveDate" name="date"> 
            <input type="hidden" id="selectedSeatNumber" name="seatNumber"> <!-- New: Selected Seat -->

            <div class="form-modal-body">
                <p style="text-align: center; font-weight: bold; color: #333; margin-top: 0; margin-bottom: 20px;">Select an available seat</p>

                <!-- SEAT MAP CONTAINER (Dito lalabas ang van layout) -->
                <div id="seatMapContainer" style="display: flex; justify-content: center; align-items: center; margin: 20px 0;">
                    <p style="text-align: center;">Loading seat map...</p>
                </div>

               <p style="font-size: 14px; font-weight: 600; color: #333; margin-top: 20px; margin-bottom: 10px;">Reservation Time</p>
<div class="form-group" style="display: flex; gap: 20px;">
    <div style="flex: 1;">
        <label for="seatReserveStartTime" style="font-weight: 500;">Start Time</label>
        <div class="time-input-container">
            <!-- Pinalitan ang default value sa 24hr format para gumana ang value, pero i-format natin sa JS ang display -->
            <input type="time" id="seatReserveStartTime" name="startTime" value="08:00" required> 
            <span class="time-icon"></span>
        </div>
    </div>
    <div style="flex: 1;">
        <label for="seatReserveEndTime" style="font-weight: 500;">End Time</label>
        <div class="time-input-container">
            <input type="time" id="seatReserveEndTime" name="endTime" value="09:00" required> 
            <span class="time-icon"></span>
        </div>
    </div>
</div>

                <div class="form-group">
                    <label for="seatReserveNotes" style="font-weight: 500;">Notes (Optional)</label>
                    <textarea id="seatReserveNotes" name="notes" rows="3"></textarea> 
                </div>
            </div>
        
            <div class="form-modal-footer">
                <button type="button" class="cancel-button" onclick="document.getElementById('seatSelectionModal').style.display='none';">Cancel</button>
                <button type="submit" class="add-user-button" id="submitReserveSeatButton" style="background-color: #e53935;" disabled>Reserve Seat</button>
            </div>
        </form>
    </div>
</div>

<!-- NEW EDIT LAYOUT MODAL FOR DRAG AND DROP (FIXED SIZE) -->
<div class="modal-overlay" id="editLayoutModal">
    <div class="form-modal-dialog"> 
        <div class="form-modal-header">
            <span class="modal-title">Edit Seat Layout</span>
            <span class="modal-close" onclick="document.getElementById('editLayoutModal').style.display='none';">&times;</span>
        </div>
        
        <div class="form-modal-body" style="text-align: center; padding: 20px;">
            <p style="font-size: 13px; color: #666; margin-bottom: 20px; line-height: 1.5;">
                <strong>Instructions:</strong> Click and drag a seat to move it.<br>
                Select a seat (blue outline) and click 'Remove Selected' to delete it.
            </p>
            
            <!-- Hidden field to save the layout data -->
            <input type="hidden" id="editorSeatLayoutData" value="{}"> 
            
            <!-- Layout Area (Van Layout Simulation) -->
            <div id="seatLayoutEditor">
                <!-- Seats will be rendered here by JS -->
            </div>

            <!-- Action Buttons -->
           <div class="seat-editor-actions">
    <button type="button" id="addSeatButton">
        <span></span> 
        <span>Add Seat</span>
    </button>
    
    <button type="button" id="removeSelectedButton" disabled>
        <span></span> 
        <span>Remove Selected</span>
    </button>
    
    <button type="button" id="saveLayoutButton">
        <span></span> 
        <span>Save Layout</span>
    </button>
</div>
        </div>
    </div>
</div>

<!-- NEW: FLOOR PLAN LAYOUT EDITOR MODAL -->
<div class="modal-overlay" id="floorPlanEditorModal">
    <div class="form-modal-dialog" style="max-width: 800px;"> 
        <div class="form-modal-header">
            <span class="modal-title" id="fpEditorTitle">Edit Layout for: [Category]</span>
            <span class="modal-close" onclick="closeFloorPlanEditor()">&times;</span>
        </div>
        
        <div class="form-modal-body">
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                Click and drag the resource indicators (green dots) to their correct positions on the floor plan.
            </p>
            
            <!-- UPDATED EDITOR CONTAINER -->
<div id="fpEditorContainer" class="fp-editor-container" style="display: flex; justify-content: center; align-items: center; background-color: #333; overflow: hidden;">
    <!-- Bagong Wrapper: Ito ang magiging reference point ng markers -->
    <div id="fpImageWrapper" style="position: relative; display: inline-block;">
        <img id="fpEditorImageElement" src="" style="max-width: 100%; max-height: 100%; display: block; pointer-events: none;" draggable="false">
        <!-- Dito i-iinject ng JS ang Markers sa loob ng wrapper na ito -->
    </div>
</div>
            
            <!-- Hidden inputs to store current context -->
            <input type="hidden" id="fpEditType">
            <input type="hidden" id="fpEditCategory">

        </div>
        
        <div class="form-modal-footer">
            <button type="button" class="cancel-button" onclick="closeFloorPlanEditor()">Cancel</button>
            <button type="button" class="add-user-button" onclick="saveFloorPlanLayout()">Save Layout</button>
        </div>
    </div>
</div>

<!-- Ang structure na pinagbabasehan natin: -->
<div class="modal-overlay" id="confirmActionModal">
    <div class="modal-dialog" style="max-width: 400px; padding: 0;">
        <div class="modal-header removal-modal-header">
            <!-- Dito nagbabago ang Title (via JS) -->
            <span class="modal-title" id="confirmActionTitle">Confirm Action</span> 
            <span class="modal-close" onclick="closeConfirmActionModal()">&times;</span>
        </div>
        
        <div class="modal-body" style="padding: 20px;">
            <!-- Dito nagbabago ang Message (via JS) -->
            <p id="confirmActionMessage" style="font-size: 14px; color: #333; margin: 0;">Are you sure?</p> 
            
            <!-- Hidden fields para matandaan kung alin ang ina-approve -->
            <input type="hidden" id="actionRowNumber">
            <input type="hidden" id="actionStatus">
        </div>

        <div class="modal-footer" style="padding: 15px 20px; display: flex; justify-content: flex-end; gap: 10px;">
            <button class="cancel-button" onclick="closeConfirmActionModal()">Cancel</button>
            <button id="executeActionButton" class="add-user-button">Confirm</button>
        </div>
    </div>
</div>

<!-- FORGOT PASSWORD MODAL (3-STEP VERIFICATION) -->
<div class="modal-overlay" id="forgotPasswordModal" style="display: none;">
    <div class="form-modal-dialog" style="max-width: 400px;">
        <div class="form-modal-header">
            <span class="modal-title">Reset Password</span>
            <span class="modal-close" onclick="closeForgotModal()">&times;</span>
        </div>
        
        <form id="forgotPasswordForm" novalidate>
            <div class="form-modal-body">
                
                <!-- STEP 1: EMAIL -->
                <div id="forgotStep1">
                    <p style="font-size: 14px; color: #666; margin-bottom: 20px;">
                        Enter your email address to receive a verification code.
                    </p>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="recoverEmail" name="email" placeholder="e.g., user@example.com" required>
                    </div>
                </div>

                <!-- STEP 2: OTP VERIFICATION -->
                <div id="forgotStep2" style="display: none;">
                    <p style="font-size: 14px; color: #4CAF50; margin-bottom: 15px; font-weight: bold;">
                        <span style="font-size: 18px;"></span> Code sent! Check your email.
                    </p>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                        Enter the 6-digit code below to verify your identity.
                    </p>
                    <div class="form-group">
                        <label>Verification Code</label>
                        <input type="text" id="recoverOTP" placeholder="123456" maxlength="6" 
                               style="letter-spacing: 5px; font-weight: bold; text-align: center; font-size: 18px;">
                    </div>
                </div>

                <!-- STEP 3: NEW PASSWORD -->
                <div id="forgotStep3" style="display: none;">
                    <p style="font-size: 14px; color: #4CAF50; margin-bottom: 15px;">
                         Verified. Set your new password.
                    </p>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="recoverNewPass" placeholder="New Password" required>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="recoverConfirmPass" placeholder="Confirm Password" required>
                    </div>
                </div>

            </div>
        
            <div class="form-modal-footer">
                <button type="button" class="cancel-button" onclick="closeForgotModal()">Cancel</button>
                
                <!-- Step 1 Button -->
                <button type="button" class="add-user-button" id="btnSendCode">Send Code</button>
                
                <!-- Step 2 Button -->
                <button type="button" class="add-user-button" id="btnVerifyCode" style="display: none; background-color: #2196F3;">Verify Code</button>
                
                <!-- Step 3 Button -->
                <button type="button" class="add-user-button" id="btnSavePass" style="display: none; background-color: #4CAF50;">Save Password</button>
            </div>
        </form>
    </div>
</div>


<script>
  // -------------------- CLIENT-SIDE JAVASCRIPT LOGIC --------------------
  
  // Tab/Content Data (UPDATED: admin-dashboard customView)
  const tabContents = {
      'room': { title: 'Interactive Layout (Floor Plan)', subtitle: 'Please select a specific category from the filter to see its floor plan.', message: 'No meeting rooms match your criteria or are accessible to you.', hasLayout: true, customView: 'generalFilters', },
      'desk': { title: 'Interactive Office Layout', subtitle: 'Please select a specific category from the filter to see its office layout.', message: 'No desks match your criteria or are accessible to you.', hasLayout: true, customView: 'generalFilters', },
      'car': { title: '', subtitle: '', message: 'No car seats match your criteria or are accessible to you.', hasLayout: false, customView: 'carSeatView' },
      'vehicle': { title: '', subtitle: '', message: 'No vehicles match your criteria or are accessible to you.', hasLayout: false, customView: 'vehicleView' },
      'my-reservations': { title: 'My Reservations', subtitle: 'You have no reservations yet.', message: '', hasLayout: false, customView: 'listOnlyView' },
      'approvals': { title: 'Pending Approvals', subtitle: 'There are no pending approvals.', message: '', hasLayout: false, customView: 'listOnlyView' },
      'profile': { title: 'My Profile', subtitle: '', message: '', hasLayout: false, customView: 'profileView' }, 
      'admin-dashboard': { title: 'Admin Dashboard', subtitle: '', message: '', hasLayout: false, customView: 'adminView' }, 
      'help': { title: 'Help Center', subtitle: '', message: '', hasLayout: false, customView: 'helpView' }, // NEW
  };
  // Global Variables for Admin Filtering
let allAdminReservationsData = []; // Dito natin ise-save ang raw data
let currentSortColumn = 'date';    // Default sort
let currentSortOrder = 'desc';     // Default order (Latest first)
  let pendingApprovalButtonElement = null;

  let currentUser = { email: '', role: '', name: '', businessUnit: '' }; // NEW fields
  window.allUsersData = []; // NEW: Global variable to store fetched users for editing
  window.categoriesData = { room: [], desk: [], seat: [], vehicle: [] }; // NEW: Global variable to store categories
  window.allResourcesData = []; // NEW: Global variable to store all fetched resources for editing
  window.allFloorPlansData = []; // <--- NEW: Global variable to store floor plans data

  // Function para i-clear ang error state
  function clearLoginError() {
      document.getElementById('loginErrorMessage').style.display = 'none';
      document.getElementById('email').classList.remove('input-error');
      document.getElementById('password').classList.remove('input-error');
  }

  // Function para ipakita ang error state
  function showLoginError(message) {
      const errorDiv = document.getElementById('loginErrorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      
      // I-apply ang red border
      document.getElementById('email').classList.add('input-error');
      document.getElementById('password').classList.add('input-error');
  }

  // Function to toggle dropdown
  function toggleDropdown() {
      document.getElementById('userDropdownMenu').classList.toggle('visible');
  }
  
  // Function to open and populate the Edit User Modal (UPDATED)
  function openEditUserModal(email) {
      const user = window.allUsersData.find(u => u.email === email);
      if (!user) {
          alert('Error: User not found in the current list.');
          return;
      }

      const modal = document.getElementById('editUserModal');
      const form = document.getElementById('editUserForm');
      
      // 1. Reset form
      form.reset();
      
      // 2. Populate Modal Fields
      document.getElementById('editModalTitle').textContent = `Edit User: ${user.name || user.email}`;
      document.getElementById('editOriginalEmail').value = user.email; 
      document.getElementById('editUserEmail').value = user.email;
      document.getElementById('editUserBusinessUnit').value = user.businessUnit;

      // --- SPLIT NAME LOGIC ---
      // Assumes format: "First Middle Last" or "First Last"
      const fullName = user.name || "";
      const nameParts = fullName.trim().split(" ");
      
      let fName = "";
      let mName = "";
      let lName = "";

      if (nameParts.length === 1) {
          fName = nameParts[0]; // Only First Name available
      } else if (nameParts.length === 2) {
          fName = nameParts[0];
          lName = nameParts[1]; // First + Last
      } else if (nameParts.length >= 3) {
          fName = nameParts[0];
          lName = nameParts[nameParts.length - 1]; // Last element is Last Name
          // Join everything in between as Middle Name
          mName = nameParts.slice(1, nameParts.length - 1).join(" "); 
      }

      document.getElementById('editUserFirstName').value = fName;
      document.getElementById('editUserMiddleName').value = mName;
      document.getElementById('editUserLastName').value = lName;
      // ------------------------

      // 3. Populate Roles Checkboxes
      const roles = user.role.split(',').map(r => r.trim());
      const checkboxes = form.querySelectorAll('input[name="editRoles"]');
      
      checkboxes.forEach(checkbox => {
          checkbox.checked = roles.includes(checkbox.value);
      });

      // 4. Show modal
      modal.style.display = 'flex';
  }

  // NEW: Function para mag-render ng User List (UPDATED to match new UI)
  function renderUserList(users) {
      const listDiv = document.getElementById('usersList');
      listDiv.innerHTML = ''; // Clear previous content

      // NEW: I-store ang users data sa global variable para madaling ma-access
      window.allUsersData = users; 

      users.forEach(user => {
          // I-join ang roles
          const roles = user.role.split(',').map(r => r.trim()).filter(r => r.length > 0).map(r => r.charAt(0).toUpperCase() + r.slice(1)).join(', ');
          
          const card = document.createElement('div');
          card.className = 'user-card';
          
          // Determine if the user is a superuser/admin to make the name red and bold
          const isSuperuser = user.role.toLowerCase().includes('admin');
          const nameStyle = isSuperuser ? 'color: #e53935; font-weight: bold;' : 'color: #333; font-weight: bold;';
          
          // Gumawa ng HTML para gayahin ang layout ng User Card
          card.innerHTML = `
              <div class="user-details">
                  <strong style="${nameStyle}">
                      ${user.name || user.email.split('@')[0].toUpperCase().replace('.', ' ')}
                  </strong>
                  <small>${user.email} - ${user.businessUnit} - Roles: ${roles}</small>
              </div>
              <button class="edit-user-btn" data-email="${user.email}">Edit</button>
          `;
          listDiv.appendChild(card);
      });
      
      // NEW: Add event listeners to all 'Edit' buttons
      document.querySelectorAll('.edit-user-btn').forEach(button => {
          button.addEventListener('click', function() {
              const emailToEdit = this.getAttribute('data-email');
              openEditUserModal(emailToEdit); 
          });
      });
  }
  
  // NEW: Function to render a single category type list
  function renderCategoryList(type, categories) {
      // Tiyakin na ang ID na ginagamit ay tama
      const listDiv = document.getElementById(`${type}CategoryList`); // Gumagamit ng 'seat'CategoryList
      if (!listDiv) return; // Exit kung hindi mahanap ang element
      
      listDiv.innerHTML = ''; 
      
      if (categories.length === 0) {
          listDiv.innerHTML = '<div class="no-resource-message">No categories added yet.</div>';
          return;
      }

      categories.forEach(categoryName => {
          const item = document.createElement('div');
          item.className = 'category-item';
          
          item.innerHTML = `
              <span class="category-name">${categoryName}</span>
              <div class="category-actions">
                  <!-- Kept the button HTML but removed logic -->
                  <button class="rename-btn" data-category="${categoryName}" data-type="${type}" style="cursor: not-allowed;">Rename</button>
                  <button class="remove-btn" data-category="${categoryName}" data-type="${type}">Remove</button>
              </div>
          `;
          listDiv.appendChild(item);
      });
      
      // ADD Event Listener for REMOVE button (Kept for functionality)
      document.querySelectorAll('.remove-btn').forEach(button => {
          button.addEventListener('click', function() {
              const type = this.getAttribute('data-type');
              const name = this.getAttribute('data-category');
              handleRemoveCategory(type, name);
          });
      });
      
      // NOTE: REMOVED the event listener for '.rename-btn' here.
  }

  // NEW: Function to fetch all categories from the server
  function loadCategories() {
      // Clear all lists and show loading state
      document.getElementById('roomCategoryList').innerHTML = '<div class="no-resource-message">Loading...</div>';
      document.getElementById('deskCategoryList').innerHTML = '<div class="no-resource-message">Loading...</div>';
      document.getElementById('seatCategoryList').innerHTML = '<div class="no-resource-message">Loading...</div>'; // <--- UPDATED: car -> seat

      google.script.run
          .withSuccessHandler(function(response) {
              if (response.success) {
                  // I-store ang categories sa global variable
                  window.categoriesData = response.categories;
                  
                  // Render bawat listahan
                  renderCategoryList('room', response.categories.room);
                  renderCategoryList('desk', response.categories.desk);
                  renderCategoryList('seat', response.categories.seat); // <--- UPDATED: car -> seat
                  
              } else {
                  // Ipakita ang error sa lahat ng listahan
                  const message = response.message;
                  document.getElementById('roomCategoryList').innerHTML = `<div class="no-resource-message">${message}</div>`;
                  document.getElementById('deskCategoryList').innerHTML = `<div class="no-resource-message">${message}</div>`;
                  document.getElementById('seatCategoryList').innerHTML = `<div class="no-resource-message">${message}</div>`; // <--- UPDATED: car -> seat
                  // I-clear din ang global variable sa error
                  window.categoriesData = { room: [], desk: [], seat: [], vehicle: [] };
              }
          })
          .withFailureHandler(function(error) {
              const message = 'Failed to load categories: ' + error.toString();
              document.getElementById('roomCategoryList').innerHTML = `<div class="no-resource-message">${message}</div>`;
              document.getElementById('deskCategoryList').innerHTML = `<div class="no-resource-message">${message}</div>`;
              document.getElementById('seatCategoryList').innerHTML = `<div class="no-resource-message">${message}</div>`; // <--- UPDATED: car -> seat
              window.categoriesData = { room: [], desk: [], seat: [], vehicle: [] };
          })
          .getAllCategories(currentUser.email); // <--- UPDATED: Added currentUser.email
  }


  // ***************************************************************
  // RESOURCE RENDERING LOGIC (ADMIN & USER VIEWS)
  // ***************************************************************

  /**
   * Helper function to render an individual resource card for Admin View
   */
  function createAdminResourceCard(resource) {
      const card = document.createElement('div');
      card.className = 'user-card'; 

      const capacityDisplay = resource.capacity ? ` - Cap ${resource.capacity}` : '';
      const floorDisplay = resource.floor ? ` - Flr ${resource.floor}` : '';
      
      // NEW: Adjust display for vehicle (since Floor column now contains Model/Plate)
      let secondaryDetail = '';
      if (resource.type.toLowerCase() === 'vehicle') {
          // If resource.floor contains Model/Plate info
          secondaryDetail = ` - ${resource.floor}`; 
      } else {
          secondaryDetail = `${capacityDisplay}${floorDisplay}`;
      }

      card.innerHTML = `
          <div class="user-details">
              <strong style="color: #e53935;">
                  ${resource.name}
              </strong>
              <small>${resource.location}${secondaryDetail}</small>
          </div>
          <!-- Edit button remains cosmetic only, with data attributes intact -->
          <button class="edit-resource-btn" data-type="${resource.type}" data-name="${resource.name}" style="width: 50px;">Edit</button>
          <button class="remove-resource-btn" data-type="${resource.type}" data-name="${resource.name}" style="width: 70px; background-color: #e53935; color: white;">Remove</button>
      `;

      return card;
  }
  
 /**
 * Helper function to render an individual resource card for User View
 * UPDATED: With Dynamic Background Colors (Green-50, Red-50, White)
 */
function createUserResourceCard(resource) {
    const card = document.createElement('div');
    
    const typeLower = resource.type.toLowerCase();
    const isReserved = resource.status === 'In Use' && resource.currentReservation;

    // -----------------------------------------------------------
    // 1. SHUTTLE / CAR SEAT CARD
    // Rule: Available = Green-50, Full = Red-50
    // -----------------------------------------------------------
    if (typeLower === 'seat' || typeLower === 'car seat') {
        card.style.display = 'block'; 

        const title = resource.name; 
        const route = resource.category; 
        
        // 1. Calculate Availability
        let totalSeats = 0;
        // Priority 1: Check amenities
        if (resource.amenities && resource.amenities.includes('SeatCount:')) {
            const match = resource.amenities.match(/SeatCount: (\d+)/);
            if (match && match[1]) totalSeats = parseInt(match[1]);
        }
        // Priority 2: Check capacity column
        if (totalSeats === 0 && resource.capacity) totalSeats = parseInt(resource.capacity);

        const bookedCount = resource.bookedCount || 0;
        let availableCount = totalSeats - bookedCount;
        if (availableCount < 0) availableCount = 0;

        // 2. Determine Background Color
        // Kung 0 available (Full) -> Red-50, else -> Green-50
        const bgClass = (availableCount === 0) ? 'bg-in-use' : 'bg-available';

        // Badge Styling
        let badgeStyle = '';
        if (availableCount === 0) {
            badgeStyle = 'background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2;'; // Red badge
        } else {
            badgeStyle = 'background-color: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb;'; // Blue badge
        }
        
        card.innerHTML = `
            <div class="shuttle-card-wrapper ${bgClass}">
                <div>
                    <div class="shuttle-header">
                        <h4 class="shuttle-title">${title}</h4>
                        <span class="shuttle-badge" style="${badgeStyle}">${availableCount} Available</span>
                    </div>
                    
                    <div class="shuttle-subtext-group">
                        <span class="shuttle-route">Route/Service: ${route}</span>
                        <div class="shuttle-seat-info">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 9h-4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h4v-9Z"/><path d="M7 9h4v9H7z"/><path d="M7 18v2a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2h2"/></svg>
                            <span>${availableCount} / ${totalSeats} seats available</span>
                        </div>
                    </div>
                </div>

                <button class="view-seats-btn reserve-button-user" data-resource-name="${resource.name}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 12h.01"/><path d="M18 12h.01"/></svg>
                    View Seats
                </button>
            </div>
        `;
        return card;
    }

    // -----------------------------------------------------------
    // 2. VEHICLE CARD LAYOUT
    // Rule: Available = White (Neutral), Booked = Red-50
    // -----------------------------------------------------------
    if (typeLower === 'vehicle') {
        // Determine Background: In Use -> Red, Available -> White (Neutral)
        const bgClass = isReserved ? 'bg-in-use' : 'bg-neutral';
        
        // I-apply ang class sa main container ng vehicle card
        card.className = `resource-card-user vehicle-card-container ${bgClass}`; 
        
        let model = '';
        let plate = 'N/A';
        if (resource.floor) {
            const modelMatch = resource.floor.match(/Model: (.*?) \|/);
            const plateMatch = resource.floor.match(/Plate: (.*)/);
            if (modelMatch) model = modelMatch[1];
            if (plateMatch) plate = plateMatch[1];
        }

        let statusBadgeHTML = !isReserved ? `<span class="v-badge v-avail">Available</span>` : '';
        if (resource.requiresApproval === 'Yes' && !isReserved) {
            statusBadgeHTML += `<span class="v-badge v-approval">Approval Required</span>`;
        }

        let bookedByHTML = isReserved ? 
            `<div class="booked-by-box"><span class="booked-by-label">Booked by:</span>${resource.currentReservation.reservedBy}</div>` : 
            `<div style="height: 15px;"></div>`;

        card.innerHTML = `
        <div class="vehicle-header-row" style="margin-top: 10px;">
            <div class="vehicle-title-group"><h3 class="vehicle-name">${resource.name}</h3><div class="vehicle-model">${model}</div></div>
            <div class="vehicle-badges">${statusBadgeHTML}</div>
        </div>
        <div class="vehicle-info-row">
            <div class="vehicle-info-item"><span class="vehicle-icon"></span><span>Plate: ${plate}</span></div>
            <div class="vehicle-info-item"><span class="vehicle-icon"></span><span>Cap: ${resource.capacity}</span></div>
        </div>
        ${bookedByHTML}
        <button class="reserve-btn-full reserve-button-user" data-resource-name="${resource.name}" ${isReserved ? 'disabled' : ''}>
            <span></span> Reserve Vehicle
        </button>`;
        
        return card;
    }

    // -----------------------------------------------------------
    // 3. STANDARD LAYOUT (ROOMS / DESKS)
    // Rule: Available = Green-50, Booked = Red-50
    // -----------------------------------------------------------
    
    // Determine Background: In Use -> Red, Available -> Green
    const bgClass = isReserved ? 'bg-in-use' : 'bg-available';
    
    card.className = `resource-card-user ${bgClass}`;

    const capacityDisplay = resource.capacity ? `${resource.capacity} People` : '';
    const approvalRequired = resource.requiresApproval === 'Yes' ? '<span class="approval-tag">Approval Required</span>' : '';
    const amenitiesArray = resource.amenities ? resource.amenities.split(',').map(a => a.trim()).filter(a => a.length > 0) : [];
    const amenitiesHtml = amenitiesArray.map(a => `<span class="amenity-tag">${a}</span>`).join('');
    
    let secondaryDetail = `Location: ${resource.location} - ${resource.floor}`;
    if (typeLower === 'desk') secondaryDetail = `Location: ${resource.category}`;
    
    let conditionalContent = isReserved ? 
        `<div style="background-color: rgba(255,255,255,0.6); padding: 10px; border-radius: 5px; margin: 10px 0; color: #c62828; font-size: 13px; font-weight: 500; border: 1px solid #ef9a9a;">Reserved by: <strong>${resource.currentReservation.reservedBy}</strong><br>Until: <strong>${resource.currentReservation.endTime}</strong></div>` : 
        `<div class="resource-details-user"><i class="fa fa-users"></i> ${capacityDisplay}</div><div class="amenities-container">Amenities:<br>${amenitiesHtml.length > 0 ? amenitiesHtml : '<span class="amenity-tag">N/A</span>'}</div>`;

    card.innerHTML = `
        <div class="resource-header-user">
            <div class="resource-name-user" style="color: #e53935;">${resource.name}</div>
            <div><span class="status-tag ${isReserved ? 'status-in-use' : 'status-available'}">${isReserved ? 'In Use' : resource.status}</span>${!isReserved ? approvalRequired : ''}</div>
        </div>
        ${conditionalContent} 
        <p style="font-size: 12px; color: #777; margin: 5px 0 15px 0;">${secondaryDetail}</p>
        <button class="reserve-button-user" data-resource-name="${resource.name}" ${isReserved ? 'disabled' : ''}>Reserve ${resource.type.charAt(0).toUpperCase() + resource.type.slice(1)}</button>
    `;

    return card;
}
  /**
   * Renders the fetched resources into their respective sections (Admin View).
   */
  function renderAdminResourceList(resources) {
      // Clear previous content and put up loading message
      document.getElementById('roomList').innerHTML = '<div class="no-resource-message">No rooms added yet.</div>';
      document.getElementById('deskList').innerHTML = '<div class="no-resource-message">No desks added yet.</div>';
      document.getElementById('carList').innerHTML = '<div class="no-resource-message">No car seats added yet.</div>';

      const categorizedResources = {
          room: [],
          desk: [],
          car: [],
          vehicle: []
      };
      
      // NEW: I-store ang lahat ng resources sa global variable
      window.allResourcesData = resources; 

      // 1. Group resources by type
      resources.forEach(resource => {
          const type = resource.type.toLowerCase();
          // Note: Use 'car' for display even if sheet type is 'seat' for now
          const listType = (type === 'seat') ? 'car' : type; 
          if (categorizedResources[listType]) {
              categorizedResources[listType].push(resource);
          }
      });

      // 2. Render each group
      for (const type in categorizedResources) {
          const listDiv = document.getElementById(`${type}List`);
          if (listDiv) {
              listDiv.innerHTML = ''; // Clear 'No items' message

              if (categorizedResources[type].length > 0) {
                  categorizedResources[type].forEach(resource => {
                      listDiv.appendChild(createAdminResourceCard(resource));
                  });
              } else {
                  // Re-add 'No items' message if list is empty
                  listDiv.innerHTML = `<div class="no-resource-message">No ${type}s added yet.</div>`;
              }
          }
      }
      
      // 3. Add Event Listeners for Edit/Remove Buttons
      // NOTE: Tinanggal ang event listener para sa '.edit-resource-btn'
      document.querySelectorAll('.edit-resource-btn').forEach(button => {
          button.addEventListener('click', function() {
              const type = this.getAttribute('data-type');
              const name = this.getAttribute('data-name');
              openEditResourceModal(type, name); 
          });
      });
      
      // Add Event Listener for REMOVE Button (Kept for functionality)
      document.querySelectorAll('.remove-resource-btn').forEach(button => {
          button.addEventListener('click', function() {
              const type = this.getAttribute('data-type');
              const name = this.getAttribute('data-name');
              handleRemoveResource(type, name); 
          });
      });
  }

  /**
 * Renders the fetched resources for a specific User View tab.
 */
function renderUserResourceView(resources, currentTabType) {
    const listDiv = document.getElementById('itemListArea');
    listDiv.innerHTML = ''; 
    listDiv.style.display = 'grid'; 

    // --- NEW: Dynamic Filter IDs ---
    let locationFilterId = 'locationFilter';
    let categoryFilterId = 'categoryFilter';
    let filterType = currentTabType;

    if (currentTabType === 'car') {
        filterType = 'seat';
        locationFilterId = 'carLocationFilter';
        categoryFilterId = 'carRouteFilter';
    } else if (currentTabType === 'vehicle') {
        locationFilterId = 'vehicleLocationFilter';
        categoryFilterId = 'vehicleTypeFilter';
    }

    // Kunin ang values mula sa tamang dropdowns
    const locationSelect = document.getElementById(locationFilterId);
    const categorySelect = document.getElementById(categoryFilterId);
    
    // Default to 'All...' kung wala pa ang element
    const locationFilterValue = locationSelect ? locationSelect.value : 'All Locations';
    const categoryFilterValue = categorySelect ? categorySelect.value : 'All Categories'; 
    
    // Handle "All Types", "All Services" variations
    const isAllLocation = locationFilterValue === 'All Locations';
    const isAllCategory = categoryFilterValue.startsWith('All'); // Matches "All Categories", "All Services", "All Types"

    // --- Apply Filters ---
    let filteredResources = resources.filter(r => r.type.toLowerCase() === filterType);
    
    if (!isAllLocation) {
        filteredResources = filteredResources.filter(r => r.location === locationFilterValue);
    }

    if (!isAllCategory) {
        filteredResources = filteredResources.filter(r => r.category === categoryFilterValue);
    }
    // --- END OF NEW FILTER LOGIC ---
    
    if (filteredResources.length === 0) {
        listDiv.style.display = 'block'; 
        listDiv.innerHTML = `<p class="no-items-message">${tabContents[currentTabType].message}</p>`;
        return;
    }

    filteredResources.forEach(resource => {
        listDiv.appendChild(createUserResourceCard(resource));
    });
    
    // Re-attach listeners
    document.querySelectorAll('.reserve-button-user').forEach(button => {
        button.addEventListener('click', function(e) {
            const resourceName = e.target.getAttribute('data-resource-name');
            // Check if view seats button (for shuttle) or reserve button
            if (this.classList.contains('view-seats-btn')) {
                 openSeatSelectionModal(resourceName);
            } else {
                 openReservationModal(resourceName);
            }
        });
    });
}
  
  /**
 * Fetches all resources from the server. Used for Admin & User Views.
 * @param {string} viewType - 'admin' or the user tab type ('room', 'desk', etc.)
 * 
 * NOTE: Ito ang main entry point. Tinitiyak na ang Floor Plans ay na-load na bago ang Resources.
 */
function loadResources(viewType) {
    
    const adminViewActive = viewType === 'admin';

    if (adminViewActive) {
        // Set initial loading messages for Admin View
        document.getElementById('roomList').innerHTML = '<div class="no-resource-message">Loading resources...</div>';
        document.getElementById('deskList').innerHTML = '<div class="no-resource-message">Loading resources...</div>';
        document.getElementById('carList').innerHTML = '<div class="no-resource-message">Loading resources...</div>';
        
    } else {
        // Set initial loading message for User View
        document.getElementById('itemListArea').style.display = 'block';
        document.getElementById('itemListArea').innerHTML = '<p class="no-items-message" style="padding-top: 0;">Loading resources...</p>';
    }

    // NEW: Tiyakin na loaded na ang Floor Plans Data bago ang Resources
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                window.allFloorPlansData = response.plans;
                loadAllResourcesData(viewType); // Ipagpatuloy sa pag-load ng Resources
            } else {
                console.error("Failed to load Floor Plans:", response.message);
                window.allFloorPlansData = [];
                loadAllResourcesData(viewType); // Ipagpatuloy pa rin ang pag-load ng Resources
            }
        })
        .withFailureHandler(function(error) {
            console.error("Server Error loading Floor Plans:", error.toString());
            window.allFloorPlansData = [];
            loadAllResourcesData(viewType); // Ipagpatuloy pa rin ang pag-load ng Resources
        })
        .getAllFloorPlans(); 
}

/**
 * NEW: Helper function to fetch ALL resources data from the server.
 * @param {string} viewType - 'admin' or the user tab type ('room', 'desk', etc.)
 */
function loadAllResourcesData(viewType) {
    const adminViewActive = viewType === 'admin';
    
    // NEW: Check if global data is loaded (Only load from server if not already loaded OR if in Admin view which requires the latest data)
    if (window.allResourcesData.length > 0 && !adminViewActive) {
        renderUserResourceView(window.allResourcesData, viewType);
        loadFilters(viewType); // NEW: Tiyakin na tatawagin ang filters!
        return;
    }

    // Load from server
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                // >>> DITO ANG IMPORTANTE: I-save ang data sa global variable <<<
                window.allResourcesData = response.resources; 
                
                if (adminViewActive) {
                    renderAdminResourceList(response.resources);
                } else {
                    renderUserResourceView(response.resources, viewType); // Renders filtered list
                    loadFilters(viewType); // UPDATED: Tiyakin na tatawagin ang filters!
                }
            } else {
                const message = response.message;
                if (adminViewActive) {
                    document.getElementById('roomList').innerHTML = `<div class="no-resource-message">Error loading resources: ${message}</div>`;
                } else {
                    document.getElementById('itemListArea').innerHTML = `<p class="no-items-message" style="padding-top: 0;">Error loading resources: ${message}</p>`;
                }
            }
        })
        .withFailureHandler(function(error) {
            const message = 'Server Error: ' + error.toString();
            if (adminViewActive) {
               document.getElementById('roomList').innerHTML = `<div class="no-resource-message">${message}</div>`;
            } else {
                document.getElementById('itemListArea').innerHTML = `<p class="no-items-message" style="padding-top: 0;">${message}</p>`;
            }
        })
        .getAllResources(currentUser.email);
}


// ***************************************************************
// NEW: FILTER LOGIC
// ***************************************************************

/**
 * NEW: Populates the Location and Category filters based on all loaded resources.
 * UPDATED: Works for ALL tabs (Room, Desk, Car Seat, Vehicle).
 */
function loadFilters(currentTabType) {
    // 1. Determine Resource Type & Filter Elements
    let resourceType = currentTabType;
    let locationSelectId = 'locationFilter'; // Default (Room/Desk)
    let categorySelectId = 'categoryFilter'; // Default (Room/Desk)

    if (currentTabType === 'car') {
        resourceType = 'seat'; // Map 'car' tab to 'seat' resource
        // Specific IDs for Car Seat View (nasa HTML mo ito)
        // Note: Kailangan nating lagyan ng ID ang mga select sa HTML mamaya
        locationSelectId = 'carLocationFilter'; 
        categorySelectId = 'carRouteFilter'; 
    } else if (currentTabType === 'vehicle') {
        // Specific IDs for Vehicle View
        locationSelectId = 'vehicleLocationFilter';
        categorySelectId = 'vehicleTypeFilter';
    }

    const locationSelect = document.getElementById(locationSelectId);
    const categorySelect = document.getElementById(categorySelectId);
    
    // Kung wala ang elements (e.g. hidden or wrong ID), stop.
    if (!locationSelect || !categorySelect) return;

    // 2. Filter resources by the current type
    const currentResources = window.allResourcesData.filter(r => r.type.toLowerCase() === resourceType);

    // 3. Extract unique Locations and Categories
    const uniqueLocations = new Set(currentResources.map(r => r.location).filter(l => l));
    const uniqueCategories = new Set(currentResources.map(r => r.category).filter(c => c));

    // 4. Populate Location Filter
    locationSelect.innerHTML = '<option>All Locations</option>'; 
    uniqueLocations.forEach(loc => {
        const option = document.createElement('option');
        option.value = loc;
        option.textContent = loc;
        locationSelect.appendChild(option);
    });

    // 5. Populate Category Filter
    // Note: Sa Vehicle/Car, ang "Category" ay ginagamit natin as "Type" o "Route"
    const allText = (currentTabType === 'car') ? 'All Services' : (currentTabType === 'vehicle') ? 'All Types' : 'All Categories';
    categorySelect.innerHTML = `<option>${allText}</option>`;
    
    uniqueCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
    });
    
    // 6. Remove old listeners (clone node technique) to prevent duplicates
    // Ito ay quick hack para ma-reset ang event listeners
    const newLocSelect = locationSelect.cloneNode(true);
    const newCatSelect = categorySelect.cloneNode(true);
    locationSelect.parentNode.replaceChild(newLocSelect, locationSelect);
    categorySelect.parentNode.replaceChild(newCatSelect, categorySelect);

    // 7. Add NEW Listeners
    newLocSelect.onchange = () => renderUserResourceView(window.allResourcesData, currentTabType);
    newCatSelect.onchange = () => {
        renderUserResourceView(window.allResourcesData, currentTabType);
        // Update layout only for Room/Desk
        if (currentTabType === 'room' || currentTabType === 'desk') {
            updateRightPanelLayout(currentTabType, newCatSelect.value);
        }
    };
// 8. NEW FIX: Initial Right Panel Layout Load (ITO ANG IDINAGDAG)
    if (currentTabType === 'room' || currentTabType === 'desk') {
        const initialCategory = newCatSelect.value; // Should be "All Categories" or first option
        updateRightPanelLayout(currentTabType, initialCategory);
    }
}
  
/**
 * Updates the Right Panel with the Floor Plan Image, Markers, Legend, and Hover Tooltips.
 */
function updateRightPanelLayout(currentTabType, selectedCategory) {
    const rightPanel = document.getElementById('rightPanel');
    const titleEl = document.getElementById('layoutTitle');
    const subtitleEl = document.getElementById('layoutSubtitle');

    // Update Titles
    if (titleEl) titleEl.textContent = `Interactive Layout (${selectedCategory})`;
    if (subtitleEl) subtitleEl.textContent = 'View real-time availability on the map.';

    // 1. Kung Walang Image o Category
    if (selectedCategory === 'All Categories' || !selectedCategory) {
        rightPanel.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                <div class="layout-icon" style="font-size: 60px; color: #9CA3AF; margin-bottom: 10px;"></div>
                <h3 style="margin:0; color:#374151;">${tabContents[currentTabType].title}</h3>
                <p style="margin:0; color:#6B7280; font-size:14px;">${tabContents[currentTabType].subtitle}</p>
            </div>
        `;
        // Tiyakin na hindi tatawagin ang initZoomPan kung walang map
        return; 
    }

    // 2. Hanapin ang Floor Plan Data
    const type = (currentTabType === 'room') ? 'room' : 'desk'; 
    const floorPlan = window.allFloorPlansData.find(plan => 
        plan.type === type && plan.categoryName === selectedCategory
    );

    // 3. Kung May Image
    if (floorPlan && floorPlan.imageUrl && floorPlan.imageUrl !== 'Upload Error') {
        
        // A. I-parse ang Layout Data (JSON string to Object)
        let layoutMap = {};
        try {
            layoutMap = JSON.parse(floorPlan.layoutData || '{}');
        } catch (e) {
            console.error("Error parsing layout data", e);
        }

        // B. Buuin ang Markers HTML
        let markersHtml = '';
        
        // Loop sa bawat naka-save na marker
        for (const [resourceName, coords] of Object.entries(layoutMap)) {
            // Hanapin ang tunay na status ng resource na ito
            const resource = window.allResourcesData.find(r => r.name === resourceName);
            
            let dotClass = 'dot-available'; // Default Green
            let tooltipHtml = ''; // Default walang tooltip
            
            if (resource) {
                // Check status logic
                if (resource.status === 'In Use') {
                    dotClass = 'dot-occupied'; // Red Blinking

                    // --- NEW: Tooltip Logic ---
                    // Kung may reservation, gawan ng HTML para sa tooltip details
                    if (resource.currentReservation) {
                        tooltipHtml = `
                            <div class="fp-tooltip">
                                <div style="font-weight:bold; color: #ff8a80; margin-bottom: 3px;">In Use</div>
                                <div> ${resource.currentReservation.reservedBy}</div>
                                <div> Until ${resource.currentReservation.endTime}</div>
                            </div>
                        `;
                    }
                    // --------------------------

                } else if (resource.requiresApproval === 'Yes' && resource.status !== 'Available') {
                    dotClass = 'dot-approval'; 
                }
            } else {
                // Kung may marker sa map pero wala sa resource list (deleted resource)
                continue; 
            }

            // Create Marker HTML (Added tooltipHtml inside)
            markersHtml += `
                <div class="fp-viewer-marker" style="left: ${coords.x}; top: ${coords.y};">
                    ${tooltipHtml} <!-- Dito lalabas ang popup details -->
                    <div class="fp-viewer-dot ${dotClass}"></div>
                    <div class="fp-viewer-label">${resourceName}</div>
                </div>
            `;
        }

        // C. I-render ang Image + Markers + Legend
       rightPanel.innerHTML = `
            <h2 class="fp-outside-title">Interactive Layout (${selectedCategory})</h2>
            
            <!-- Container -->
            <div class="fp-white-box" id="mapContainer">
                
                <!-- Wrapper (Image + Markers + Legend) -->
                <div class="fp-inner-wrapper" id="mapContent" style="position: relative;">
                    
                    <!-- 1. The Image -->
                    <img src="${floorPlan.imageUrl}" class="fp-image-tag" alt="Floor Plan"> 
                    
                    <!-- 2. The Green/Red Dots -->
                    ${markersHtml} 

                    <!-- 3. THE LEGEND (Inilipat sa loob para dumikit sa photo) -->
                    <div class="fp-legend">
                        <div class="legend-item">
                            <div class="legend-dot l-green"></div>
                            <span class="legend-text">Available</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot l-red"></div>
                            <span class="legend-text">In Use</span>
                        </div>
                    </div>

                    <!-- 4. ZOOM CONTROLS (Manual Buttons for Pan/Zoom) -->
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomMap(0.2)">+</button>
                        <button class="zoom-btn" onclick="zoomMap(-0.2)">-</button>
                        <button class="zoom-btn" onclick="resetMap()" style="font-size: 14px;"></button>
                    </div>

                </div>
            </div>
        `;
        
        // KRITIKAL: I-initialize ang drag/pan/zoom
        initZoomPan();

    } else {
        // Fallback kung walang image
        rightPanel.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                <div class="layout-icon" style="font-size: 60px; color: #9CA3AF; margin-bottom: 10px;"></div>
                <h3 style="margin:0; color:#374151;">${selectedCategory} Layout</h3>
                <p style="margin:0; color:#6B7280; font-size:14px;">No floor plan image uploaded yet.</p>
            </div>
        `;
    }
}
  // ***************************************************************
  // END OF NEW FILTER LOGIC
  // ***************************************************************


  // ***************************************************************
  // NEW: RESERVATION LISTING & CANCEL LOGIC
  // ***************************************************************

  /**
   * Helper function to create a single reservation card for My Reservations view.
   */
  function createReservationCard(reservation) {
    const card = document.createElement('div');
    card.className = 'reservation-card'; 

    // Determine the status tag class
    let statusClass = reservation.approvalStatus.toLowerCase();
    
    // Determine the status DISPLAY TEXT
    let statusDisplay = '';

    if (reservation.status === 'Cancelled' && reservation.approvalStatus !== 'Rejected') {
        // Case 1: Cancelled by Requester (Col A = Cancelled, Col J = Cancelled/Pending)
        statusDisplay = 'Cancelled';
        statusClass = 'cancelled';
    } else if (reservation.approvalStatus === 'Rejected') {
        // Case 2: Rejected by Approver (Col J = Rejected)
        statusDisplay = 'Rejected';
        statusClass = 'cancelled'; // Re-use 'cancelled' style (red)
    } else if (reservation.approvalStatus === 'Pending') {
        // Case 3: Pending
        statusDisplay = 'Pending';
        statusClass = 'pending';
    } else if (reservation.approvalStatus === 'Approved') {
        // Case 4: Approved
        statusDisplay = 'Approved';
        statusClass = 'approved';
    } else {
        statusDisplay = reservation.status; // Fallback to main status
        statusClass = 'unknown';
    }
    
    // I-fix ang Date Formatting sa Display
    const dateDisplay = new Date(reservation.date + 'T00:00:00').toLocaleDateString('en-US', { 
        month: 'long', day: 'numeric', year: 'numeric' 
    });

    // Tiyakin na ang resourceType ay may Capital Letter
    const resourceTypeDisplay = reservation.resourceType.charAt(0).toUpperCase() + reservation.resourceType.slice(1);

    card.innerHTML = `
        <div class="reservation-header">
            <div>
                <div class="reservation-name">${reservation.resourceName}</div>
                <div class="reservation-type">${resourceTypeDisplay}</div>
            </div>
            <span class="status-tag ${statusClass}">${statusDisplay}</span>
        </div>
        <div class="reservation-details">
            <span><strong>Date:</strong> ${dateDisplay}</span>
            <span><strong>Time:</strong> ${reservation.startTime} - ${reservation.endTime}</span>
        </div>
        ${(reservation.status === 'Active' && reservation.approvalStatus !== 'Rejected') ? 
            `<button class="cancel-button-reservation" data-row-number="${reservation.rowNumber}">Cancel Reservation</button>` : 
            ''
        }
    `;

    return card;
}


  /**
   * Fetches and Renders the User's Reservations.
   */
  function loadMyReservations() {
      const listContainer = document.getElementById('reservationListContainer');
      const messageId = 'listOnlyMessage-temp'; // Gumamit ng temporary ID para hindi ma-conflict

      // 1. I-clear ang container at ilagay ang loading message
      listContainer.innerHTML = `<p id="${messageId}" style="text-align: center; color: #777; padding: 0;">Loading reservations...</p>`;
      const messageEl = document.getElementById(messageId);


      google.script.run
          .withSuccessHandler(function(response) {
              if (response.success) {
                  const reservations = response.reservations;
                  
                  if (reservations.length === 0) {
                      messageEl.textContent = tabContents['my-reservations'].subtitle; // 'You have no reservations yet.'
                      // Ang messageEl ay nasa loob pa rin ng listContainer
                      return;
                  }
                  
                  // 2. Kapag may data na, i-clear ang listContainer
                  listContainer.innerHTML = ''; 
                  
                  // Sort by Date (latest first)
                  reservations.sort((a, b) => new Date(b.date) - new Date(a.date));

                  reservations.forEach(reservation => {
                      listContainer.appendChild(createReservationCard(reservation));
                  });
                  
                  // 3. Add Event Listeners for Cancel Buttons
                  document.querySelectorAll('.cancel-button-reservation').forEach(button => {
                      button.addEventListener('click', function() {
                          const rowNumber = this.getAttribute('data-row-number');
                          confirmCancellation(rowNumber, this);
                      });
                  });

              } else {
                  // Error sa server
                  messageEl.textContent = `Error: ${response.message}`;
              }
          })
          .withFailureHandler(function(error) {
              // Error sa Google Script side
              messageEl.textContent = 'Server Error: ' + error.toString();
          })
          .getUsersReservations(currentUser.email); 
  }
/**
 * Helper function to create an Admin Reservation list item.
 */
function createAdminReservationListItem(reservation) {
    const item = document.createElement('div');
    item.className = 'reservation-list-item'; 
    
    // Determine the status tag class
    let statusClass = 'admin-' + reservation.approvalStatus.toLowerCase();
    let statusText = reservation.approvalStatus;
    
    // Logic for display status (matching the screenshot logic)
    if (reservation.status === 'Cancelled') {
        statusClass = 'admin-cancelled';
        statusText = 'Cancelled';
    } else if (reservation.approvalStatus === 'Rejected') {
         statusText = 'Rejected';
         statusClass = 'admin-rejected';
    } else if (reservation.approvalStatus === 'Pending') {
         statusText = 'Pending';
         statusClass = 'admin-pending';
    } else { // Approved
         statusText = 'Approved';
         statusClass = 'admin-approved';
    }
    
    // Resource Type in parentheses (Room, Desk, etc.)
    const resourceTypeDisplay = reservation.resourceType.charAt(0).toUpperCase() + reservation.resourceType.slice(1);
    
    // Format Time display: Date, Start Time - End Time
    const timeDisplay = `${reservation.date}, ${reservation.startTime} - ${reservation.endTime}`;
    
    // Action button: Only allow Cancel if not already Cancelled or Rejected
    const canCancel = reservation.status !== 'Cancelled' && reservation.approvalStatus !== 'Rejected';
    
    const actionsHTML = canCancel ? 
        `<button class="cancel-admin-btn" data-row-number="${reservation.rowNumber}">Cancel</button>` :
        `<span style="color:#777; font-size:12px;">N/A</span>`;

    item.innerHTML = `
        <span class="resource-col">${reservation.resourceName} (${resourceTypeDisplay})</span>
        <span class="user-col">${reservation.requesterName}</span>
        <span class="time-col">${timeDisplay}</span>
        <span class="status-col"><span class="status-tag ${statusClass}">${statusText}</span></span>
        <span class="actions-col">${actionsHTML}</span>
    `;

    return item;
}

/**
 * Renders the fetched reservations for the Admin view.
 */
function renderAdminReservations(reservations) {
    const listDiv = document.getElementById('adminReservationsList');
    listDiv.innerHTML = ''; // Clear previous content

    if (reservations.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">No reservations found.</p>';
        return;
    }

    // Sort by Date (latest first)
    reservations.sort((a, b) => {
        // Gumawa ng sortable date/time string: YYYYMMDDHHMM
        const timeA = a.date.replace(/\//g, '') + a.startTime.replace(/[^0-9]/g, '');
        const timeB = b.date.replace(/\//g, '') + b.startTime.replace(/[^0-9]/g, '');
        return timeB.localeCompare(timeA); // Descending (latest first)
    });

    reservations.forEach(res => {
        listDiv.appendChild(createAdminReservationListItem(res));
    });
    
    // Add Event Listeners for Cancel Buttons
    document.querySelectorAll('.cancel-admin-btn').forEach(button => {
        button.addEventListener('click', function() {
            const rowNumber = this.getAttribute('data-row-number');
            // Gagamitin natin ang updated confirmCancellation at ipapasa ang 'true' para sa Admin mode
            confirmCancellation(rowNumber, this, true); 
        });
    });
}

/**
 * Fetches and Renders all Reservations for Admin.
 */
/**
 * Fetches and Renders all Reservations for Admin (UPDATED).
 */
function loadAdminReservations() {
    const listDiv = document.getElementById('adminReservationsList');
    listDiv.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">Loading reservations...</p>';

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                // 1. SAVE RAW DATA TO GLOBAL VARIABLE
                allAdminReservationsData = response.reservations;
                
                // 2. APPLY INITIAL SORT & FILTER
                applyAdminFilters(); 
            } else {
                listDiv.innerHTML = `<p style="text-align: center; color: #e53935; padding: 20px;">Error loading reservations: ${response.message}</p>`;
            }
        })
        .withFailureHandler(function(error) {
            listDiv.innerHTML = `<p style="text-align: center; color: #e53935; padding: 20px;">Server Error: ${error.toString()}</p>`;
        })
        .getAllReservationsForAdmin(); 
}

/**
 * Opens a modal to confirm the cancellation (UPDATED to handle Admin mode and button reset).
 */
function confirmCancellation(rowNumber, button, isAdmin = false) { 
    if (confirm("Are you sure you want to cancel this reservation?")) {
        // Tiyakin na ang button text na ibabalik ay tama
        const originalButtonText = isAdmin ? 'Cancel' : 'Cancel Reservation'; 

        button.textContent = 'Cancelling...';
        button.disabled = true;
        
        google.script.run
            .withSuccessHandler(function(response) {
                // *** ITO ANG FIX: I-reset ang button kung sakaling mag-fail ang operation (kahit sa success handler) ***
                // Note: Gagamitin natin ang response.success para sa logic
                if (!response.success) {
                    button.textContent = originalButtonText; // Ibalik ang original text
                    button.disabled = false;
                }
                // ******************************************************************************

                handleCancellationResponse(response, isAdmin);
                
                // Update the success modal's OK button to reload the correct list
                const okButton = document.getElementById('successModal').querySelector('.modal-ok-button');
                if(okButton) {
                    okButton.onclick = function() {
                        document.getElementById('successModal').style.display='none';
                        // Ang listahan ay magre-reload LAMANG kung Successful ang cancellation
                        if (response.success) {
                            if (isAdmin) {
                                loadAdminReservations(); // Reload Admin list
                            } else {
                                loadMyReservations(); // Reload User list
                            }
                        }
                    };
                }
            })
            .withFailureHandler(function(error) {
                // Kapag nag-fail ang server call
                alert('Server Error: ' + error.toString());
                button.textContent = originalButtonText; // Ibalik ang original text
                button.disabled = false;
            })
            .cancelReservation(rowNumber);
    }
}

  /**
   * Handles the server response after cancellation.
   */
  function handleCancellationResponse(response, isAdmin = false) {
      // Re-enable all cancel buttons (if necessary) or let the reload handle it
      
      const modal = document.getElementById('successModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');
      
      // Default OK button style (adjust if needed)
      const okButton = modal.querySelector('.modal-ok-button');
      if(okButton) {
          okButton.style.backgroundColor = '#e53935'; 
          okButton.style.width = '80px';
      }

      if (response.success) {
          modalTitle.textContent = "Cancellation Success";
          modalMessage.textContent = response.message;
      } else {
          modalTitle.textContent = "Cancellation Error";
          modalMessage.textContent = response.message;
      }
      
      modal.style.display = 'flex';
      // Load ulit ang listahan pagkatapos ma-close ang modal
      okButton.onclick = function() {
          document.getElementById('successModal').style.display='none';
          if (response.success) {
              if (isAdmin) {
                  loadAdminReservations();
              } else {
                  loadMyReservations(); // Reload the list
              }
          }
      };
  }
  // ***************************************************************
  // END OF RESERVATION LISTING & CANCEL LOGIC
  // ***************************************************************


  // NEW: Function to hide all main view containers
// Function to hide all main view containers
function hideAllViews() {
    document.getElementById('resourceViewWrapper').style.display = 'none'; // Resource/Filter/Layout View
    document.getElementById('listOnlyView').style.display = 'none';      // My Reservations/Approvals View
    document.getElementById('profileView').style.display = 'none';        // Profile View
    document.getElementById('adminDashboardContainer').style.display = 'none'; // Admin View
    document.getElementById('helpView').style.display = 'none';           // <--- ETO NA YUNG DINAGDAG!
}

// Variable para sa Calendar Date Input
let currentCalendarDate = new Date();

/**
 * NEW: I-load ang calendar events para sa active tab at buwan.
 */
function loadCalendarAvailability() {
    // 1. Alamin ang kasalukuyang active tab at resource type
    const activeTab = document.querySelector('.nav-tab.active');
    if (!activeTab) return;
    const currentType = activeTab.getAttribute('data-item'); // room, desk, vehicle
    
    // Tiyakin na Room, Desk, o Vehicle lang ang may calendar
    if (currentType !== 'room' && currentType !== 'desk' && currentType !== 'car' && currentType !== 'vehicle') {
        document.getElementById('availabilityCalendarDisplay').style.display = 'none';
        return;
    }
    
    // UI Update: Show Loading
    const calendarView = document.getElementById('availabilityCalendarView');
    calendarView.innerHTML = '<p style="text-align: center; color: #777;">Loading reservations...</p>';

    // 2. Kumuha ng lahat ng araw sa kasalukuyang buwan
    const today = new Date();
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    // Gumawa ng array ng lahat ng petsa sa buwan (YYYY-MM-DD format)
    const datesToFetch = [];
    let date = new Date(year, month, 1);
    while (date.getMonth() === month) {
        // Fetch only dates from the current month
        datesToFetch.push(date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0'));
        date.setDate(date.getDate() + 1);
    }
    
    // Dahil sa pagiging simple ng Apps Script, hindi tayo pwedeng mag-fetch ng 30 araw nang sabay-sabay.
    // Gagamitin natin ang unang araw ng buwan bilang target fetch date, at ang backend na lang ang magre-return ng data.
    // Maglalagay na lang tayo ng MOCK-UP data sa ngayon.
    
    // 3. (MOCK-UP ONLY): Mag-render ng grid habang naghihintay.
    renderCalendarGrid(); 

    // MOCK-UP: Server Call for the entire month's data
    // Dito dapat ang tunay na server call (pero gagamitin lang natin for simplicity)
    const targetDate = datesToFetch[0]; // Fetch for the first day of the month

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                // response.events ay dapat maging isang malaking array ng events para sa buong buwan.
                renderCalendarGrid(response.events);
            } else {
                renderCalendarGrid([]);
                console.error(`Error fetching calendar events: ${response.message}`);
            }
        })
        .withFailureHandler(function(error) {
            renderCalendarGrid([]);
            console.error(`Server Error fetching calendar events: ${error.toString()}`);
        })
        // NOTE: Pinalitan ang server function para mag-fetch ng entire month data.
        // Dapat baguhin din ang server function na ito (getReservationsForMonth) sa Apps Script.
        // Pero sa ngayon, gagamitin na lang natin ang dating function para gumana ang grid.
        .getReservationsForCalendar(currentType, targetDate); 
}
function renderCalendarGrid(allEvents = []) {
    const calendarView = document.getElementById('availabilityCalendarView');
    const today = new Date();
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    // 1. Month/Year Header
    const monthName = currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    const headerHtml = `
        <div class="full-calendar-mock">
            <div class="calendar-header-mock">
                <span class="nav-arrow-mock" onclick="navigateCalendar(-1)">&lt;</span>
                <span id="currentMonthYear">${monthName}</span>
                <span class="nav-arrow-mock" onclick="navigateCalendar(1)">&gt;</span>
            </div>
    `;

    // 2. Day Headers
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    let gridHtml = `<div class="calendar-grid-mock">`;
    days.forEach(day => {
        gridHtml += `<div class="day-header-mock">${day}</div>`;
    });

    // 3. Calendar Body
    
    // A. Start Day Logic (Monday = 1, Sunday = 0)
    let firstDayOfMonth = new Date(year, month, 1).getDay();
    // Re-map Sunday (0) to 7, then Mon=1, Sun=7. Subtract 1 to get array index (Mon=0, Sun=6)
    let startDayIndex = (firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1); 
    
    // B. Last Day of Previous Month
    const lastDayOfPrevMonth = new Date(year, month, 0).getDate();
    
    // C. Days in Current Month
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    let dateCounter = 1;
    let nextMonthDay = 1;
    let totalCells = 42; // Always render 6 weeks (6 * 7)

    for (let i = 0; i < totalCells; i++) {
        let cellHtml = '';
        let cellClass = 'day-cell-mock';
        let dayNum = '';
        let dateKey = ''; // YYYY-MM-DD

        if (i < startDayIndex) {
            // Previous Month's Days
            dayNum = lastDayOfPrevMonth - startDayIndex + i + 1;
            cellClass += ' other-month';
            // Hindi kukunin ang events ng nakaraang buwan para sa performance
        } else if (dateCounter <= daysInMonth) {
            // Current Month's Days
            dayNum = dateCounter;
            // Check if today
            if (dateCounter === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                cellClass += ' today-mock';
            }
            
            // Format Date Key for filtering
            dateKey = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(dateCounter).padStart(2, '0');
            
            // Filter events for this specific day
            const eventsForDay = allEvents.filter(e => e.date === dateKey);

            // Add events to cell
            if (eventsForDay.length > 0) {
                eventsForDay.forEach(event => {
                    const timeDisplay = event.time.split(' - ')[0].replace(/:\d{2}\s?(a|p)m/i, ''); // Just start time
                    cellHtml += `<div class="event-indicator-mock" data-events='${JSON.stringify(eventsForDay)}'>${timeDisplay} ${event.resourceName}</div>`;
                });
            }
            
            dateCounter++;

        } else {
            // Next Month's Days
            dayNum = nextMonthDay;
            cellClass += ' other-month';
            nextMonthDay++;
        }
        
        // Final Cell HTML
        gridHtml += `
            <div class="${cellClass}" data-date-key="${dateKey}" onclick="openDayEventsModal('${dateKey}', this)">
                <span class="day-number-mock">${dayNum}</span>
                ${cellHtml}
            </div>
        `;
        
        // Break out of the loop if we've rendered enough cells for the current month.
        if (dateCounter > daysInMonth && nextMonthDay > 7) { 
            // Magtuloy sa 6 na linggo para pantay ang UI.
        }
    }
    
    gridHtml += `</div></div>`; // Close grid and full-calendar-mock

    calendarView.innerHTML = headerHtml + gridHtml;
    
    // Set up the event listener for event cells
    document.querySelectorAll('.day-cell-mock').forEach(cell => {
        // Tiyakin lang na ang onclick ay gagamit ng JSON.parse para mag-display ng detalye.
        // Hindi na kailangan ng event listener dito dahil may onclick na sa cell.
    });
}

// C. NEW Navigation Logic
function navigateCalendar(direction) {
    // 1. Baguhin ang buwan
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
    
    // 2. Kumuha ng bagong data at i-render (Dahil sa mock-up, tatawagin lang natin ang load function)
    loadCalendarAvailability();
}

// D. NEW Modal Logic
function openDayEventsModal(dateKey, cellElement) {
    if (!dateKey) return; // Ignore previous/next month days

    const modal = document.getElementById('dayEventsModal');
    const title = document.getElementById('dayEventsTitle');
    const list = document.getElementById('dayEventsList');
    
    // 1. Format Title
    const dateObj = new Date(dateKey);
    const dateDisplay = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    title.textContent = `Reservations for ${dateDisplay}`;

    // 2. Kunin ang Events (Dahil sa mock-up, kailangan nating i-parse ang data sa DOM)
    let allEventsForDay = [];
    const eventIndicators = cellElement.querySelectorAll('.event-indicator-mock');
    
    if (eventIndicators.length > 0) {
         // I-assume natin na ang data-events attribute ay naka-JSON.stringify (pero dahil sa mock up, kukunin na lang natin ang huling item)
         try {
             // Kukunin natin ang data mula sa unang event indicator
             const eventsJson = eventIndicators[0].getAttribute('data-events');
             allEventsForDay = JSON.parse(eventsJson || '[]');
         } catch(e) {
             console.error("Error parsing events from cell:", e);
             allEventsForDay = [];
         }
    }

    // 3. Render Events
    list.innerHTML = '';
    if (allEventsForDay.length === 0) {
        list.innerHTML = '<p style="color: #777; text-align: center;">No reservations for this day.</p>';
    } else {
        // Sort by Time
        allEventsForDay.sort((a, b) => a.time.localeCompare(b.time));
        
        allEventsForDay.forEach(event => {
            const item = document.createElement('div');
            item.className = 'calendar-event'; // Reuse existing style
            
            const timeDisplay = event.time.replace(/:\d{2}\s?(a|p)m/i, ''); // Simple time
            const seatDetail = event.seatDetail ? event.seatDetail : '';

            item.innerHTML = `
                <div class="event-details" style="display:flex; flex-direction:column; align-items:flex-start;">
                    <span class="event-name" style="color:#e53935;">${event.resourceName}</span>
                    <span style="font-size: 12px; color: #777;">Req: ${event.requester} ${seatDetail}</span>
                </div>
                <span class="event-time" style="font-size: 13px;">${event.time}</span>
            `;
            list.appendChild(item);
        });
    }

    // 4. Show Modal
    modal.style.display = 'flex';
}


function toggleCalendarAvailability() {
    const calendarDisplay = document.getElementById('availabilityCalendarDisplay');
    const button = document.getElementById('calendarToggleButton');
    const isHidden = calendarDisplay.style.display === 'none';
    
    if (isHidden) {
        calendarDisplay.style.display = 'block';
        // KRITIKAL: Gumamit ng span para mag-apply ang flex/gap style sa button
        button.innerHTML = '<span> Hide Calendar</span>'; 
        loadCalendarAvailability(); 
    } else {
        calendarDisplay.style.display = 'none';
        // KRITIKAL: Gumamit ng span
        button.innerHTML = '<span> Show Calendar</span>'; 
    }
}

/**
 * NEW: Renders the list of events (reservations) from the server response.
 */
function renderCalendarEvents(events) {
    const calendarView = document.getElementById('availabilityCalendarView');
    calendarView.innerHTML = '';
    
    if (events.length === 0) {
        calendarView.innerHTML = '<p style="text-align: center; color: #777;">No resources reserved for this day.</p>';
        return;
    }
    
    // Sort by Start Time (Kailangan ang oras sa 24-hour format para tama ang sorting)
    events.sort((a, b) => {
        const timeA = a.time.split(' - ')[0].replace(/[^0-9:]/g, ''); 
        const timeB = b.time.split(' - ')[0].replace(/[^0-9:]/g, '');
        return timeA.localeCompare(timeB);
    });

    // Group by Resource Name
    const groupedEvents = events.reduce((acc, event) => {
        if (!acc[event.resourceName]) {
            acc[event.resourceName] = [];
        }
        acc[event.resourceName].push(event);
        return acc;
    }, {});
    
    // Render HTML List (Simple collapsible/list view)
    const listContainer = document.createElement('div');
    listContainer.className = 'calendar-event-list';

    for (const resourceName in groupedEvents) {
        const resourceHeader = document.createElement('div');
        resourceHeader.style.cssText = 'font-weight: bold; margin-top: 10px; padding: 5px 0; border-bottom: 1px solid #ddd; color: #333; font-size: 14px;';
        resourceHeader.textContent = resourceName;
        listContainer.appendChild(resourceHeader);

        groupedEvents[resourceName].forEach(event => {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'calendar-event';
            
            const eventDetails = document.createElement('div');
            eventDetails.className = 'event-details';
            
            // I-display ang Seat Detail kung meron
            const detailText = event.seatDetail ? ` (${event.seatDetail})` : '';

            eventDetails.innerHTML = `<span class="event-name">${resourceName}</span>${detailText} | <span style="font-size: 12px; color: #333;">Req: ${event.requester}</span>`;

            eventDiv.innerHTML = `
                ${eventDetails.outerHTML}
                <span class="event-time">${event.time}</span>
            `;
            listContainer.appendChild(eventDiv);
        });
    }

    calendarView.appendChild(listContainer);
}

function updateContent(itemType) {
    
    // 1. I-standardize ang visibility at i-clear ang loading states
    hideAllViews(); // ITAGO LAHAT MUNA
    
    // Close dropdown when changing views
    document.getElementById('userDropdownMenu').classList.remove('visible');
    
    // I-remove ang 'active' class sa LAHAT ng nav tabs
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    
    // I-set ang 'active' class sa tab
    const navTab = document.querySelector(`.nav-tab[data-item="${itemType}"]`);
    if (navTab) {
        navTab.classList.add('active');
    }

    // --- NEW FIX START: Calendar Toggle Reset (Para gumana ang Show/Hide) ---
    const calendarDisplay = document.getElementById('availabilityCalendarDisplay');
    const calendarToggleBtn = document.getElementById('calendarToggleButton');

    // Default: Itago ang calendar display box at ang toggle button
    if (calendarDisplay) calendarDisplay.style.display = 'none';
    if (calendarToggleBtn) calendarToggleBtn.style.display = 'none';

    // -----------------------------------------------------
    // LOGIC FOR ADMIN VIEW
    // -----------------------------------------------------
    if (itemType === 'admin-dashboard') {
        document.getElementById('adminDashboardContainer').style.display = 'flex';
        
        // ... (existing admin logic) ...
        document.querySelectorAll('.admin-nav-item').forEach(item => item.classList.remove('active'));
        const adminUsersLink = document.getElementById('adminUsersLink');
        if(adminUsersLink) adminUsersLink.classList.add('active');
        document.getElementById('adminUsersView').style.display = 'block';
        document.getElementById('adminSpacesView').style.display = 'none';

        const usersListDiv = document.getElementById('usersList');
        usersListDiv.textContent = 'Loading users...'; 
        
        google.script.run
            .withSuccessHandler(function(response) {
                if (response.success) {
                    renderUserList(response.users); 
                } else {
                    usersListDiv.textContent = response.message;
                }
            })
            .withFailureHandler(function(error) {
                usersListDiv.textContent = 'Failed to load users: ' + error;
            })
            .getAllUsers(currentUser.email);
        
        // <<< FIX 1: Tiyakin na naka-reset ang calendar state sa admin view >>>
        // Note: Hindi na kailangan ang dating 'availabilityCalendarContainer'
        // dito, naka-disable na ang button sa ibaba ng function.
        // <<< END OF FIX 1 >>>

        return;
    }
    
    // -----------------------------------------------------
    // LOGIC FOR USER/PUBLIC VIEWS
    // -----------------------------------------------------
    
    const content = tabContents[itemType];
    if (!content) return; 

    // --- Specific Content View Logic ---
    if (itemType === 'my-reservations' || itemType === 'approvals') {
        
        document.getElementById('listOnlyView').style.display = 'block';
        document.getElementById('listOnlyTitle').textContent = content.title;
        
        const listContainer = document.getElementById('reservationListContainer');
        listContainer.innerHTML = '<p id="listOnlyMessage-temp" style="text-align: center; color: #777; padding: 0;">Loading...</p>';
        
        if (itemType === 'my-reservations') {
            loadMyReservations();
        } else if (itemType === 'approvals') {
            loadApprovals();
        } else {
            document.getElementById('listOnlyMessage-temp').textContent = content.subtitle;
        }

        // <<< FIX 2: Tiyakin na naka-reset ang calendar state sa list-only view >>>
        // Note: Hindi na kailangan ang dating 'availabilityCalendarContainer'
        // dito, naka-disable na ang button sa ibaba ng function.
        // <<< END OF FIX 2 >>>


    } else if (itemType === 'profile') { 
        document.getElementById('profileView').style.display = 'block';
        
        // <<< FIX 3: Tiyakin na naka-reset ang calendar state sa profile view >>>
        // Note: Hindi na kailangan ang dating 'availabilityCalendarContainer'
        // dito, naka-disable na ang button sa ibaba ng function.
        // <<< END OF FIX 3 >>>
        
    } else if (itemType === 'help') { 
        // <--- BAGONG BLOCK PARA SA HELP CENTER ---
        document.getElementById('helpView').style.display = 'block';
        // Tiyakin na ang mga accordion ay naka-set sa default state (maxHeight: null)
        document.querySelectorAll('.faq-content').forEach(content => {
             content.style.maxHeight = null;
        });
        document.querySelectorAll('.faq-item').forEach(item => {
             item.classList.remove('active');
        });
        // ---------------------------------------
        
        // <<< FIX 4: Tiyakin na naka-reset ang calendar state sa help view >>>
        // Note: Hindi na kailangan ang dating 'availabilityCalendarContainer'
        // dito, naka-disable na ang button sa ibaba ng function.
        // <<< END OF FIX 4 >>>


     } else if (itemType === 'room' || itemType === 'desk' || itemType === 'car' || itemType === 'vehicle') {
        
        document.getElementById('resourceViewWrapper').style.display = 'flex';
        
        const rightPanel = document.getElementById('rightPanel');
        const leftPanel = document.getElementById('leftPanel');
        
        // --- NEW LOGIC: Toggle Centered Mode for Car/Vehicle ---
        if (itemType === 'car' || itemType === 'vehicle') {
            leftPanel.classList.add('centered-view-mode'); // Add centering class
        } else {
            leftPanel.classList.remove('centered-view-mode'); // Remove for Room/Desk
        }

        if (content.hasLayout) {
            rightPanel.style.display = 'flex';
            leftPanel.style.flex = '7'; 
            rightPanel.style.height = 'calc(100vh - 122px)'; 
            
            // --- FIX START: Check if elements exist before setting text ---
            const titleEl = document.getElementById('layoutTitle');
            const subtitleEl = document.getElementById('layoutSubtitle');

            if (titleEl) {
                titleEl.textContent = content.title;
            }
            if (subtitleEl) {
                subtitleEl.textContent = content.subtitle;
            }
            // --- FIX END ---

        } else {
            rightPanel.style.display = 'none';
            leftPanel.style.flex = '1'; 
        }
        
        document.getElementById('generalFilters').style.display = 'none';
        document.getElementById('carSeatView').style.display = 'none';
        document.getElementById('vehicleView').style.display = 'none';
        
        if(content.customView) {
            document.getElementById(content.customView).style.display = (content.customView === 'generalFilters') ? 'flex' : 'block';
        }
        
        // >>> PAGBABAGO DITO: I-load lang ang cards kung HINDI 'vehicle' <<<
        if (itemType !== 'vehicle') {
            document.getElementById('itemListArea').style.display = 'grid'; 
            loadResources(itemType); // Load Resource Cards
        } else {
            // Itago ang Item List Area para sa Vehicle Request Form
            document.getElementById('itemListArea').style.display = 'none';
            // Set Requester Email sa hidden field
            document.getElementById('reqRequesterEmail').value = currentUser.email; 
            // Set Min/Max Date limits
            setMaxDateLimit();
        }
        
        // <<< UPDATED: Calendar Toggle Button Logic >>>
        if (calendarToggleBtn) {
            // Tiyakin na ang button ay lalabas sa Room, Desk, Car, at Vehicle
            if (itemType === 'room' || itemType === 'desk' || itemType === 'car' || itemType === 'vehicle') {
                calendarToggleBtn.style.display = 'block'; 
                calendarToggleBtn.innerHTML = '<span> Show Calendar</span>'; // I-reset ang text
            } else {
                calendarToggleBtn.style.display = 'none'; 
            }
        }
        // <<< END OF UPDATED CALENDAR TOGGLE LOGIC >>>
    }
}
// ... (rest of the JavaScript code) ...
  
  // Event listener para sa dropdown toggle
  document.getElementById('userDropdownToggle').addEventListener('click', function(e) { e.stopPropagation(); toggleDropdown(); });
  // Event listener para sa mga tab
  document.getElementById('navTabs').addEventListener('click', function(e) {
      if (e.target.classList.contains('nav-tab')) {
          const itemType = e.target.getAttribute('data-item');
          updateContent(itemType);
      }
  });

  
  // NEW: Event listener para buksan ang Add New User Modal (Inilabas na sa loob ng updateContent)
  document.querySelector('.add-new-user-btn').addEventListener('click', function() {
      document.getElementById('addUserModal').style.display = 'flex';
      document.getElementById('addNewUserForm').reset();
  });
  
  // Close dropdown kapag nag-click sa labas
  window.addEventListener('click', function(e) {
      const dropdown = document.getElementById('userDropdownMenu');
      if (dropdown.classList.contains('visible') && !document.getElementById('userDropdownToggle').contains(e.target)) {
          dropdown.classList.remove('visible');
      }
  });
  
  // Handle Logout click
  document.getElementById('logoutLink').addEventListener('click', function() {
      document.getElementById('dashboardView').style.display = 'none';
      document.getElementById('loginView').style.display = 'block';
      
      document.getElementById('loginForm').reset();
      var signInBtn = document.getElementById('loginForm').querySelector('button');
      signInBtn.textContent = 'Sign In';
      signInBtn.disabled = false;
      
      currentUser = { email: '', role: '' };
  });
  
  // Handle "Save Changes" in Profile Form
  document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = e.target;
      const currentPass = form.currentPassword.value;
      const newPass = form.newPassword.value;
      const confirmPass = form.confirmNewPassword.value;

      // Client-side Validation
     if (newPass.length < 6) { 
    showErrorModal('Validation Error', 'New Password must be at least 6 characters long.'); 
    return; 
}
if (newPass !== confirmPass) { 
    showErrorModal('Validation Error', 'New Password and Confirm New Password do not match.'); 
    return; 
}
      
      // Disable button and change text
      const saveBtn = form.querySelector('.save-changes-button');
      saveBtn.textContent = 'Saving...';
      saveBtn.disabled = true;

      // Call Server Function
      google.script.run
          .withSuccessHandler(handlePasswordUpdateResponse)
          .withFailureHandler(function(error) {
              const modal = document.getElementById('successModal');
              document.getElementById('modalTitle').textContent = "Server Error";
              document.getElementById('modalMessage').textContent = error.toString();
              modal.style.display = 'flex';
              saveBtn.textContent = 'Save Changes';
              saveBtn.disabled = false;
          })
          .updatePassword(currentUser.email, currentPass, newPass); 
  });

  // Handle Server Response for Password Update
  function handlePasswordUpdateResponse(response) {
      const saveBtn = document.getElementById('changePasswordForm').querySelector('.save-changes-button');
      saveBtn.textContent = 'Save Changes';
      saveBtn.disabled = false;
      
      const modal = document.getElementById('successModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');
      
      if (response.success) {
          modalTitle.textContent = "Success";
          modalMessage.textContent = "Password changed successfully.";
          document.getElementById('changePasswordForm').reset();
      } else {
          modalTitle.textContent = "Error";
          modalMessage.textContent = response.message;
      }
      modal.style.display = 'flex';
  }

  // NEW: Handle "Add New User" Form Submission (UPDATED)
  document.getElementById('editUserForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = e.target;
      
      // Get Values
      const firstName = form.firstName.value.trim();
      const middleName = form.middleName.value.trim();
      const lastName = form.lastName.value.trim();
      const newEmail = form.newEmail.value.trim();
      const newPassword = form.newPassword.value;
      const confirmPassword = form.confirmPassword.value;
      
      // Validation
    if (!firstName || !lastName) { 
    showErrorModal('Validation Error', 'First Name and Last Name are required.'); 
    return; 
}
      
     if (newPassword && newPassword.length > 0) {
    if (newPassword.length < 6) { 
        showErrorModal('Validation Error', 'New Password must be at least 6 characters long.'); 
        return; 
    }
    if (newPassword !== confirmPassword) { 
        showErrorModal('Validation Error', 'New Password and Confirmation do not match.'); 
        return; 
    }
}

     const roles = Array.from(form.querySelectorAll('input[name="editRoles"]:checked')).map(cb => cb.value);
if (roles.length === 0) { 
    showErrorModal('Validation Error', 'Please select at least one role.'); 
    return; 
}


      // Disable button
      const saveBtn = form.querySelector('.add-user-button');
      saveBtn.textContent = 'Saving...';
      saveBtn.disabled = true;

      // Call Server Function
      google.script.run
          .withSuccessHandler(handleUpdateUserResponse)
          .withFailureHandler(function(error) {
              alert('Server Error: ' + error);
              saveBtn.textContent = 'Save Changes';
              saveBtn.disabled = false;
          })
          .updateUserDetails({
              originalEmail: form.originalEmail.value,
              newEmail: newEmail,
              newPassword: newPassword,
              roles: roles,
              firstName: firstName,   // Pass separately
              middleName: middleName, // Pass separately
              lastName: lastName,     // Pass separately
              businessUnit: form.businessUnit.value
          });
  });

  // NEW: Handle Server Response for Add New User
  function handleAddNewUserResponse(response) {
      const addUserBtn = document.getElementById('addNewUserForm').querySelector('.add-user-button');
      addUserBtn.textContent = 'Add User';
      addUserBtn.disabled = false;

      const modal = document.getElementById('successModal');
      const addUserModal = document.getElementById('addUserModal');

      if (response.success) {
          // I-close ang Add User Modal
          addUserModal.style.display = 'none';
          
          // Ipakita ang Success Modal
          document.getElementById('modalTitle').textContent = "Success";
          document.getElementById('modalMessage').textContent = "User added successfully. Refreshing list...";
          modal.style.display = 'flex';
          
          // I-reload ang user list
          updateContent('admin-dashboard'); 
      } else {
          // Ipakita ang Error sa Success Modal
          document.getElementById('modalTitle').textContent = "Error";
          document.getElementById('modalMessage').textContent = response.message;
          modal.style.display = 'flex';
      }
  }
  
  // NEW/RESTORED: EDIT RESOURCE MODAL submission handler 
document.getElementById('editResourceForm').addEventListener('submit', function(e) {
    e.preventDefault(); 
    const form = e.target;
    const type = form.type.value;
    
    // 1. GATHER DATA
    const newPassword = form.newPassword ? form.newPassword.value : '';
    const confirmPassword = form.confirmPassword ? form.confirmPassword.value : '';
    
    // 2. VALIDATION
    if (!form.name.value.trim()) {
        showErrorModal('Validation Error', 'Name/Description is required.');
        return;
    }
    
    if (newPassword && newPassword.length > 0) {
        if (newPassword.length < 6) { 
            showErrorModal('Validation Error', 'New Password must be at least 6 characters long.'); 
            return; 
        }
        if (newPassword !== confirmPassword) { 
            showErrorModal('Validation Error', 'New Password and Confirmation do not match.'); 
            return; 
        }
    }
    
    // Vehicle Validation
    if (type === 'vehicle') {
        const model = document.getElementById('editResourceModel').value.trim();
        const plate = document.getElementById('editResourcePlateNumber').value.trim();
        
        if (!model) { showErrorModal('Validation Error', 'Model is required for Vehicle.'); return; }
        if (!plate) { showErrorModal('Validation Error', 'Plate Number is required for Vehicle.'); return; }
    }
    
    // Seat Validation
    if (type === 'seat' || type === 'car seat') {
        const seatCount = document.getElementById('editResourceSeatCount').value;
        if (!seatCount || parseInt(seatCount) < 1) {
            showErrorModal('Validation Error', 'Seat Count must be at least 1.');
            return;
        }
        
        // Note: Confirm dialog stays as native confirm because it requires Yes/No logic
        const layoutData = document.getElementById('editSeatLayoutData').value;
        if (!layoutData || layoutData === '{}') {
            if (!confirm("You haven't customized the Seat Layout. The default layout will be used. Continue?")) {
                return;
            }
        }
    }

    // 3. SUBMIT
    const submitBtn = form.querySelector('.add-user-button');
    submitBtn.textContent = 'Saving...';
    submitBtn.disabled = true;

    google.script.run
        .withSuccessHandler(function(response) {
            document.getElementById('editResourceModal').style.display = 'none'; 
            submitBtn.textContent = 'Save Changes';
            submitBtn.disabled = false;
            
            // Reuse success modal logic directly here for custom styling if needed
            const modal = document.getElementById('successModal');
            document.getElementById('modalTitle').textContent = response.success ? "Success" : "Error";
            document.getElementById('modalMessage').textContent = response.message;
            
            const okBtn = modal.querySelector('.modal-ok-button');
            if(okBtn) {
                // Green for success, Red for error
                okBtn.style.backgroundColor = response.success ? '#4CAF50' : '#e53935';
                okBtn.onclick = function() {
                    document.getElementById('successModal').style.display = 'none';
                    if (response.success) {
                        // Clear inputs logic...
                        const vFile = document.querySelector('#editResourceForm input[name="vehiclePhoto"]');
                        if(vFile) vFile.value = '';
                        loadResources('admin'); 
                    }
                };
            }
            modal.style.display = 'flex';
        })
        .withFailureHandler(function(error) {
            document.getElementById('editResourceModal').style.display = 'none';
            submitBtn.textContent = 'Save Changes';
            submitBtn.disabled = false;
            showErrorModal('System Error', 'Server Error: ' + error.toString());
        })
        .updateResource(form);
});

  // NEW: Handle Server Response for Edit/Update User
  function handleUpdateUserResponse(response) {
      const saveBtn = document.getElementById('editUserForm').querySelector('.add-user-button');
      saveBtn.textContent = 'Save Changes';
      saveBtn.disabled = false;

      const modal = document.getElementById('successModal');
      const editUserModal = document.getElementById('editUserModal');

      if (response.success) {
          // I-close ang Edit User Modal
          editUserModal.style.display = 'none';
          
          // Ipakita ang Success Modal
          document.getElementById('modalTitle').textContent = "Success";
          document.getElementById('modalMessage').textContent = response.message + " Refreshing list...";
          modal.style.display = 'flex';
          
          // I-reload ang user list
          updateContent('admin-dashboard'); 
      } else {
          // Ipakita ang Error sa Success Modal
          document.getElementById('modalTitle').textContent = "Error";
          document.getElementById('modalMessage').textContent = response.message;
          modal.style.display = 'flex';
      }
  }
  

// NEW: Handle Admin Sidebar Navigation
document.querySelector('.admin-sidebar').addEventListener('click', function(e) {
    if (e.target.closest('.admin-nav-item')) {
        const navItem = e.target.closest('.admin-nav-item');
        const viewType = navItem.getAttribute('data-admin-view');
        
        // I-toggle ang active class
        document.querySelectorAll('.admin-nav-item').forEach(item => item.classList.remove('active'));
        navItem.classList.add('active');

        // I-toggle ang Views
        const usersView = document.getElementById('adminUsersView');
        const spacesView = document.getElementById('adminSpacesView');
        const reservationsView = document.getElementById('adminReservationsView'); 
        const importView = document.getElementById('adminImportUsersView'); 
        const reportsView = document.getElementById('adminReportsView'); // NEW Reports View
        
        // Itago lahat muna
        usersView.style.display = 'none';
        spacesView.style.display = 'none';
        reservationsView.style.display = 'none'; 
        importView.style.display = 'none'; 
        reportsView.style.display = 'none'; // Hide NEW Reports View

        if (viewType === 'users') {
            usersView.style.display = 'block';
            updateContent('admin-dashboard'); 
        } else if (viewType === 'spaces') {
            spacesView.style.display = 'block';
            
            // Reset Tabs to Default (Resources)
            document.querySelectorAll('#spacesNavTabs .nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('#spacesNavTabs .nav-tab[data-space-tab="resources"]').classList.add('active');
            
            document.getElementById('resourcesTabContent').style.display = 'block';
            document.getElementById('categoriesTabContent').style.display = 'none';
            document.getElementById('floorPlansTabContent').style.display = 'none';
            
            loadCategories(); 
            loadResources('admin'); 

        } else if (viewType === 'reservations') { 
            reservationsView.style.display = 'block'; 
            loadAdminReservations(); 
            
        } else if (viewType === 'import') { 
            importView.style.display = 'block'; 
        } else if (viewType === 'reports') { // NEW: Handle Reports Tab
            reportsView.style.display = 'block';
        }
    }
});
  // NEW: Handle Spaces Management Sub-Tabs (Resources/Categories/Floor Plans)
  document.getElementById('spacesNavTabs').addEventListener('click', function(e) {
      if (e.target.classList.contains('nav-tab')) {
          const tabItem = e.target;
          const tabType = tabItem.getAttribute('data-space-tab');
          
          // I-toggle ang active class sa Tabs
          document.querySelectorAll('#spacesNavTabs .nav-tab').forEach(tab => tab.classList.remove('active'));
          tabItem.classList.add('active');

          // I-toggle ang Content
          document.getElementById('resourcesTabContent').style.display = 'none';
          document.getElementById('categoriesTabContent').style.display = 'none';
          document.getElementById('floorPlansTabContent').style.display = 'none';
          
          if (tabType === 'resources') {
              document.getElementById('resourcesTabContent').style.display = 'block';
              loadResources('admin'); 
          } else if (tabType === 'categories') {
              document.getElementById('categoriesTabContent').style.display = 'block';
              loadCategories(); 
          } else if (tabType === 'floor-plans') {
              document.getElementById('floorPlansTabContent').style.display = 'block';
              loadFloorPlans(); 
          }
      }
  });

// NEW: Handler for successful Category update/removal/addition
function handleCategoryActionResponse(response) {
    const modal = document.getElementById('successModal');
    
    if (response.success) {
        document.getElementById('modalTitle').textContent = "Success";
        document.getElementById('modalMessage').textContent = response.message + " Refreshing list...";
    } else {
        document.getElementById('modalTitle').textContent = "Error";
        document.getElementById('modalMessage').textContent = response.message;
    }
    modal.style.display = 'flex';
}

// **UPDATED:** Remove Click Handler - Gumagamit na ng Modal (for Categories)
function handleRemoveCategory(type, name) {
    const modal = document.getElementById('confirmRemovalModal');
    
    // 1. I-populate ang hidden fields
    document.getElementById('removeCategoryType').value = type;
    document.getElementById('removeCategoryName').value = name;

    // 2. I-populate ang display message
    const typeDisplay = type.charAt(0).toUpperCase() + type.slice(1);
    const message = `Are you sure you want to remove the category "<strong>${name}</strong>" (Type: ${typeDisplay})? This action cannot be undone.`;
    document.getElementById('removalModalMessage').innerHTML = message;

    // 3. I-tag ang button para malaman ng global listener na ito ay Category removal
    document.getElementById('executeRemovalButton').setAttribute('data-removal-type', 'category');

    // 4. I-reset at ipakita ang button state
    document.getElementById('executeRemovalButton').textContent = 'Remove';
    document.getElementById('executeRemovalButton').disabled = false;

    // 5. Ipakita ang modal
    modal.style.display = 'flex';
}

// >>> NEW: Function to open the confirmation modal for Resource removal <<<
function handleRemoveResource(type, name) {
    const modal = document.getElementById('confirmRemovalModal');
    const executeBtn = document.getElementById('executeRemovalButton');
    
    // 1. I-populate ang hidden fields para sa action (I-reuse ang existing Category fields)
    document.getElementById('removeCategoryType').value = type;
    document.getElementById('removeCategoryName').value = name;

    // 2. I-populate ang display message
    const typeDisplay = type.charAt(0).toUpperCase() + type.slice(1);
    const message = `Are you sure you want to remove the ${typeDisplay} "<strong>${name}</strong>"? This action cannot be undone.`;
    document.getElementById('removalModalMessage').innerHTML = message;

    // 3. I-tag ang button para malaman ng global listener na ito ay Resource removal
    executeBtn.setAttribute('data-removal-type', 'resource'); 

    // 4. Update button state and show modal
    executeBtn.textContent = 'Remove';
    executeBtn.disabled = false;
    modal.style.display = 'flex';
}

// **UPDATED:** Event Listener for the modal's Remove button (Pinapagana na ang Resource Removal)
document.getElementById('executeRemovalButton').addEventListener('click', function() {
    const type = document.getElementById('removeCategoryType').value;
    const name = document.getElementById('removeCategoryName').value;
    const removeBtn = this;
    const actionType = removeBtn.getAttribute('data-removal-type'); // Check the new data attribute

    // Disable button
    removeBtn.textContent = 'Removing...';
    removeBtn.disabled = true;

    // Set the server function name
    let functionName;

    if (actionType === 'resource') {
        functionName = 'removeResource';
    } else {
        // Default to category removal 
        functionName = 'removeCategory';
    }
    
    // Determine the reload function
    const reloadFunction = (actionType === 'resource') ? () => loadResources('admin') : loadCategories;

    // >>> ITO ANG PINAGBABAGO: Gumamit ng google.script.run.functionName(args) <<<
    google.script.run
        .withSuccessHandler(function(response) {
            document.getElementById('confirmRemovalModal').style.display = 'none'; 
            
            // Re-enable button
            removeBtn.textContent = 'Remove';
            removeBtn.disabled = false;
            removeBtn.removeAttribute('data-removal-type'); 
            
            // Handle Success/Error message and reload the correct list
            handleCategoryActionResponse(response); 
            if (response.success) {
                reloadFunction(); 
            }
        })
        .withFailureHandler(function(error) {
            document.getElementById('confirmRemovalModal').style.display = 'none'; 
            
            // Re-enable button
            removeBtn.textContent = 'Remove';
            removeBtn.disabled = false;
            removeBtn.removeAttribute('data-removal-type'); 
            
            // Ipakita ang error sa success modal (reuse mechanism)
            const modal = document.getElementById('successModal');
            document.getElementById('modalTitle').textContent = "Server Error";
            document.getElementById('modalMessage').textContent = 'Server Error: ' + error.toString();
            modal.style.display = 'flex';
        })
        [functionName](type, name, currentUser.email); // <--- UPDATED: Added currentUser.email
});


// NEW: Event Listener for ADD Category Buttons
document.getElementById('categoriesTabContent').addEventListener('click', function(e) {
    const target = e.target;
    
    // 1. Handle RENAME and REMOVE Clicks (Existing Logic)
    // NOTE: Ang RENAME button ay walang event listener dito na magbubukas ng modal.
    if (target.classList.contains('remove-btn')) {
        const type = target.getAttribute('data-type');
        const name = target.getAttribute('data-category');
        handleRemoveCategory(type, name);
        return;
    }

    // 2. Handle ADD Button Click (NEW LOGIC)
    if (target.classList.contains('add-category-btn')) {
        const categoryPanel = target.closest('.category-panel');
        if (!categoryPanel) return;

        const inputField = categoryPanel.querySelector('input[type="text"]');
        const type = inputField.getAttribute('data-type');
        const name = inputField.value.trim();
        
        if (!name) {
    showErrorModal('Validation Error', 'Category name cannot be empty.');
    return;
}

        // Disable button and input field
        target.textContent = 'Adding...';
        target.disabled = true;
        inputField.disabled = true;

        // Call Server Function
        google.script.run
            .withSuccessHandler(function(response) {
                // I-reset ang state
                target.textContent = 'Add';
                target.disabled = false;
                inputField.disabled = false;
                inputField.value = ''; // I-clear ang input field
                
                handleCategoryActionResponse(response); // Ipakita ang success/error
                if(response.success) { loadCategories(); } // Reload Categories
            })
            .withFailureHandler(function(error) {
                // I-reset ang state
                target.textContent = 'Add';
                target.disabled = false;
                inputField.disabled = false;
                
                // Ipakita ang error
                const modal = document.getElementById('successModal');
                document.getElementById('modalTitle').textContent = "Server Error";
                document.getElementById('modalMessage').textContent = 'Server Error: ' + error.toString();
                modal.style.display = 'flex';
            })
            .addNewCategory(type, name, currentUser.email); // <--- UPDATED: Added currentUser.email
    }
});

// ***************************************************************
// LOGIC FOR ADD NEW RESOURCE (ADD ROOM, ADD DESK, etc.)
// ***************************************************************

/**
 * NEW: Function to populate the Category Select options in the Add Resource Modal
 * @param {string} type - The resource type ('room', 'desk', 'seat', 'vehicle')
 */
function populateCategorySelect(type) {
    const selectElement = document.getElementById('resourceCategory');
    const categories = window.categoriesData[type] || [];
    
    selectElement.innerHTML = ''; // Clear existing options
    
    if (categories.length === 0) {
        selectElement.innerHTML = `<option value="">No ${type} categories found</option>`;
        selectElement.disabled = true;
        return;
    }
    
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        selectElement.appendChild(option);
    });
    
    selectElement.disabled = false;
}

/**
 * NEW: Function to populate and open the Add Resource Modal
 * UPDATED: Hiding Capacity and Floor/Area for 'seat' type.
 */
function openAddResourceModal(type) {
    const modal = document.getElementById('addResourceModal');
    const form = document.getElementById('addNewResourceForm');
    const title = document.getElementById('addResourceModalTitle');
    const submitBtn = document.getElementById('submitAddResourceButton');
    
    // --- UPDATED FIELD GROUPS ---
    const capacityInput = document.getElementById('resourceCapacity').closest('.pro-form-col'); // Kunin ang buong column
    const locationCol = document.getElementById('resourceLocation').closest('.pro-form-col'); // Kunin ang Location column
    
    const modelGroup = document.getElementById('resourceModelGroup'); 
    const photoGroup = document.getElementById('resourcePhotoGroup');
    const seatPhotoGroup = document.getElementById('resourceSeatGroup');
    const floorGroup = document.getElementById('resourceFloorGroup'); // Ito yung column sa kanan
    const amenitiesGroup = document.getElementById('resourceAmenitiesGroup');
    const seatDetailsGroup = document.getElementById('resourceSeatDetailsGroup');
    
    const typeLower = type.toLowerCase();
    const normalizedType = (typeLower === 'car seat' || typeLower === 'seat') ? 'seat' : typeLower;
    const typeDisplay = (normalizedType === 'seat') ? 'Seat' : type.charAt(0).toUpperCase() + type.slice(1);
    
    // 1. Setup UI
    title.textContent = `Add New ${typeDisplay}`;
    document.getElementById('addResourceType').value = normalizedType;
    submitBtn.textContent = `Add ${typeDisplay}`;
    
    // Populate Categories
    populateCategorySelect(normalizedType); 

    form.reset();
    submitBtn.disabled = false;
    
    // 2. Hide ALL special groups first
    modelGroup.style.display = 'none';
    photoGroup.style.display = 'none';
    seatPhotoGroup.style.display = 'none';
    amenitiesGroup.style.display = 'none';
    seatDetailsGroup.style.display = 'none';
    
    // Default visibility for Floor and Capacity (Ito ang babaguhin)
    if (floorGroup) floorGroup.style.display = 'flex'; // Default to visible
    if (capacityInput) capacityInput.style.display = 'flex'; // Default to visible
    
    // Tiyakin na full width ang Location column muna
    if (locationCol) locationCol.style.flex = '1';
    
    // Default Values
    document.getElementById('resourceCapacity').value = '1';
    document.getElementById('addSeatLayoutData').value = '{}';
    const seatPreview = document.getElementById('resourceSeatPhotoPreview');
    if(seatPreview) seatPreview.style.backgroundImage = 'none';

    // 3. Show specific groups based on Type
    if (normalizedType === 'vehicle') {
        // Sa Vehicle: Show Model at Photo
        modelGroup.style.display = 'block';
        photoGroup.style.display = 'block';
        
        // CLEAR/HIDE Floor (Floor/Area)
        if (floorGroup) floorGroup.style.display = 'none'; 
    } 
    else if (normalizedType === 'seat') {
        // Sa Seat: Show Layout Photo at Details
        seatPhotoGroup.style.display = 'block';      
        seatDetailsGroup.style.display = 'block';    
        
        // KRITIKAL NA PAGBABAGO: ITAGO ANG CAPACITY at FLOOR/AREA
        if (capacityInput) capacityInput.style.display = 'none'; // ITAGO Capacity
        if (floorGroup) floorGroup.style.display = 'none'; // ITAGO Floor / Area
        
        // Gawing full width ang Location
        if (locationCol) locationCol.style.flex = '2'; // (I-stretch ang Location column)
        
        document.getElementById('resourceSeatCount').value = '12';
    } 
    else if (normalizedType === 'desk') {
        // Desk: Capacity at Floor lang (Default state)
    } 
    else { // Room
        // Room: Show Amenities
        amenitiesGroup.style.display = 'block';
        document.getElementById('resourceCapacity').value = '5';
    }
    
    modal.style.display = 'flex';
}

// Event Listener for the 'Add Room', 'Add Desk', etc. buttons in the Admin Resources Tab
document.getElementById('addResourceButtons').addEventListener('click', function(e) {
    // Note: The category data must be loaded first before calling this!
    if (Object.keys(window.categoriesData).length === 0 || 
        (Object.values(window.categoriesData).flat().length === 0 && document.querySelector('#spacesNavTabs .nav-tab[data-space-tab="categories"]').classList.contains('active'))
    ) {
        alert('Categories are still loading or empty. Please check the Categories tab first.');
        return;
    }

    // <--- UPDATED LOGIC --->
    if (e.target.textContent.includes('Add Room')) {
        openAddResourceModal('Room');
    } else if (e.target.textContent.includes('Add Desk')) { 
        openAddResourceModal('Desk');
    } else if (e.target.textContent.includes('Add Car Seat')) { 
        openAddResourceModal('Seat'); 
    } else if (e.target.textContent.includes('Add Vehicle')) { 
        openAddResourceModal('Vehicle'); 
    }
});

// Handle Add New Resource Form Submission (UPDATED FOR FILE UPLOAD)
document.getElementById('addNewResourceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.target;
    const type = form.type.value;
    const typeDisplay = type.charAt(0).toUpperCase() + type.slice(1);
    const submitBtn = document.getElementById('submitAddResourceButton');
    
    // VALIDATION
    if (!form.name.value.trim()) {
        showErrorModal('Validation Error', 'Name/Description is required.');
        return;
    }

    if (type === 'vehicle') {
        const model = document.getElementById('resourceModel').value.trim();
        const plate = document.getElementById('resourcePlateNumber').value.trim();
        if (!model) { showErrorModal('Validation Error', 'Model is required for Vehicle.'); return; }
        if (!plate) { showErrorModal('Validation Error', 'Plate Number is required for Vehicle.'); return; }
    }
    
    if (type === 'seat' || type === 'car seat') {
        const seatCount = document.getElementById('resourceSeatCount').value;
        if (!seatCount || parseInt(seatCount) < 1) {
            showErrorModal('Validation Error', 'Seat Count must be at least 1.');
            return;
        }
        
        const layoutData = document.getElementById('addSeatLayoutData').value;
        if (!layoutData || layoutData === '{}') {
            if (!confirm("You haven't customized the Seat Layout. The default layout will be used. Continue?")) {
                return;
            }
        }
    }

    // SUBMIT
    submitBtn.textContent = 'Saving...';
    submitBtn.disabled = true;

    google.script.run
        .withSuccessHandler(function(response) {
            document.getElementById('addResourceModal').style.display = 'none';
            submitBtn.textContent = `Add ${typeDisplay}`;
            submitBtn.disabled = false;
            
            // Custom Success Modal Handling
            const modal = document.getElementById('successModal');
            document.getElementById('modalTitle').textContent = response.success ? "Success" : "Error";
            document.getElementById('modalMessage').textContent = response.message;
            
            const okBtn = modal.querySelector('.modal-ok-button');
            if(okBtn) {
                okBtn.style.backgroundColor = response.success ? '#4CAF50' : '#e53935';
                okBtn.onclick = function() {
                    document.getElementById('successModal').style.display = 'none';
                    if (response.success) {
                        form.reset();
                        const seatPreview = document.getElementById('resourceSeatPhotoPreview');
                        if(seatPreview) seatPreview.style.backgroundImage = 'none';
                        loadResources('admin');
                    }
                };
            }
            modal.style.display = 'flex';
        })
        .withFailureHandler(function(error) {
            document.getElementById('addResourceModal').style.display = 'none';
            submitBtn.textContent = `Add ${typeDisplay}`;
            submitBtn.disabled = false;
            showErrorModal('System Error', 'Server Error: ' + error.toString());
        })
        .addNewResource(form);
});

// ***************************************************************
// LOGIC FOR EDIT RESOURCE (Edit Room, Desk, etc.) (REMOVED)
// ***************************************************************
/**
 * NEW: Function to populate and open the Edit Resource Modal (UPDATED DESIGN).
 */
function openEditResourceModal(type, name) {
    const resource = window.allResourcesData.find(r => r.name === name && r.type.toLowerCase() === type.toLowerCase());
    
    if (!resource) {
        alert('Error: Resource details not found.');
        return;
    }

    const modal = document.getElementById('editResourceModal');
    const form = document.getElementById('editResourceForm');
    const title = document.getElementById('editResourceModalTitle');
    const submitBtn = document.getElementById('submitEditResourceButton');
    
    // Groups
    const modelGroup = document.getElementById('editResourceModelGroup');
    const photoGroup = document.getElementById('editResourcePhotoGroup'); // Vehicle Photo
    const seatPhotoGroup = document.getElementById('editResourceSeatGroup'); // Seat Layout Image
    
    const floorGroup = document.getElementById('editResourceFloorGroup'); // Input container
    const capacityCol = document.getElementById('editCapacityCol'); // Capacity Column container
    const locationCol = document.getElementById('editLocationCol'); // Location Column container

    const amenitiesGroup = document.getElementById('editResourceAmenitiesGroup');
    const seatDetailsGroup = document.getElementById('editResourceSeatDetailsGroup'); // Dashed Box
    
    const typeLower = resource.type.toLowerCase();
    
    // 1. Setup UI & Hidden Fields
    title.textContent = `Edit Resource: ${name}`;
    document.getElementById('editResourceType').value = typeLower;
    document.getElementById('editResourceOriginalName').value = name; 
    submitBtn.textContent = 'Save Changes';
    
    // Reset form state
    form.reset();
    submitBtn.disabled = false;
    
    // 2. Hide ALL special groups first (Default State)
    modelGroup.style.display = 'none';
    photoGroup.style.display = 'none';
    seatPhotoGroup.style.display = 'none';
    seatDetailsGroup.style.display = 'none';
    amenitiesGroup.style.display = 'none';
    
    // Default: Show Floor and Capacity
    if(floorGroup) floorGroup.style.visibility = 'visible'; // Use visibility or display block parent
    if(floorGroup) floorGroup.closest('.pro-form-col').style.display = 'flex';
    
    if(capacityCol) capacityCol.style.display = 'flex';
    if(locationCol) locationCol.style.flex = '1'; // Default flex

    // Clear image previews
    document.getElementById('editSeatCurrentImage').style.backgroundImage = 'none';
    document.getElementById('editVehicleCurrentImage').style.backgroundImage = 'none';
    
    // Populate Categories
    const categorySelect = document.getElementById('editResourceCategory');
    const categories = window.categoriesData[typeLower] || [];
    categorySelect.innerHTML = ''; 
    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
    });

    // 3. Populate Common Fields
    document.getElementById('editResourceName').value = resource.name;
    document.getElementById('editResourceLocation').value = resource.location;
    document.getElementById('editResourceCapacity').value = resource.capacity;
    document.getElementById('editResourceCategory').value = resource.category;
    document.getElementById('editRequiresApproval').checked = resource.requiresApproval === 'Yes';
    document.getElementById('editResourceFloor').value = resource.floor; 

    // Accessible BU Checkboxes
    const accessibleBUArray = resource.accessibleBU.split(',').map(bu => bu.trim()).filter(bu => bu.length > 0);
    form.querySelectorAll('#editAccessibleBUCheckboxGroup input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = accessibleBUArray.includes(checkbox.value);
    });
    
    // 4. Show/Populate specific groups based on Type
    
    // --- VEHICLE ---
    if (typeLower === 'vehicle') {
        modelGroup.style.display = 'block';
        photoGroup.style.display = 'block';
        
        // Hide Floor Input (Col remains but hide content or hide col)
        if(floorGroup) floorGroup.closest('.pro-form-col').style.display = 'none';

        // Parse Model and Plate
        let model = '';
        let plate = '';
        if (resource.floor) {
            const modelMatch = resource.floor.match(/Model: (.*?) \|/);
            const plateMatch = resource.floor.match(/Plate: (.*)/);
            if (modelMatch) model = modelMatch[1];
            if (plateMatch) plate = plateMatch[1];
        }
        document.getElementById('editResourceModel').value = model;
        document.getElementById('editResourcePlateNumber').value = plate;
        
        if (resource.photoUrl) {
            displayLayoutImage(null, 'editVehicleCurrentImage', resource.photoUrl); 
        }
    } 
    // --- SEAT (SHUTTLE) ---
    else if (typeLower === 'seat' || typeLower === 'car seat') {
        seatPhotoGroup.style.display = 'block';      
        seatDetailsGroup.style.display = 'block'; // Red Dashed Box
        
        // Hide Capacity and Floor
        if(capacityCol) capacityCol.style.display = 'none';
        if(floorGroup) floorGroup.closest('.pro-form-col').style.display = 'none';
        
        // Stretch Location
        if(locationCol) locationCol.style.flex = '2';

        // Parse Seat Details
        let sCount = '12';
        let vLayout = 'Van';
        let layoutData = '{}';
        if (resource.amenities) {
            const countMatch = resource.amenities.match(/SeatCount: (\d+)/);
            const layoutMatch = resource.amenities.match(/Layout: (.*?) \|/);
            const dataMatch = resource.amenities.match(/LayoutConfig: ({.*})/);
            
            if (countMatch) sCount = countMatch[1];
            if (layoutMatch) vLayout = layoutMatch[1];
            if (dataMatch) layoutData = dataMatch[1];
        }

        document.getElementById('editResourceSeatCount').value = sCount;
        document.getElementById('editResourceVehicleLayout').value = vLayout;
        document.getElementById('editSeatLayoutData').value = layoutData;
        
        if (resource.photoUrl) {
            displayLayoutImage(null, 'editSeatCurrentImage', resource.photoUrl);
        }

    } 
    // --- ROOM ---
    else if (typeLower === 'room') {
        amenitiesGroup.style.display = 'block';
        
        // Amenities Checkboxes
        const amenitiesArray = resource.amenities.split(',').map(a => a.trim()).filter(a => a.length > 0);
        const amenitiesContainer = document.getElementById('editAmenitiesCheckboxGroup');
        amenitiesContainer.innerHTML = ''; 
        
        const allAmenities = ['Projector', 'Whiteboard', 'Video Conference', 'Large Display'];
        allAmenities.forEach(amenity => {
            const isChecked = amenitiesArray.includes(amenity);
            const checkboxHtml = `
                <label class="pro-checkbox-label" style="margin-right: 15px; margin-bottom: 5px;">
                    <input type="checkbox" name="amenities" value="${amenity}" ${isChecked ? 'checked' : ''}> ${amenity}
                </label>
            `;
            amenitiesContainer.innerHTML += checkboxHtml;
        });
    }
    
    // 5. Show modal
    modal.style.display = 'flex';
}



  // Login Form Submission Logic
  document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault(); 
    var form = e.target;
    var formData = { email: form.email.value, password: form.password.value };
    var signInBtn = form.querySelector('button');
    
    clearLoginError(); 
    
    signInBtn.textContent = 'Signing In...';
    signInBtn.disabled = true;

    google.script.run
      .withSuccessHandler(handleResponse) 
      .withFailureHandler(function(error) {
          showLoginError('An unexpected server error occurred. Please try again later.'); 
          signInBtn.textContent = 'Sign In';
          signInBtn.disabled = false;
      })
      .checkLogin(formData);
  });

function handleResponse(response) {
    var loginView = document.getElementById('loginView');
    var dashboardView = document.getElementById('dashboardView');
    var signInBtn = document.getElementById('loginForm').querySelector('button');

    if (response.success) {
      clearLoginError(); 
      
      // Store current user info
      currentUser.email = response.email;
      currentUser.role = response.role; 
      currentUser.name = response.name; 
      currentUser.businessUnit = response.businessUnit; 
      
      // 1. Determine Full Name (For Dropdown)
      // Gamitin ang Name mula sa database, or email prefix kung wala
      let displayName = currentUser.name || response.email.split('@')[0];
      
      // 2. Determine First Name Only (For Header)
      let firstNameOnly = displayName;

      if (currentUser.name) {
          // Hatiin ang pangalan gamit ang space at kunin ang una
          const nameParts = currentUser.name.trim().split(' ');
          if (nameParts.length > 0) {
              firstNameOnly = nameParts[0];
              // I-format: Capitalize first letter (e.g., "christofer" -> "Christofer")
              firstNameOnly = firstNameOnly.charAt(0).toUpperCase() + firstNameOnly.slice(1).toLowerCase();
          }
      } else {
          // Kung email prefix ang gamit, capitalize lang ang una
          firstNameOnly = firstNameOnly.charAt(0).toUpperCase() + firstNameOnly.slice(1);
      }
      
      // Update Header Display -> FIRST NAME ONLY
      document.getElementById('userNameRole').textContent = firstNameOnly;
      
      // Dropdown Header -> FULL NAME (Para formal pa rin)
      document.getElementById('dropdownUserName').textContent = displayName;
      document.getElementById('dropdownUserBU').textContent = currentUser.businessUnit; 
      
      // I-CHECK KUNG KASAMA BA SA ROLE STRING ANG 'admin' O 'approver'
      const rolesStringLower = response.role.toLowerCase();
      
      var approvalsTab = document.getElementById('approvalsTab');
      // Approvals: Kung may 'admin' O 'approver' sa string
      approvalsTab.style.display = (rolesStringLower.includes('admin') || rolesStringLower.includes('approver')) ? 'flex' : 'none';

      // Admin Dashboard: Kung may 'admin' sa string
      var adminDashboardLink = document.getElementById('adminDashboardLink');
      adminDashboardLink.style.display = (rolesStringLower.includes('admin')) ? 'block' : 'none';

      loginView.style.display = 'none';
      document.body.style.display = 'flex'; 
      dashboardView.style.display = 'block'; 
      
      // NEW: I-preload ang lahat ng data BAGO pumunta sa default tab.
      preloadAllData('room'); // Ipasa ang target tab ('room')
      
      // Tiyakin na ang button ay naka-reset
      signInBtn.textContent = 'Sign In';
      signInBtn.disabled = false;
    } else {
      showLoginError(response.message || 'Invalid email or password. Please try again.'); 
      document.getElementById('loginForm').querySelector('button').textContent = 'Sign In';
      document.getElementById('loginForm').querySelector('button').disabled = false;
    }
}

// NEW: Event listener for all 'Reserve Now' buttons
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('reserve-button-user')) {
        const resourceName = e.target.getAttribute('data-resource-name');
        openReservationModal(resourceName);
    }
});

/**
 * Opens the Reservation Modal and sets limits (Min = Today, Max = 1 Month).
 */
function openReservationModal(resourceName) {
    const resource = window.allResourcesData.find(r => r.name === resourceName);
    
    if (!resource) {
        alert('Error: Resource details not found.');
        return;
    }

    const modal = document.getElementById('reservationModal');
    const form = document.getElementById('reservationForm');
    const participantsGroup = document.getElementById('reserveParticipantsGroup'); 
    
    // CHECK: Kung Seat ang type, ilipat sa Seat Selection Modal
    if (resource.type.toLowerCase() === 'seat' || resource.type.toLowerCase() === 'car seat') {
        openSeatSelectionModal(resourceName); 
        return; 
    }

    // 1. Reset form and populate modal title
    form.reset();
    document.getElementById('reservationModalTitle').textContent = `Reserve: ${resourceName}`;
    
    // 2. Populate Hidden Fields
    document.getElementById('reserveResourceName').value = resourceName;
    document.getElementById('reserveResourceType').value = resource.type;
    document.getElementById('reserveRequesterEmail').value = currentUser.email; 

    // 3. DATE LOGIC: MIN (Today) & MAX (Today + 1 Month)
    const dateInput = document.getElementById('reserveDate');
    const now = new Date();

    // A. Format Today (YYYY-MM-DD)
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}-${mm}-${dd}`;

    // B. Calculate Max Date (Today + 1 Month)
    const maxDate = new Date();
    maxDate.setMonth(maxDate.getMonth() + 1);
    
    const maxYyyy = maxDate.getFullYear();
    const maxMm = String(maxDate.getMonth() + 1).padStart(2, '0');
    const maxDd = String(maxDate.getDate()).padStart(2, '0');
    const maxDateStr = `${maxYyyy}-${maxMm}-${maxDd}`;

    // C. Apply Limits to Input
    dateInput.value = todayStr;       // Default value: Today
    dateInput.setAttribute('min', todayStr);   // Bawal ang nakalipas
    dateInput.setAttribute('max', maxDateStr); // Bawal ang lampas 1 month (NEW)

    // 4. Handle Participants Field Visibility
    // Hide participants for Desk/Vehicle/Seat types
    if (resource.type.toLowerCase() === 'desk' || resource.type.toLowerCase() === 'vehicle') {
        participantsGroup.style.display = 'none';
        document.getElementById('reserveParticipants').value = ''; 
    } else {
        participantsGroup.style.display = 'block';
    }
    
    // 5. Update button state and show modal
    const submitBtn = document.getElementById('submitReserveButton');
    submitBtn.textContent = 'Reserve Now';
    submitBtn.disabled = false;
    
    modal.style.display = 'flex';
}

// Function to handle the response from the server after reservation attempt
function handleNewReservationResponse(response) {
    const submitBtn = document.getElementById('submitReserveButton');
    submitBtn.textContent = 'Reserve Now';
    submitBtn.disabled = false;

    const modal = document.getElementById('successModal');
    document.getElementById('reservationModal').style.display = 'none'; // Close form

    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const okButton = modal.querySelector('.modal-ok-button');

    if (response.success) {
        const resourceName = response.resourceName;
        const status = response.approvalStatus; 
        
        let messageText = '';

        if (status === 'Pending') {
            modalTitle.textContent = "Reservation Submitted";
            messageText = `Your reservation for ${resourceName} is pending approval.`;
        } else if (status === 'Approved') {
            modalTitle.textContent = "Reservation Submitted";
            messageText = `Your reservation for ${resourceName} has been confirmed.`;
        } else {
            modalTitle.textContent = "Success";
            messageText = response.message;
        }

        modalMessage.textContent = messageText;
        
        // SUCCESS: Gawing GREEN (o Default theme color)
        if(okButton) {
            okButton.style.backgroundColor = '#4CAF50'; // Green for Success
            
            okButton.onclick = function() {
                document.getElementById('successModal').style.display = 'none';
                refreshCurrentView(); 
            };
        }
        
    } else {
        // ERROR: Gawing RED ang button
        modalTitle.textContent = "Error";
        modalMessage.textContent = response.message;
        
        if(okButton) {
            okButton.style.backgroundColor = '#e53935'; // RED for Error
            
            okButton.onclick = function() {
                document.getElementById('successModal').style.display = 'none';
                // Hindi na kailangan mag-refresh kung error lang naman
            };
        }
    }
    
    modal.style.display = 'flex';
}
// NEW: Handle Reservation Form Submission
document.getElementById('reservationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.target;
    const submitBtn = document.getElementById('submitReserveButton');
    
    const formData = {
        resourceName: form.resourceName.value,
        resourceType: form.resourceType.value,
        requesterEmail: form.requesterEmail.value,
        date: form.date.value,
        startTime: form.startTime.value,
        endTime: form.endTime.value,
        participants: form.participants.value,
        notes: form.notes.value
    };

    if (formData.startTime >= formData.endTime) {
        showErrorModal('Time Error', 'Start Time must be before End Time.');
        return;
    }

    submitBtn.textContent = 'Submitting...';
    submitBtn.disabled = true;

    google.script.run
        .withSuccessHandler(handleNewReservationResponse)
        .withFailureHandler(function(error) {
            showErrorModal('System Error', 'Server Error: ' + error);
            submitBtn.textContent = 'Reserve Now';
            submitBtn.disabled = false;
        })
        .addNewReservation(formData);
});

// ---------------------------------------------------------------
// NEW: Handle SEAT RESERVATION Form Submission
// ---------------------------------------------------------------
document.getElementById('seatReservationForm').addEventListener('submit', function(e) {
    e.preventDefault(); 
    const form = e.target;
    const submitBtn = document.getElementById('submitReserveSeatButton');
    
    // Gather Data
    const resourceName = document.getElementById('seatReserveResourceName').value;
    const date = document.getElementById('seatReserveDate').value;
    const startTime = document.getElementById('seatReserveStartTime').value;
    const endTime = document.getElementById('seatReserveEndTime').value;
    const notes = document.getElementById('seatReserveNotes').value;
    const seatNumber = document.getElementById('selectedSeatNumber').value;

    // VALIDATION
    if (!seatNumber) {
        showErrorModal('Selection Error', 'Please select a seat first.');
        return;
    }
    
    if (startTime >= endTime) {
        showErrorModal('Time Error', 'Start Time must be before End Time.');
        return;
    }

    const reservationData = {
        resourceName: resourceName,
        resourceType: 'seat',
        requesterEmail: currentUser.email, 
        date: date,
        startTime: startTime,
        endTime: endTime,
        participants: '', 
        notes: notes,
        seatNumber: seatNumber 
    };

    submitBtn.textContent = 'Reserving...';
    submitBtn.disabled = true;

    google.script.run
        .withSuccessHandler(handleSeatReservationResponse)
        .withFailureHandler(function(error) {
            showErrorModal('System Error', 'Server Error: ' + error);
            submitBtn.textContent = 'Reserve Seat';
            submitBtn.disabled = false;
        })
        .addNewReservation(reservationData); 
});
/**
 * Helper function to create an Approval card.
 */
function createApprovalCard(approval) {
    const card = document.createElement('div');
    card.className = 'reservation-card'; 
    card.style.display = 'flex';
    card.style.flexDirection = 'column';
    card.style.backgroundColor = 'white'; // Tiyakin na white ang background

    // Gumawa ng Name/Type line (tulad sa My Reservations)
    const resourceTypeDisplay = approval.resourceType.charAt(0).toUpperCase() + approval.resourceType.slice(1);
    
    // I-format ang Date
    const dateDisplay = new Date(approval.date + 'T00:00:00').toLocaleDateString('en-US', { 
        day: 'numeric', month: 'long', year: 'numeric' 
    });

    card.innerHTML = `
        <div class="reservation-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 5px;">
            <div>
                <div class="reservation-name">${approval.resourceName}</div>
                <div class="reservation-type">${resourceTypeDisplay}</div>
            </div>
            <span class="status-tag pending">Pending</span>
        </div>

        <div class="reservation-details" style="display: block; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
            <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
                <strong>Requester:</strong> ${approval.requesterName} (${approval.requesterBU})
            </p>
            <p style="font-size: 13px; color: #555; margin: 5px 0 0 0;">
                <strong>Date:</strong> ${dateDisplay} &nbsp; | &nbsp; 
                <strong>Time:</strong> ${approval.startTime} - ${approval.endTime}
            </p>
            ${approval.notes ? `<p style="font-size: 12px; color: #777; margin: 5px 0 0 0;"><strong>Notes:</strong> ${approval.notes}</p>` : ''}
        </div>
        
        <div class="approval-action-buttons">
            <button class="reject-button" data-row-number="${approval.rowNumber}">Reject</button>
            <button class="approve-button" data-row-number="${approval.rowNumber}">Approve</button>
        </div>
    `;

    return card;
}


/**
 * Fetches and Renders the Pending Approvals.
 */
function loadApprovals() {
    const listContainer = document.getElementById('reservationListContainer');
    const messageId = 'listOnlyMessage-temp'; 

    // 1. I-clear ang container at ilagay ang loading message
    listContainer.innerHTML = `<p id="${messageId}" style="text-align: center; color: #777; padding: 0;">Loading pending approvals...</p>`;
    const messageEl = document.getElementById(messageId);

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                const approvals = response.approvals;
                
                if (approvals.length === 0) {
                    messageEl.textContent = tabContents['approvals'].subtitle; // 'There are no pending approvals.'
                    return;
                }
                
                listContainer.innerHTML = ''; 
                
                approvals.forEach(approval => {
                    listContainer.appendChild(createApprovalCard(approval));
                });
                
                // 3. Add Event Listeners for Approval/Reject Buttons
                document.querySelectorAll('.approve-button').forEach(button => {
                    button.addEventListener('click', function() {
                        handleApprovalAction(this.getAttribute('data-row-number'), 'Approved', this);
                    });
                });
                document.querySelectorAll('.reject-button').forEach(button => {
                    button.addEventListener('click', function() {
                        handleApprovalAction(this.getAttribute('data-row-number'), 'Rejected', this);
                    });
                });

            } else {
                // Error sa server
                messageEl.textContent = `Error: ${response.message}`;
            }
        })
        .withFailureHandler(function(error) {
            // Error sa Google Script side
            messageEl.textContent = 'Server Error: ' + error.toString();
        })
        .getPendingApprovals(); // <--- NEW SERVER CALL
}


/**
 * Handles the click event for Approve/Reject actions.
 */
/**
 * Handles the click event for Approve/Reject actions.
 */
// ============================================================
// 2. OPEN MODAL FUNCTION (Ito ang tatawagin ng buttons)
// ============================================================
function handleApprovalAction(rowNumber, status, button) {
    // A. I-save ang data sa hidden fields at variable
    document.getElementById('actionRowNumber').value = rowNumber;
    document.getElementById('actionStatus').value = status;
    pendingApprovalButtonElement = button; // Tandaan kung aling button ang pinindot

    // B. I-update ang Modal UI (Text at Colors)
    const title = document.getElementById('confirmActionTitle');
    const msg = document.getElementById('confirmActionMessage');
    const confirmBtn = document.getElementById('executeActionButton');

    // Ang status ay 'Approved' o 'Rejected'. Gamitin ang lowercase verb para sa message.
    const verb = status.toLowerCase().replace('ed', ''); // 'approved' -> 'approve', 'rejected' -> 'reject'
    const buttonText = status.toUpperCase(); // APPROVED o REJECTED

    title.textContent = `Confirm ${status}`;
    // Ginagamit ang verb (approve/reject) sa pangungusap
    msg.textContent = `Are you sure you want to ${verb} this reservation?`; 
    confirmBtn.textContent = buttonText; // APPROVED o REJECTED (for the button)

    // C. Palitan ang kulay ng button base sa action
  if (status === 'Approved') {
        confirmBtn.style.backgroundColor = '#4CAF50'; 
        confirmBtn.style.borderColor = '#4CAF50'; // <--- Ito ang kailangan
    }  else {
        // Red for Rejected action
        confirmBtn.style.backgroundColor = '#e53935'; 
    }

    // D. Ipakita ang Modal
    document.getElementById('confirmActionModal').style.display = 'flex';
}

// Helper para isara ang modal
function closeConfirmActionModal() {
    document.getElementById('confirmActionModal').style.display = 'none';
}

// ***************************************************************
// NEW: SEAT SELECTION LOGIC
// ***************************************************************

// ***************************************************************
// Helper Function: displayLayoutImage (NEW)
// ***************************************************************

/**
 * Helper function to display an uploaded image or existing URL as background.
 */
function displayLayoutImage(fileInput, targetElementId, imageUrl) {
    const targetElement = document.getElementById(targetElementId);
    
    // Default background settings
    targetElement.style.backgroundSize = 'contain';
    targetElement.style.backgroundRepeat = 'no-repeat';
    targetElement.style.backgroundPosition = 'center';
    targetElement.style.backgroundImage = 'none'; // Clear previous

    if (fileInput && fileInput.files && fileInput.files.length > 0) {
        // Option 1: Display uploaded file immediately
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            targetElement.style.backgroundImage = `url(${e.target.result})`;
        };
        reader.readAsDataURL(file);
    } else if (imageUrl && imageUrl.includes('http') && imageUrl !== 'Upload Error') {
        // Option 2: Display existing URL (for Edit modal and Seat Viewer)
        targetElement.style.backgroundImage = `url(${imageUrl})`;
    } else {
        // Clear or set default
        targetElement.style.backgroundImage = 'none';
    }
}

// ***************************************************************
// openSeatSelectionModal() (UPDATED)
// ***************************************************************

/**
 * Nag-o-open ng Seat Selection Modal at naglo-load ng availability.
 * UPDATED: Nagpa-pasa na ng backgroundImageUrl sa renderSeatMap.
 */
function openSeatSelectionModal(resourceName) {
    const resource = window.allResourcesData.find(r => r.name === resourceName);
    if (!resource) { alert('Error: Shuttle details not found.'); return; }

    const modal = document.getElementById('seatSelectionModal');
    const form = document.getElementById('seatReservationForm');
    const submitBtn = document.getElementById('submitReserveSeatButton');
    const mapContainer = document.getElementById('seatMapContainer');

    // 1. Setup Form/Title
    form.reset();
    
    // Use ISO format YYYY-MM-DD
    const today = new Date();
    const formattedDate = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
    
    // FIX: Gumamit ng toLocaleDateString para sa Month/Day display sa title
    const dateDisplay = new Date(formattedDate).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });
    
    document.getElementById('seatModalTitle').textContent = `Reserve a seat on ${resourceName} for ${dateDisplay}`;
    document.getElementById('seatReserveResourceName').value = resourceName;
    document.getElementById('seatReserveDate').value = formattedDate; // Hidden date field
    document.getElementById('selectedSeatNumber').value = ''; // Clear selected seat
    
    // Set default times (08:00 and 09:00 in 24hr format)
    document.getElementById('seatReserveStartTime').value = '08:00';
    document.getElementById('seatReserveEndTime').value = '09:00';
    
    submitBtn.disabled = true; // Disable button until seat is selected

    // --- NEW: EXTRACT LAYOUT CONFIG at IMAGE URL ---
    let layoutConfig = {};
    if (resource.amenities) {
        const match = resource.amenities.match(/LayoutConfig: ({.*})/);
        if (match && match[1]) {
            try {
                layoutConfig = JSON.parse(match[1]);
            } catch (e) {
                console.error("Failed to parse LayoutConfig:", e);
            }
        }
    }
    const actualTotalSeats = parseInt(resource.capacity) || 12;
    // *** NEW: Extract Image URL ***
    const backgroundImageUrl = (resource.photoUrl && resource.photoUrl.includes('http')) ? resource.photoUrl : '';
    // ******************************

    // Loading State
    mapContainer.innerHTML = '<p style="text-align: center; color: #777;">Loading seat map...</p>';

    // 2. Fetch Availability (Server Call)
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                // *** UPDATED CALL: Ngayon ay nagpapasa na ng image URL ***
                renderSeatMap(actualTotalSeats, response.bookedSeats, layoutConfig, backgroundImageUrl);
            } else {
                 mapContainer.innerHTML = `<p style="color:#e53935; text-align:center;">Error: ${response.message}</p>`;
            }
        })
        .withFailureHandler(function(error) {
            mapContainer.innerHTML = `<p style="color:#e53935; text-align:center;">Server Error: ${error}</p>`;
        })
        .getShuttleSeatStatus(resourceName, formattedDate); 

    // 3. Show Modal
    modal.style.display = 'flex';
}

// ***************************************************************
// renderSeatMap() (UPDATED)
// ***************************************************************

/**
 * Renders the seat map with Booked User Names.
 * UPDATED: Strictly matches Editor dimensions to fix alignment issues.
 */
function renderSeatMap(totalSeats, bookedSeatsMap, layoutConfig, backgroundImageUrl) {
    const container = document.getElementById('seatMapContainer');
    container.innerHTML = '';
    
    if (!layoutConfig || Object.keys(layoutConfig).length <= 1) { 
        container.innerHTML = '<p style="color:#e53935; text-align:center;">Error: No valid seat layout configuration found.</p>';
        return;
    }

    // Create Van Layout Wrapper
    const vanWrapper = document.createElement('div');
    vanWrapper.className = 'van-layout'; 
    
    // ---------------------------------------------------------
    // CRITICAL DIMENSIONS: (Dapat pareho ito sa Editor CSS)
    // ---------------------------------------------------------
    vanWrapper.style.width = '100%';        
    vanWrapper.style.maxWidth = '500px';    // Fixed Width (Editor size)
    vanWrapper.style.height = '400px';      // Fixed Height (Editor size)
    vanWrapper.style.margin = '0 auto';     // Center sa loob ng modal
    vanWrapper.style.position = 'relative'; 
    vanWrapper.style.overflow = 'visible';  // Para lumabas ang tooltip
    // ---------------------------------------------------------

    // Background Image Styling
    if (backgroundImageUrl) {
        vanWrapper.style.backgroundImage = `url(${backgroundImageUrl})`;
        vanWrapper.style.backgroundSize = 'contain';      // Fit image inside box
        vanWrapper.style.backgroundRepeat = 'no-repeat';  // Wag ulitin
        vanWrapper.style.backgroundPosition = 'center';   // Gitna
        vanWrapper.style.border = 'none';                 // Alisin ang border pag may image
        vanWrapper.style.backgroundColor = 'transparent';
    } else {
        // Fallback style kung walang image (gaya ng sa Editor)
        vanWrapper.style.border = '2px dashed #ccc';
        vanWrapper.style.backgroundColor = '#f9f9f9';
    }
    
    const seatSize = '35px'; 

    for (const id in layoutConfig) {
        const seatData = layoutConfig[id];
        
        if (!seatData.label) continue;
        
        const seatNumStr = String(seatData.label);
        const seatNumInt = parseInt(seatNumStr);
        
        const isBooked = bookedSeatsMap.hasOwnProperty(seatNumInt);
        const bookedByName = isBooked ? bookedSeatsMap[seatNumInt] : '';
        const isDriver = seatData.isDriver;

        const seatDiv = document.createElement('div');
        
        // Seat Styles
        seatDiv.style.position = 'absolute';
        seatDiv.style.width = seatSize;
        seatDiv.style.height = seatSize;
        seatDiv.style.borderRadius = '5px';
        seatDiv.style.display = 'flex';
        seatDiv.style.justifyContent = 'center';
        seatDiv.style.alignItems = 'center';
        seatDiv.style.fontSize = '13px';
        seatDiv.style.fontWeight = 'bold';
        seatDiv.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
        seatDiv.style.transition = 'transform 0.1s';
        
        // Coordinates
        seatDiv.style.left = seatData.x + 'px';
        seatDiv.style.top = seatData.y + 'px';

        if (isDriver) {
            seatDiv.className = 'seat driver';
            seatDiv.style.backgroundColor = '#424242';
            seatDiv.style.color = '#fff';
            seatDiv.textContent = 'D'; 
        } else if (isBooked) {
            seatDiv.className = 'seat booked';
            seatDiv.style.backgroundColor = '#cfd8dc';
            seatDiv.style.color = '#78909c';
            seatDiv.style.cursor = 'not-allowed';
            // Tooltip Logic
            seatDiv.innerHTML = `
                ${seatNumStr}
                <span class="seat-tooltip">Reserved by:<br><strong>${bookedByName}</strong></span>
            `;
        } else {
            seatDiv.className = 'seat available';
            seatDiv.style.backgroundColor = '#e8f5e9';
            seatDiv.style.color = '#2e7d32';
            seatDiv.style.border = '1px solid #4CAF50';
            seatDiv.style.cursor = 'pointer';
            seatDiv.textContent = seatNumStr;
            seatDiv.setAttribute('data-seat', seatNumStr);
            seatDiv.addEventListener('click', handleSeatSelection);
        }
        
        vanWrapper.appendChild(seatDiv);
    }
    
    container.appendChild(vanWrapper);
}
// ***************************************************************
// END OF ALL CORE FUNCTIONS
// ***************************************************************


// ***************************************************************
// NEW: EDIT LAYOUT (DRAG & DROP) LOGIC
// ***************************************************************

// Global variable to hold the current seat layout being edited
let currentLayoutConfig = {};
let seatEditorInitialized = false; 
let lastSeatId = 11; // Track the highest seat ID for adding new seats
let currentlySelectedEditorSeat = null; // Track the currently selected seat for removal

// Default layout for a 12-seat van (Initial placement in the 450x350 editor)
// Ginaya ang relative positions mula sa Seat Selection Modal
const DEFAULT_VAN_LAYOUT_CONFIG = {
    'D': { x: 380, y: 30, isDriver: true, label: 'D' },
    '1': { x: 380, y: 280, label: '1' },
    '2': { x: 280, y: 30, label: '2' },
    '3': { x: 280, y: 110, label: '3' },
    '4': { x: 280, y: 190, label: '4' },
    '5': { x: 180, y: 30, label: '5' },
    '6': { x: 180, y: 110, label: '6' },
    '7': { x: 180, y: 190, label: '7' },
    '8': { x: 80, y: 30, label: '8' },
    '9': { x: 80, y: 110, label: '9' },
    '10': { x: 80, y: 190, label: '10' },
    '11': { x: 80, y: 280, label: '11' },
};

// --- DRAG-AND-DROP HANDLERS ---
let activeDrag = false;
let currentSeat = null;
let offsetX, offsetY;

function dragStart(e) {
    // Tiyaking seat-editor ang pinindot at hindi button o ibang element
    if (e.target.classList.contains('seat-editor')) {
        // Line na ito ang susi: Tiyakin na nagre-register ang drag
        activeDrag = true;
        currentSeat = e.target;
        
        // Disable text selection during drag
        e.preventDefault(); 
        
        // Calculate offsets
        const rect = currentSeat.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        
        // Handle selection for removal
        document.querySelectorAll('.seat-editor').forEach(s => s.classList.remove('selected-for-removal'));
        currentSeat.classList.add('selected-for-removal');
        currentlySelectedEditorSeat = currentSeat; // Update tracking variable
        
        // Update selection state for buttons
        document.getElementById('removeSelectedButton').disabled = currentSeat.classList.contains('driver-seat');

        // Add move/end listeners to the document
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
    }
}

function drag(e) {
    if (!activeDrag || !currentSeat) return;

    e.preventDefault();
    
    const container = document.getElementById('seatLayoutEditor');
    const containerRect = container.getBoundingClientRect();
    
    // Calculate new position relative to the container
    let newX = e.clientX - containerRect.left - offsetX;
    let newY = e.clientY - containerRect.top - offsetY;

    // Boundary checks
    newX = Math.max(0, Math.min(newX, containerRect.width - currentSeat.offsetWidth));
    newY = Math.max(0, Math.min(newY, containerRect.height - currentSeat.offsetHeight));

    currentSeat.style.left = newX + 'px';
    currentSeat.style.top = newY + 'px';
    
    // Mark as dragging to prevent click event
    currentSeat.setAttribute('data-is-dragging', 'true');
}

function dragEnd() {
    if (!activeDrag || !currentSeat) return;

    // Update temporary config with new position
    const id = currentSeat.getAttribute('data-seat-id');
    const x = parseFloat(currentSeat.style.left);
    const y = parseFloat(currentSeat.style.top);

    if (currentLayoutConfig[id]) {
        currentLayoutConfig[id].x = x;
        currentLayoutConfig[id].y = y;
    }

    // Remove the drag flag and reset state
    currentSeat.removeAttribute('data-is-dragging');
    activeDrag = false;
    
    // Remove move/end listeners
    document.removeEventListener('mousemove', drag);
    document.removeEventListener('mouseup', dragEnd);
}
// --- INITIALIZATION AND RENDERING ---

/**
 * Creates the initial seat configuration object based on capacity.
 */
function createDefaultLayout(count) {
    const newLayout = {};
    let seatCounter = 1;
    let nextId = 0;
    
    // 1. Add Driver Seat (Gamitin ang ID 'D' para sa driver)
    newLayout['D'] = { x: 380, y: 30, isDriver: true, label: 'D' };
    
    // 2. Try to use the DEFAULT_VAN_LAYOUT_CONFIG for the first 11 seats
    for (const id in DEFAULT_VAN_LAYOUT_CONFIG) {
        if (id !== 'D' && seatCounter <= count) {
            newLayout[id] = DEFAULT_VAN_LAYOUT_CONFIG[id];
            seatCounter++;
            nextId = Math.max(nextId, parseInt(id));
        }
    }
    
    // 3. If count > 11, add the rest in a stack
    while (seatCounter <= count) {
        nextId++;
        const idStr = String(nextId);
        // Position new seats in a stack
        newLayout[idStr] = { 
            x: 50 + ( (seatCounter - 1) % 5 ) * 50, 
            y: 50 + ( Math.floor( (seatCounter - 1) / 5 ) * 50 ), 
            label: idStr, 
            isDriver: false 
        };
        seatCounter++;
    }
    
    lastSeatId = nextId; // Update the max ID
    return newLayout;
}

/**
 * Renders the seats in the editor based on the provided configuration.
 * UPDATED: Tanggap na nito ang Base64 (Local Uploads) at HTTP Links.
 */
function initializeSeatLayout(layoutConfig, imageUrl) {
    const editor = document.getElementById('seatLayoutEditor');
    editor.innerHTML = ''; // Clear previous seats
    
    // Fallback to default 12-seat layout if none exists or is empty.
    const configToUse = layoutConfig && Object.keys(layoutConfig).length > 1 ? layoutConfig : createDefaultLayout(12); 
    currentLayoutConfig = JSON.parse(JSON.stringify(configToUse)); 

    let maxLabel = 0;

    // --- DITO ANG FIX ---
    // Tinanggal natin ang ".includes('http')" restriction.
    // Basta may laman ang imageUrl, ipapakita natin.
    if (imageUrl && imageUrl.length > 10) { 
        editor.style.backgroundImage = `url('${imageUrl}')`; 
        editor.style.backgroundSize = 'contain';
        editor.style.backgroundRepeat = 'no-repeat';
        editor.style.backgroundPosition = 'center';
        editor.style.border = 'none';
        editor.style.backgroundColor = 'transparent';
    } else {
        // Default gray box kung walang image
        editor.style.backgroundImage = 'none';
        editor.style.border = '2px dashed #ccc';
        editor.style.backgroundColor = '#f7f7f7';
    }
    // --------------------
    
    // 2. Render Seats
    for (const id in currentLayoutConfig) {
        const seatData = currentLayoutConfig[id];
        
        const seatDiv = document.createElement('div');
        seatDiv.className = 'seat-editor';
        
        if (seatData.isDriver) {
            seatDiv.style.backgroundColor = '#424242'; // Dark gray for driver
            seatDiv.style.borderColor = '#212121';
            seatDiv.classList.add('driver-seat');
            seatDiv.textContent = 'D';
        } else {
            seatDiv.textContent = seatData.label;
            maxLabel = Math.max(maxLabel, parseInt(seatData.label));
        }
        
        seatDiv.setAttribute('data-seat-id', id);
        seatDiv.id = `editor-seat-${id}`; 
        
        // Apply position
        seatDiv.style.left = seatData.x + 'px';
        seatDiv.style.top = seatData.y + 'px';
        
        seatDiv.addEventListener('mousedown', dragStart);
        seatDiv.addEventListener('click', selectSeatForRemoval);

        editor.appendChild(seatDiv);
    }
    
    lastSeatId = maxLabel; 
    
    // 3. Reset selection state
    currentlySelectedEditorSeat = null;
    document.getElementById('removeSelectedButton').disabled = true;
}
// --- Seat Control Logic ---

function selectSeatForRemoval(e) {
    // Only proceed if it wasn't a drag event
    if (e.target.getAttribute('data-is-dragging') === 'true') {
        // Clear drag flag after use
        e.target.removeAttribute('data-is-dragging'); 
        return; 
    }
    
    const seat = e.target;
    
    // 1. Clear previous selection
    document.querySelectorAll('.seat-editor').forEach(s => s.classList.remove('selected-for-removal'));

    // 2. Toggle new selection state
    if (currentlySelectedEditorSeat === seat) {
        // Deselect
        currentlySelectedEditorSeat = null;
        document.getElementById('removeSelectedButton').disabled = true;
    } else {
        // Select new seat
        seat.classList.add('selected-for-removal');
        currentlySelectedEditorSeat = seat;
        // Disable removal of driver seat
        document.getElementById('removeSelectedButton').disabled = seat.classList.contains('driver-seat');
    }
}

function addNewSeat(isDriver = false) {
    const editor = document.getElementById('seatLayoutEditor');
    
    // 1. Determine ID and Label
    let id, label;
    if (isDriver) {
        if (currentLayoutConfig['D']) {
            alert('Driver seat already exists.');
            return;
        }
        id = 'D';
        label = 'D';
    } else {
        lastSeatId++; // Use next sequential number as the Label
        id = String(lastSeatId); // Use sequential number as the ID for simplicity in JS logic
        label = String(lastSeatId);
    }
    
    // 2. Default starting position (top left corner, offset by seat count for visibility)
    const count = Object.keys(currentLayoutConfig).length;
    const newSeat = {
        x: isDriver ? 380 : 10 + ( count % 5 ) * 50, 
        y: isDriver ? 30 : 10 + ( Math.floor( count / 5 ) * 50 ),
        isDriver: isDriver,
        label: label
    };
    
    // 3. Add to config
    currentLayoutConfig[id] = newSeat;

    // 4. Create DOM element
    const seatDiv = document.createElement('div');
    seatDiv.className = 'seat-editor';
    seatDiv.textContent = label;
    seatDiv.setAttribute('data-seat-id', id);
    seatDiv.id = `editor-seat-${id}`;
    seatDiv.style.left = newSeat.x + 'px'; 
    seatDiv.style.top = newSeat.y + 'px';
    
    if (isDriver) {
         seatDiv.style.backgroundColor = '#424242'; // Dark gray for driver
         seatDiv.style.borderColor = '#212121';
         seatDiv.classList.add('driver-seat');
         // document.getElementById('addDriverSeatBtn').style.display = 'none'; // Hindi na kailangan ang button na ito
    }
    
    // Attach listeners
    seatDiv.addEventListener('mousedown', dragStart);
    seatDiv.addEventListener('click', selectSeatForRemoval);

    editor.appendChild(seatDiv);
}

function removeSelectedSeat() {
    if (!currentlySelectedEditorSeat || currentlySelectedEditorSeat.classList.contains('driver-seat')) return;
    
    const idToRemove = currentlySelectedEditorSeat.getAttribute('data-seat-id');
    
    // 1. Remove from config
    delete currentLayoutConfig[idToRemove];
    
    // 2. Remove from DOM
    currentlySelectedEditorSeat.remove(); 
    
    // 3. Reset selection state
    currentlySelectedEditorSeat = null;
    document.getElementById('removeSelectedButton').disabled = true;

    // 4. Re-label remaining seats sequentially
    reLabelSeats();
}

function reLabelSeats() {
    // 1. Get all non-driver seats and sort them
    let passengerSeats = Object.entries(currentLayoutConfig)
        .filter(([, data]) => !data.isDriver)
        .sort(([, a], [, b]) => (a.y - b.y) || (a.x - b.x)); // Sort by Y then X
        
    let newLabel = 1;
    let newLayout = {};
    let maxLabel = 0;
    
    // 2. Start with driver seat (if exists)
    if (currentLayoutConfig['D']) {
        newLayout['D'] = currentLayoutConfig['D'];
    }

    // 3. Re-assign labels to passenger seats
    passengerSeats.forEach(([oldId, data]) => {
        const newId = String(newLabel);
        
        // Update data in the cloned object
        data.label = newId; 
        
        // Update DOM element
        const oldDiv = document.getElementById(`editor-seat-${oldId}`);
        if(oldDiv) {
            oldDiv.textContent = newId; // Update display label
            oldDiv.setAttribute('data-seat-id', newId); // Update D-A
            oldDiv.id = `editor-seat-${newId}`; // Update ID for next iteration/lookup
        }

        newLayout[newId] = data; // Add to the new config
        newLabel++;
    });
    
    // 4. Update the active config and last ID
    currentLayoutConfig = newLayout; 
    lastSeatId = newLabel - 1;
}


function saveLayoutButtonHandler() {
    const editorSeatLayoutData = document.getElementById('editorSeatLayoutData');
    const targetInputId = editorSeatLayoutData.getAttribute('data-target-id');
    
    const layoutInput = document.getElementById(targetInputId);
    const capacityInputId = (targetInputId === 'editSeatLayoutData') ? 'editResourceSeatCount' : 'resourceSeatCount';
    const capacityInput = document.getElementById(capacityInputId);
    
    const modal = document.getElementById('editLayoutModal');
    
    // 1. Re-label first to ensure sequential numbering (1, 2, 3...)
    reLabelSeats(); 
    
    // 2. Gather all seat positions from the map after re-labeling
    const finalLayout = {};
    let nonDriverSeatCount = 0;
    
    // Iterate over the finalized currentLayoutConfig
    Object.values(currentLayoutConfig).forEach(seatData => {
        // Use the label (which is the sequential number) as the final ID/key
        const key = seatData.isDriver ? 'D' : seatData.label; 
        
        finalLayout[key] = {
            x: seatData.x,
            y: seatData.y,
            label: seatData.label,
            isDriver: seatData.isDriver
        };
        
        if (!seatData.isDriver) {
            nonDriverSeatCount++;
        }
    });

    // 3. Update the main form's hidden field (for submission)
    layoutInput.value = JSON.stringify(finalLayout);

    // 4. Update the visible Seat Count field in the main form
    capacityInput.value = nonDriverSeatCount;
    
    // 5. Close Editor Modal
    modal.style.display = 'none';
    
    // 6. Show Success Modal instead of Alert (NEW CODE)
    const successModal = document.getElementById('successModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const okButton = successModal.querySelector('.modal-ok-button');

    modalTitle.textContent = "Layout Saved";
    modalMessage.textContent = `Layout configuration saved successfully! Total Seats: ${nonDriverSeatCount}`;
    
    if(okButton) {
        okButton.style.backgroundColor = '#4CAF50'; // Green for Success
        okButton.onclick = function() {
            successModal.style.display = 'none';
        };
    }
    successModal.style.display = 'flex';
}

function openEditLayoutModal() {
    const modal = document.getElementById('editLayoutModal');
    
    // Check if Edit Mode
    const isEditing = document.getElementById('editResourceModal').style.display === 'flex';
    
    // 1. Identify IDs
    const layoutInputId = isEditing ? 'editSeatLayoutData' : 'addSeatLayoutData';
    const capacityInputId = isEditing ? 'editResourceSeatCount' : 'resourceSeatCount';
    const resourceNameInputId = isEditing ? 'editResourceName' : 'resourceName';
    
    // File Input IDs (Yung mismong choose file button)
    const fileInputId = isEditing ? 'editResourceSeatPhoto' : 'resourceSeatPhoto';
    
    // Preview Div IDs (Yung box na pinaglalagyan ng image)
    const previewDivId = isEditing ? 'editSeatCurrentImage' : 'resourceSeatPhotoPreview';

    const layoutInput = document.getElementById(layoutInputId);
    const totalSeatsInput = document.getElementById(capacityInputId);
    const resourceNameInput = document.getElementById(resourceNameInputId);
    
    // 2. Prepare Layout Data
    const currentSeats = parseInt(totalSeatsInput.value) || 12;
    let layoutToLoad;
    try {
        const savedLayout = JSON.parse(layoutInput.value);
        if (savedLayout && Object.keys(savedLayout).length > 1) {
            layoutToLoad = savedLayout;
        } else {
            layoutToLoad = createDefaultLayout(currentSeats);
        }
    } catch (e) {
        layoutToLoad = createDefaultLayout(currentSeats);
    }

    // 3. START: IMAGE HANDLING LOGIC (ETO ANG FIX)
    
    const fileInput = document.getElementById(fileInputId);
    const previewDiv = document.getElementById(previewDivId);
    
    // A. Priority 1: Kung may bagong file na in-upload ngayon lang
    if (fileInput && fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            // Pagkatapos basahin ang file, buksan ang editor at ilagay ang background
            // Pass the base64 data directly
            initializeSeatLayout(layoutToLoad, e.target.result); 
            finalizeModalOpen(); // Show modal
        };
        
        reader.readAsDataURL(file); // Basahin ang file
        return; // Huminto muna dito, hihintayin ang reader.onload
    }
    
    // B. Priority 2: Kung walang bagong file, kunin ang existing image sa Preview Div (Edit Mode / Google Drive Link)
    let imageUrl = '';
    if (previewDiv && previewDiv.style.backgroundImage && previewDiv.style.backgroundImage !== 'none') {
        const bg = previewDiv.style.backgroundImage;
        // Linisin ang URL string
        imageUrl = bg.replace(/^url\(["']?/, '').replace(/["']?\)$/, '');
    }

    // C. Buksan agad gamit ang nakuha (o blanko) na image
    initializeSeatLayout(layoutToLoad, imageUrl);
    finalizeModalOpen();

    // --- Helper function para sa common UI updates ---
    function finalizeModalOpen() {
        document.getElementById('editorSeatLayoutData').setAttribute('data-target-id', layoutInputId);
        const modalTitle = document.getElementById('editLayoutModal').querySelector('.modal-title');
        const rName = resourceNameInput.value ? resourceNameInput.value : 'New Shuttle';
        modalTitle.textContent = `Edit Seat Layout for: ${rName}`;
        modal.style.display = 'flex';
    }
}
// ***************************************************************
// NEW: EAGER LOADING / CACHING LOGIC
// ***************************************************************

/**
 * Naglo-load ng lahat ng kinakailangang data (Categories, Resources, Floor Plans)
 * sa sandaling mag-successful ang login para sa mas mabilis na paglipat ng tab.
 * 
 * I-chichain natin ang calls para masiguro ang tamang pagkakasunod-sunod:
 * Categories -> FloorPlans -> Resources -> Go to Tab
 */
function preloadAllData(targetTab) {
    console.log("Preloading Categories...");
    
    // Step 1: Load Categories (Kailangan ito para sa Filters at Modals)
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                window.categoriesData = response.categories;
                console.log("Categories loaded. Preloading Floor Plans...");
                
                // Step 2: Load Floor Plans (Kailangan ito para sa Layout)
                google.script.run
                    .withSuccessHandler(function(fpResponse) {
                        if (fpResponse.success) {
                            window.allFloorPlansData = fpResponse.plans;
                            console.log("Floor Plans loaded. Preloading Resources...");
                            
                            // Step 3: Load All Resources (Kailangan ito para sa Resource Cards at Status)
                            google.script.run
                                .withSuccessHandler(function(resResponse) {
                                    if (resResponse.success) {
                                        // I-save sa global variable
                                        window.allResourcesData = resResponse.resources; 
                                        console.log("All Resources loaded. Opening Dashboard...");
                                        
                                        // Step 4: Pumunta sa default tab
                                        updateContent(targetTab); 
                                    } else {
                                        console.error("Failed to load Resources: " + resResponse.message);
                                        updateContent(targetTab); // Kahit may error, ituloy pa rin.
                                    }
                                })
                                .withFailureHandler(function(error) {
                                    console.error("Server Error loading Resources: " + error.toString());
                                    updateContent(targetTab); 
                                })
                                .getAllResources(currentUser.email);
                            
                        } else {
                            console.error("Failed to load Floor Plans: " + fpResponse.message);
                            preloadResourcesAndGoToTab(targetTab); // Ipagpatuloy sa Resources
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error("Server Error loading Floor Plans: " + error.toString());
                        preloadResourcesAndGoToTab(targetTab); // Ipagpatuloy sa Resources
                    })
                    .getAllFloorPlans(); 

            } else {
                console.error("Failed to load Categories: " + response.message);
                preloadResourcesAndGoToTab(targetTab); // Ipagpatuloy sa Resources
            }
        })
        .withFailureHandler(function(error) {
            console.error("Server Error loading Categories: " + error.toString());
            preloadResourcesAndGoToTab(targetTab); // Ipagpatuloy sa Resources
        })
        .getAllCategories();
}

/**
 * Helper function to load resources when categories/floorplans fail.
 */
function preloadResourcesAndGoToTab(targetTab) {
    console.log("Preloading Resources (Fallback)...");
     google.script.run
        .withSuccessHandler(function(resResponse) {
            if (resResponse.success) {
                window.allResourcesData = resResponse.resources; 
                console.log("All Resources loaded (Fallback). Opening Dashboard...");
            } else {
                console.error("Failed to load Resources (Fallback): " + resResponse.message);
            }
            updateContent(targetTab);
        })
        .withFailureHandler(function(error) {
            console.error("Server Error loading Resources (Fallback): " + error.toString());
            updateContent(targetTab);
        })
        .getAllResources(currentUser.email);
}

function setMinDate() {
    const today = new Date().toISOString().split('T')[0];
    
    // Para sa Reservation Modal
    const reserveDateInput = document.getElementById('reserveDate');
    if (reserveDateInput) reserveDateInput.setAttribute('min', today);

    // Para sa Car Seat View Filters (kung meron)
    const carFilterDate = document.querySelector('#carSeatView input[type="date"]');
    if (carFilterDate) carFilterDate.setAttribute('min', today);
}

// --- KRITIKAL: Ang buong content ng iyong <script> tag ---
// Note: Hinihiling na ang lahat ng functions (e.g., checkLogin, renderSeatMap, updateContent, etc.)
// ay nasa global scope (i.e., bago o labas ng DOMContentLoaded)
// para maging available sila dito.

document.addEventListener('DOMContentLoaded', function() {
    
    // ============================================================
    // 1. MOBILE MENU LOGIC
    // ============================================================
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const navTabs = document.getElementById('navTabs');
            navTabs.classList.toggle('mobile-visible');
        });
    }

    document.addEventListener('click', function(e) {
        const navTabs = document.getElementById('navTabs');
        const burger = document.getElementById('mobileMenuBtn');
        if (navTabs && navTabs.classList.contains('mobile-visible')) {
            if (!navTabs.contains(e.target) && (!burger || !burger.contains(e.target))) {
                navTabs.classList.remove('mobile-visible');
            }
        }
    });

    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const navTabs = document.getElementById('navTabs');
            if (navTabs) navTabs.classList.remove('mobile-visible');
        });
    });

    // ============================================================
    // 2. FORGOT PASSWORD LOGIC (FIXED FOR HIDDEN FIELDS)
    // ============================================================

    const forgotLink = document.getElementById('forgotPasswordLink');
    const forgotModal = document.getElementById('forgotPasswordModal');
    
    // DIVS
    const step1 = document.getElementById('forgotStep1');
    const step2 = document.getElementById('forgotStep2');
    const step3 = document.getElementById('forgotStep3');
    
    // BUTTONS
    const btnSendCode = document.getElementById('btnSendCode');
    const btnVerifyCode = document.getElementById('btnVerifyCode');
    const btnSavePass = document.getElementById('btnSavePass');
    
    // INPUTS
    const emailInput = document.getElementById('recoverEmail');
    const otpInput = document.getElementById('recoverOTP');
    
    // RESET FUNCTION
    window.closeForgotModal = function() {
        if (forgotModal) forgotModal.style.display = 'none';
        
        // Reset UI to Step 1
        if (step1) step1.style.display = 'block';
        if (step2) step2.style.display = 'none';
        if (step3) step3.style.display = 'none';
        
        if (btnSendCode) {
            btnSendCode.style.display = 'block';
            btnSendCode.textContent = 'Send Code';
            btnSendCode.disabled = false;
        }
        if (btnVerifyCode) {
            btnVerifyCode.style.display = 'none';
            btnVerifyCode.textContent = 'Verify Code';
            btnVerifyCode.disabled = false;
        }
        if (btnSavePass) {
            btnSavePass.style.display = 'none';
            btnSavePass.textContent = 'Save Password';
            btnSavePass.disabled = false;
        }
        if (emailInput) { emailInput.readOnly = false; emailInput.value = ''; }
        if (otpInput) { otpInput.readOnly = false; otpInput.value = ''; }
        
        const recoverNewPass = document.getElementById('recoverNewPass');
        const recoverConfirmPass = document.getElementById('recoverConfirmPass');
        if (recoverNewPass) recoverNewPass.value = '';
        if (recoverConfirmPass) recoverConfirmPass.value = '';
    };

    if (forgotLink && forgotModal) {
        // Open Modal
        forgotLink.addEventListener('click', function(e) {
            e.preventDefault();
            window.closeForgotModal(); // Fresh start and show modal
            forgotModal.style.display = 'flex';
        });

        // --- STEP 1: SEND CODE ---
        if (btnSendCode) {
            btnSendCode.addEventListener('click', function(e) {
                e.preventDefault();
                const email = emailInput.value.trim();
                if(!email) { alert("Please enter your email."); return; }

                btnSendCode.textContent = 'Sending...';
                btnSendCode.disabled = true;

                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            // Go to Step 2
                            step1.style.display = 'none';
                            step2.style.display = 'block';
                            btnSendCode.style.display = 'none';
                            btnVerifyCode.style.display = 'block';
                            emailInput.readOnly = true; // Lock Email
                        } else {
                            alert(response.message);
                            btnSendCode.textContent = 'Send Code';
                            btnSendCode.disabled = false;
                        }
                    })
                    .withFailureHandler(function(err) {
                        alert("Error: " + err);
                        btnSendCode.textContent = 'Send Code';
                        btnSendCode.disabled = false;
                    })
                    .sendForgotOTP(email);
            });
        }

        // --- STEP 2: VERIFY CODE ---
        if (btnVerifyCode) {
            btnVerifyCode.addEventListener('click', function(e) {
                e.preventDefault();
                const otp = otpInput.value.trim();
                const email = emailInput.value.trim();

                if (!otp) { alert("Please enter the 6-digit code."); return; }

                btnVerifyCode.textContent = 'Verifying...';
                btnVerifyCode.disabled = true;

                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            // Go to Step 3
                            step2.style.display = 'none';
                            step3.style.display = 'block';
                            btnVerifyCode.style.display = 'none';
                            btnSavePass.style.display = 'block';
                            otpInput.readOnly = true; // Lock OTP
                        } else {
                            alert(response.message);
                            btnVerifyCode.textContent = 'Verify Code';
                            btnVerifyCode.disabled = false;
                        }
                    })
                    .withFailureHandler(function(err) {
                        alert("Error: " + err);
                        btnVerifyCode.textContent = 'Verify Code';
                        btnVerifyCode.disabled = false;
                    })
                    .verifyOTPOnly(email, otp);
            });
        }

        // --- STEP 3: SAVE PASSWORD ---
        if (btnSavePass) {
            btnSavePass.addEventListener('click', function(e) {
                e.preventDefault();
                const newPass = document.getElementById('recoverNewPass').value;
                const confirmPass = document.getElementById('recoverConfirmPass').value;
                const email = emailInput.value.trim();
                const otp = otpInput.value.trim(); // Need OTP again for final security check

                if (newPass.length < 6) { alert("Password must be at least 6 characters."); return; }
                if (newPass !== confirmPass) { alert("Passwords do not match."); return; }

                btnSavePass.textContent = 'Saving...';
                btnSavePass.disabled = true;

                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            window.closeForgotModal();
                            // Show Success Message
                            const modal = document.getElementById('successModal');
                            document.getElementById('modalTitle').textContent = "Success";
                            document.getElementById('modalMessage').textContent = response.message;
                            const okBtn = modal.querySelector('.modal-ok-button');
                            if(okBtn) okBtn.style.backgroundColor = "#4CAF50"; 
                            modal.style.display = 'flex';
                        } else {
                            alert(response.message);
                            btnSavePass.textContent = 'Save Password';
                            btnSavePass.disabled = false;
                        }
                    })
                    .withFailureHandler(function(err) {
                        alert("Error: " + err);
                        btnSavePass.textContent = 'Save Password';
                        btnSavePass.disabled = false;
                    })
                    .finalizePasswordChange(email, otp, newPass);
            });
        }
    }

    // ============================================================
    // 3. SMART PARTICIPANT SUGGESTIONS
    // ============================================================
    
    let cachedUserEmails = [];

    google.script.run.withSuccessHandler(function(emails) {
        cachedUserEmails = emails;
        const dataList = document.getElementById('emailSuggestions');
        if (dataList) {
            dataList.innerHTML = '';
            emails.forEach(email => {
                const option = document.createElement('option');
                option.value = email;
                dataList.appendChild(option);
            });
        }
    }).getAllUserEmailsList();

    const participantsInput = document.getElementById('reserveParticipants');
    if (participantsInput) {
        participantsInput.addEventListener('change', function() {
            const val = this.value;
            const lastPart = val.split(',').pop().trim();
            
            if (cachedUserEmails.includes(val) || cachedUserEmails.includes(lastPart)) {
                 if (!val.trim().endsWith(',') && val.trim() !== "") {
                     this.value = val + ", ";
                 }
            }
        });
    }

    // ============================================================
    // 4. SEAT EDITOR & FILE PREVIEW LOGIC
    // ============================================================
    // NOTE: Ang mga functions na ito (addNewSeat, removeSelectedSeat, 
    // saveLayoutButtonHandler, openEditLayoutModal, displayLayoutImage)
    // ay dapat nasa labas ng DOMContentLoaded para gumana.

    const addSeatBtn = document.getElementById('addSeatButton');
    if (addSeatBtn) addSeatBtn.addEventListener('click', () => addNewSeat(false));

    const removeSeatBtn = document.getElementById('removeSelectedButton');
    if (removeSeatBtn) removeSeatBtn.addEventListener('click', removeSelectedSeat);

    const saveLayoutBtn = document.getElementById('saveLayoutButton');
    if (saveLayoutBtn) saveLayoutBtn.addEventListener('click', saveLayoutButtonHandler);
    
    const openAddEditorBtn = document.getElementById('openSeatLayoutEditorBtn');
    if (openAddEditorBtn) openAddEditorBtn.addEventListener('click', openEditLayoutModal);
    
    const openEditEditorBtn = document.getElementById('editSeatLayoutEditorBtn');
    if(openEditEditorBtn) {
        openEditEditorBtn.addEventListener('click', openEditLayoutModal);
    }
    
    function listenForFilePreview(fileInputId, targetElementId) {
        const fileInput = document.getElementById(fileInputId);
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                displayLayoutImage(this, targetElementId, null);
            });
        }
    }
    
    listenForFilePreview('resourceSeatPhoto', 'resourceSeatPhotoPreview'); 
    listenForFilePreview('editResourceSeatPhoto', 'editSeatCurrentImage');
    listenForFilePreview('editVehiclePhotoInputId', 'editVehicleCurrentImage');


    // ============================================================
    // 5. NEW/REVISED: GLOBAL DROPDOWN HANDLER (All Items)
    // ============================================================
    document.getElementById('userDropdownMenu').addEventListener('click', function(e) {
        const item = e.target.closest('.dropdown-item');
        if (item && item.getAttribute('data-item')) {
            const itemType = item.getAttribute('data-item');
            
            // Tiyaking ma-close ang dropdown bago mag-update ng content
            document.getElementById('userDropdownMenu').classList.remove('visible');

            // Special handling for Logout
            if (itemType === 'logout') {
                document.getElementById('dashboardView').style.display = 'none';
                document.getElementById('loginView').style.display = 'block';
                
                document.getElementById('loginForm').reset();
                var signInBtn = document.getElementById('loginForm').querySelector('button');
                signInBtn.textContent = 'Sign In';
                signInBtn.disabled = false;
                
                // currentUser must be reset (assuming this is a global var)
                currentUser = { email: '', role: '' };
                return; // Exit the function
            }

            // TAWAGIN ANG MAIN UPDATE CONTENT FUNCTION para sa lahat ng iba (Profile, Admin, Help)
            updateContent(itemType);
        }
    });
    
  // ============================================================
    // 6. NEW: HELP CENTER ACCORDION LOGIC
    // ============================================================
    
// 2. Accordion Functionality (FIXED: Para maiwasan ang putol na text)
document.querySelectorAll('.faq-header').forEach(header => {
    header.addEventListener('click', () => {
        const item = header.closest('.faq-item');
        const content = item.querySelector('.faq-content');
        const isActive = item.classList.contains('active');
        
        // Close all other active items (exclusive accordion)
        document.querySelectorAll('.faq-item.active').forEach(activeItem => {
            if (activeItem !== item) {
                activeItem.classList.remove('active');
                activeItem.querySelector('.faq-content').style.maxHeight = null;
            }
        });
        
        // Toggle the clicked item
        if (isActive) {
            item.classList.remove('active');
            content.style.maxHeight = null;
        } else {
            item.classList.add('active');
            
            // 1. Pansamantala nating i-se-set ang max-height sa 'fit-content'
            content.style.maxHeight = 'fit-content'; 
            
            // 2. Kunin ang tamang taas ng content (scrollHeight)
            const actualHeight = content.scrollHeight;
            
            // 3. Ibalik sa 0 muna (para sa transition effect)
            content.style.maxHeight = '0px'; 
            
            // 4. Magbigay ng maliit na timeout para sa DOM update at i-set ang final height
            setTimeout(() => {
                 // I-set ang final height (dagdagan ng 10px allowance para mas sigurado)
                 content.style.maxHeight = (actualHeight + 10) + "px"; 
            }, 10);
        }
    });
});

// Tiyakin na ang transition ay para lang sa height.
document.querySelectorAll('.faq-content').forEach(content => {
    content.style.transition = 'max-height 0.3s ease-out';
});

// ============================================================
// --- KRITIKAL: ADDED LISTENERS FOR NEW FEATURES ---
// ============================================================

    // 7. ADMIN RESERVATIONS FILTERS/SORTING LISTENERS
    const adminSearchInput = document.getElementById('adminSearchInput');
    const adminDateFilter = document.getElementById('adminDateFilter');
    const adminStatusFilter = document.getElementById('adminStatusFilter');
    
    // Paggamit ng onchange/onkeyup listeners
    if (adminSearchInput) adminSearchInput.addEventListener('keyup', applyAdminFilters);
    if (adminDateFilter) adminDateFilter.addEventListener('change', applyAdminFilters);
    if (adminStatusFilter) adminStatusFilter.addEventListener('change', applyAdminFilters);

    // Dito nag-a-attach ng sort event listeners sa mga header
    document.querySelectorAll('.sortable-header').forEach(header => {
        // HINDI NA TAYO AASA SA ONCLICK ATTRIBUTE DITO!
        // Kunin ang data-column attribute (na naidagdag sa HTML)
        const column = header.getAttribute('data-column'); 
        
        // Tiyakin na may column name bago mag-attach
        if (column) {
            // Hindi na kailangan ng removeAttribute('onclick') kung inalis mo na sa HTML
            // header.removeAttribute('onclick'); 
            header.addEventListener('click', () => sortAdminReservations(column));
        }
    });
    // 8. ADMIN REPORTS LISTENER
    const generateReportButton = document.getElementById('generateReportButton');
    if (generateReportButton) {
        generateReportButton.addEventListener('click', loadUtilizationReport);
    }
    
    // 9. MAP PAN/ZOOM EVENT LISTENERS (Called once on load)
    // NOTE: Ang initZoomPan ay dapat tawagin sa updateRightPanelLayout() tuwing may bagong map.
    
    // 10. CALENDAR TOGGLE BUTTON LISTENER
    const calendarToggleBtn = document.getElementById('calendarToggleButton');
    if (calendarToggleBtn) {
        calendarToggleBtn.addEventListener('click', toggleCalendarAvailability);
    }
    
    // 11. INITIAL SETUP/PRE-CHECKS
    
    // Tiyakin na na-call ang setMaxDateLimit
    setMaxDateLimit(); 
    
    // NOTE: Ang login form submission ay dapat nasa labas ng DOMContentLoaded o nasa tamang lugar.
    // Assuming ito ang katapusan ng inyong JS file.
});


// ***************************************************************
// NEW: SEAT SELECTION LOGIC
// ***************************************************************

// Handle seat selection click.
function handleSeatSelection(e) {
    const selectedSeat = e.target;
    // Tiyakin na hindi ito ma-trigger ng drag-and-drop
    if (selectedSeat.getAttribute('data-seat') === null) return; 
    
    const seatNumber = selectedSeat.getAttribute('data-seat');
    const form = document.getElementById('seatReservationForm');
    const submitBtn = document.getElementById('submitReserveSeatButton');

    // 1. Clear previous selection
    document.querySelectorAll('.seat.available').forEach(seat => {
        seat.classList.remove('selected');
    });

    // 2. Set new selection
    selectedSeat.classList.add('selected');
    document.getElementById('selectedSeatNumber').value = seatNumber;
    submitBtn.disabled = false;
}


/**
 * Handle Server Response for Seat Reservation.
 */
function handleSeatReservationResponse(response) {
    const modal = document.getElementById('successModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const okButton = modal.querySelector('.modal-ok-button');
    
    // I-close ang seat selection modal
    document.getElementById('seatSelectionModal').style.display = 'none';
    
    // Reset Reserve Seat Button
    const submitBtn = document.getElementById('submitReserveSeatButton');
    if (submitBtn) {
        submitBtn.textContent = 'Reserve Seat';
        submitBtn.disabled = true; 
    }
    
    if (response.success) {
        modalTitle.textContent = "Reservation Success";
        modalMessage.textContent = response.message;
        
        // SUCCESS: Gawing GREEN
        if(okButton) {
            okButton.style.backgroundColor = '#4CAF50'; // Green
            okButton.onclick = function() {
                document.getElementById('successModal').style.display = 'none';
                loadResources('car'); // Reload list
            };
        }

    } else {
        // ERROR: Gawing RED
        modalTitle.textContent = "Reservation Failed";
        modalMessage.textContent = response.message;
        
        if(okButton) {
            okButton.style.backgroundColor = '#e53935'; // RED
            okButton.onclick = function() {
                document.getElementById('successModal').style.display = 'none';
                refreshCurrentView(); 
            };
        }
    }
    
    modal.style.display = 'flex';
}

// ---------------------------------------------------------------
// NEW EVENT LISTENER: Floor Plan Upload Form Submission
// ---------------------------------------------------------------

document.getElementById('floorPlanUploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.target;
    const uploadBtn = document.getElementById('submitFloorPlanUploadButton');
    
    // Check for file
    const fileInput = document.getElementById('floorPlanPhoto');
    if (!fileInput.files || fileInput.files.length === 0) {
        showErrorModal('Upload Error', 'Please select a file to upload.');
        return;
    }
    
    uploadBtn.textContent = 'Uploading...';
    uploadBtn.disabled = true;

    // Call Server Function
    google.script.run
        .withSuccessHandler(handleFloorPlanUploadResponse)
        .withFailureHandler(function(error) {
            // Pinalitan ang alert ng Custom Modal
            showErrorModal('System Error', 'Server Error: ' + error);
            
            uploadBtn.textContent = 'Upload';
            uploadBtn.disabled = false;
            document.getElementById('floorPlanUploadModal').style.display='none';
        })
        .uploadFloorPlanImage(form); // Pass the form object for file upload
});

/**
 * Handle Server Response for Floor Plan Upload/Update.
 */
function handleFloorPlanUploadResponse(response) {
    const modal = document.getElementById('successModal');
    const uploadModal = document.getElementById('floorPlanUploadModal');
    
    // Close upload modal
    uploadModal.style.display = 'none';

    if (response.success) {
        document.getElementById('modalTitle').textContent = "Success";
        document.getElementById('modalMessage').textContent = response.message + " Refreshing list...";
        
        // Reload the floor plans list after a successful upload
        const okButton = modal.querySelector('.modal-ok-button');
        if(okButton) {
            okButton.onclick = function() {
                document.getElementById('successModal').style.display='none';
                loadFloorPlans(); 
            };
        }
    } else {
        document.getElementById('modalTitle').textContent = "Error";
        document.getElementById('modalMessage').textContent = response.message;
    }
    
    modal.style.display = 'flex';
}

/**
 * Helper function to create a single Floor Plan list item.
 */
function createFloorPlanListItem(type, categoryName, plan) {
    const item = document.createElement('div');
    item.className = 'floor-plan-item';
    
    // Check if a plan exists for this category
    const hasPlan = plan && plan.imageUrl && plan.imageUrl !== 'Upload Error';
    
    // Thumbnail and Status Text
    let thumbnailStyle = '';
    let statusText = 'Upload a plan to begin';
    let buttonText = 'Upload New';
    let replaceClass = 'upload-new-btn';

    if (hasPlan) {
        thumbnailStyle = `background-image: url('${plan.imageUrl}')`;
        statusText = 'Current Floor Plan';
        buttonText = 'Replace';
        replaceClass = 'replace-btn'; // Generic class for Replace button
    }
    
    // The "default" thumbnail icon (a little house)
    const defaultThumbnail = `<span style="font-size: 20px; color: #777;"></span>`;

    item.innerHTML = `
        <div class="floor-plan-details">
            <div class="floor-plan-thumbnail" style="${thumbnailStyle}">
                ${!hasPlan ? defaultThumbnail : ''}
            </div>
            <div class="plan-text">
                <h4>${categoryName}</h4>
                <p>${statusText}</p>
            </div>
        </div>
        <div class="floor-plan-actions">
            <!-- Edit Layout is a placeholder for now -->
            <button class="edit-layout-btn" data-category="${categoryName}" data-type="${type}" style="width: 100px;">Edit Layout</button>
            <button class="replace-btn ${replaceClass}" data-category="${categoryName}" data-type="${type}" data-plan-exists="${hasPlan}">${buttonText}</button>
        </div>
    `;

    return item;
}

/**
 * Renders the fetched Floor Plans into the Admin Floor Plans tab.
 * UPDATED: Connected 'Edit Layout' button to openFloorPlanEditor.
 */
function renderFloorPlanLists() {
    // Tiyakin na may categories data na (from loadCategories())
    if (!window.categoriesData || Object.keys(window.categoriesData).length === 0) {
        document.getElementById('roomFloorPlanList').innerHTML = '<p style="text-align: center; color: #e53935; padding: 20px;">Error: Categories not loaded. Please check the Categories tab first.</p>';
        document.getElementById('deskFloorPlanList').innerHTML = '<p style="text-align: center; color: #e53935; padding: 20px;">Error: Categories not loaded.</p>';
        return;
    }
    
    // 1. Create a map for quick lookup: 'type-categoryName' -> plan object
    const planMap = {};
    window.allFloorPlansData.forEach(plan => {
        planMap[`${plan.type}-${plan.categoryName}`] = plan;
    });

    // 2. Clear previous content
    const roomList = document.getElementById('roomFloorPlanList');
    const deskList = document.getElementById('deskFloorPlanList');
    roomList.innerHTML = '';
    deskList.innerHTML = '';

    // 3. Render Room Plans
    const roomCategories = window.categoriesData.room || [];
    if (roomCategories.length === 0) {
        roomList.innerHTML = '<p style="text-align: center; color: #777; padding: 15px;">No Room categories defined.</p>';
    } else {
        roomCategories.forEach(categoryName => {
            const plan = planMap[`room-${categoryName}`];
            roomList.appendChild(createFloorPlanListItem('room', categoryName, plan));
        });
    }

    // 4. Render Desk Plans
    const deskCategories = window.categoriesData.desk || [];
    if (deskCategories.length === 0) {
        deskList.innerHTML = '<p style="text-align: center; color: #777; padding: 15px;">No Desk categories defined.</p>';
    } else {
        deskCategories.forEach(categoryName => {
            const plan = planMap[`desk-${categoryName}`];
            deskList.appendChild(createFloorPlanListItem('desk', categoryName, plan));
        });
    }

    // 5. Attach Event Listeners for Actions

    // Listener for Replace/Upload New buttons
    document.querySelectorAll('.replace-btn, .upload-new-btn').forEach(button => {
        button.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            const categoryName = this.getAttribute('data-category');
            openFloorPlanUploadModal(type, categoryName);
        });
    });
    
    // Listener for Edit Layout buttons (UPDATED LOGIC)
    document.querySelectorAll('.edit-layout-btn').forEach(button => {
        button.addEventListener('click', function() {
            const categoryName = this.getAttribute('data-category');
            const type = this.getAttribute('data-type');
            
            // Check if a plan exists before allowing edit
            // Find the plan object from global data
            const plan = window.allFloorPlansData.find(p => p.type === type && p.categoryName === categoryName);
            
            if (!plan || !plan.imageUrl || plan.imageUrl === 'Upload Error') {
                 alert(`Please upload a floor plan image for the category "${categoryName}" before attempting to edit the layout.`);
                 return;
            }

            // Buksan ang Floor Plan Editor (Yung bagong function)
            // Ipapasa natin ang Image URL at ang existing Layout Data (kung meron)
            openFloorPlanEditor(type, categoryName, plan.imageUrl, plan.layoutData);
        });
    });
}

/**
 * Fetches all floor plans from the server.
 */
function loadFloorPlans() {
    // Tiyakin na nakatago ang Floor Plans bago mag-load
    if (document.getElementById('floorPlansTabContent').style.display !== 'block') return;

    // Set loading message
    document.getElementById('roomFloorPlanList').innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">Loading floor plans...</p>';
    document.getElementById('deskFloorPlanList').innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">Loading floor plans...</p>';
    
    // Call the server function
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                window.allFloorPlansData = response.plans;
                renderFloorPlanLists(); 
            } else {
                window.allFloorPlansData = []; // Clear data on error
                const message = response.message;
                document.getElementById('roomFloorPlanList').innerHTML = `<p style="text-align: center; color: #e53935; padding: 20px;">Error: ${message}</p>`;
                document.getElementById('deskFloorPlanList').innerHTML = `<p style="text-align: center; color: #e53935; padding: 20px;">Error: ${message}</p>`;
            }
        })
        .withFailureHandler(function(error) {
            window.allFloorPlansData = [];
            const message = 'Server Error: ' + error.toString();
            document.getElementById('roomFloorPlanList').innerHTML = `<p style="text-align: center; color: #e53935; padding: 20px;">${message}</p>`;
            document.getElementById('deskFloorPlanList').innerHTML = `<p style="text-align: center; color: #e53935; padding: 20px;">${message}</p>`;
        })
        .getAllFloorPlans(); 
}

/**
 * Opens the modal for uploading or replacing a floor plan image.
 */
function openFloorPlanUploadModal(type, categoryName) {
    const modal = document.getElementById('floorPlanUploadModal');
    const title = document.getElementById('uploadModalTitle');
    const form = document.getElementById('floorPlanUploadForm');
    
    // Update Title and Hidden Fields
    const typeDisplay = type.charAt(0).toUpperCase() + type.slice(1);
    title.textContent = `Upload Floor Plan for ${categoryName} (${typeDisplay})`;
    document.getElementById('uploadPlanType').value = type;
    document.getElementById('uploadPlanCategoryName').value = categoryName;

    // Reset Form (especially the file input)
    form.reset();
    document.getElementById('submitFloorPlanUploadButton').textContent = 'Upload';
    document.getElementById('submitFloorPlanUploadButton').disabled = false;
    
    modal.style.display = 'flex';
}
// --- FLOOR PLAN EDITOR FUNCTIONS ---

function openFloorPlanEditor(type, categoryName, imageUrl, layoutDataString) {
    const modal = document.getElementById('floorPlanEditorModal');
    const title = document.getElementById('fpEditorTitle');
    
    // Elements
    const imgElement = document.getElementById('fpEditorImageElement');
    const wrapper = document.getElementById('fpImageWrapper');
    
    // Set Context
    document.getElementById('fpEditType').value = type;
    document.getElementById('fpEditCategory').value = categoryName;
    title.textContent = `Edit Layout for: ${categoryName}`;
    
    // 1. Set Image Source
    imgElement.src = imageUrl;
    
    // 2. Clear previous markers inside the wrapper
    // (Remove only elements with class .fp-marker)
    const existingMarkers = wrapper.querySelectorAll('.fp-marker');
    existingMarkers.forEach(m => m.remove());
    
    // 3. Parse Saved Layout
    let savedLayout = {};
    try {
        savedLayout = JSON.parse(layoutDataString || '{}');
    } catch(e) { savedLayout = {}; }

    // 4. Get Resources
    const resources = window.allResourcesData.filter(r => 
        r.category === categoryName && r.type.toLowerCase() === type.toLowerCase()
    );

    if (resources.length === 0) {
        alert("No resources found for this category.");
        return;
    }

    // 5. Create Markers (Inject into WRAPPER, not Container)
    resources.forEach((res, index) => {
        const marker = document.createElement('div');
        marker.className = 'fp-marker';
        marker.setAttribute('data-resource-name', res.name);
        
        marker.innerHTML = `
            <div class="fp-dot"></div>
            <div class="fp-label">${res.name}</div>
        `;
        
        // Position Logic
        if (savedLayout[res.name]) {
            marker.style.left = savedLayout[res.name].x;
            marker.style.top = savedLayout[res.name].y;
        } else {
            // Default position (stacked)
            marker.style.left = (10 + (index * 5)) + '%';
            marker.style.top = (10 + (index * 5)) + '%';
        }
        
        // Attach Drag Event
        marker.addEventListener('mousedown', initFloorPlanDrag);
        
        wrapper.appendChild(marker); // Append to wrapper!
    });

    modal.style.display = 'flex';
}

function closeFloorPlanEditor() {
    document.getElementById('floorPlanEditorModal').style.display = 'none';
}

// 2. Drag Logic for Markers
let activeFpDrag = false;
let currentFpMarker = null;

function initFloorPlanDrag(e) {
    // Prevent default browser drag behavior
    e.preventDefault();
    
    activeFpDrag = true;
    currentFpMarker = e.currentTarget; // The .fp-marker div
    
    // Attach move/up listeners to document
    document.addEventListener('mousemove', dragFloorPlanMarker);
    document.addEventListener('mouseup', stopFloorPlanDrag);
}

function dragFloorPlanMarker(e) {
    if (!activeFpDrag || !currentFpMarker) return;
    
    // FIX: Get dimensions of the WRAPPER (the image size), not the container
    const wrapper = document.getElementById('fpImageWrapper');
    const rect = wrapper.getBoundingClientRect();
    
    // Calculate Position relative to wrapper
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;
    
    // Convert to Percentage
    let xPercent = (x / rect.width) * 100;
    let yPercent = (y / rect.height) * 100;
    
    // Boundary Checks (0% to 100%)
    xPercent = Math.max(0, Math.min(100, xPercent));
    yPercent = Math.max(0, Math.min(100, yPercent));
    
    // Apply Styles
    currentFpMarker.style.left = xPercent + '%';
    currentFpMarker.style.top = yPercent + '%';
}

function stopFloorPlanDrag() {
    activeFpDrag = false;
    currentFpMarker = null;
    document.removeEventListener('mousemove', dragFloorPlanMarker);
    document.removeEventListener('mouseup', stopFloorPlanDrag);
}

// 3. Save Layout
function saveFloorPlanLayout() {
    const type = document.getElementById('fpEditType').value;
    const categoryName = document.getElementById('fpEditCategory').value;
    
    // FIX: Select markers from wrapper
    const wrapper = document.getElementById('fpImageWrapper');
    const markers = wrapper.querySelectorAll('.fp-marker');
    
    const layoutData = {};
    
    markers.forEach(marker => {
        const name = marker.getAttribute('data-resource-name');
        const x = marker.style.left;
        const y = marker.style.top;
        layoutData[name] = { x: x, y: y };
    });
    
    const layoutString = JSON.stringify(layoutData);
    
    // UI Feedback & Server Call
    const saveBtn = document.querySelector('#floorPlanEditorModal .add-user-button');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Saving...';
    saveBtn.disabled = true;
    
    google.script.run
        .withSuccessHandler(function(response) {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            
            // 1. Isara agad ang editor modal
            closeFloorPlanEditor(); 
            
            // 2. Ipakita ang custom success modal (DITO ANG PAGBABAGO)
            const modal = document.getElementById('successModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');

            modalTitle.textContent = response.success ? "Success" : "Error";
            modalMessage.textContent = response.message;

            const okButton = modal.querySelector('.modal-ok-button');
            if (okButton) {
                okButton.onclick = function() {
                    document.getElementById('successModal').style.display = 'none';
                    if (response.success) {
                        loadFloorPlans(); // Reload list only on success
                    }
                };
            }
            modal.style.display = 'flex'; // Ipakita ang custom modal
        })
        .withFailureHandler(function(error) {
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
            // Mag-alert na lang para sa malalang server error
            alert('Server Error: ' + error); 
        })
        .saveFloorPlanLayout(type, categoryName, layoutString);
}
/**
 * REFRESH FUNCTION:
 * Kumukuha ng bagong data at ina-update ang Cards at Floor Plan
 * nang HINDI nire-reset ang Category/Location filters.
 */
function refreshCurrentView() {
    // 1. Alamin kung anong Tab ang active (room, desk, etc.)
    const activeTab = document.querySelector('.nav-tab.active');
    if (!activeTab) return;
    
    const currentType = activeTab.getAttribute('data-item');
    
    // 2. Kunin ang kasalukuyang nakapiling Category (para hindi bumalik sa 'All')
    const categorySelect = document.getElementById('categoryFilter');
    const currentCategory = categorySelect ? categorySelect.value : 'All Categories';

    // Optional: Maglagay ng loading indicator sa listahan
    const listArea = document.getElementById('itemListArea');
    if (listArea) listArea.style.opacity = '0.5'; // Gawing semi-transparent habang loading

    // 3. Kumuha ng bagong data sa Server
    google.script.run.withSuccessHandler(function(response) {
         // Ibalik ang opacity
         if (listArea) listArea.style.opacity = '1';

         if (response.success) {
             // UPDATE GLOBAL DATA
             window.allResourcesData = response.resources;

             // 4. Re-render Cards (Left Panel)
             // (Ang function na ito ay nagbabasa base sa value ng dropdowns, kaya safe ito)
             renderUserResourceView(window.allResourcesData, currentType);

             // 5. Re-render Floor Plan (Right Panel)
             // Pilitin nating i-update ang layout gamit ang current category
             if (currentType === 'room' || currentType === 'desk') {
                 updateRightPanelLayout(currentType, currentCategory);
             }
         }
    }).getAllResources(currentUser.email);
}
// LISTENER: Kapag pinindot ang Confirm/Reject sa loob ng Modal
document.getElementById('executeActionButton').addEventListener('click', function() {
    const rowNumber = document.getElementById('actionRowNumber').value;
    const status = document.getElementById('actionStatus').value;
    const modalBtn = this;

    // UI Updates (Disable button habang loading)
    modalBtn.textContent = 'Processing...';
    modalBtn.disabled = true;

    // Disable din yung buttons sa likod (sa listahan) para hindi ma-click ulit
    if (pendingApprovalButtonElement) {
        const card = pendingApprovalButtonElement.closest('.reservation-card');
        if (card) {
            card.querySelector('.reject-button').disabled = true;
            card.querySelector('.approve-button').disabled = true;
        }
    }

    // SERVER CALL (Kinopya natin yung logic mula sa lumang code)
    google.script.run
        .withSuccessHandler(function(response) {
            // Close Confirm Modal
            closeConfirmActionModal();
            modalBtn.disabled = false; // Reset button

            // Show Success Modal
            const successModal = document.getElementById('successModal');
            document.getElementById('modalTitle').textContent = response.success ? "Success" : "Error";
            document.getElementById('modalMessage').textContent = response.message;
            
            const okButton = successModal.querySelector('.modal-ok-button');
            if (okButton) {
                okButton.style.backgroundColor = '#e53935';
                
                // Logic para mag-refresh
                okButton.onclick = function() {
                    document.getElementById('successModal').style.display = 'none';
                    
                    // 1. Refresh Approval List
                    loadApprovals(); 
                    
                    // 2. Update Global Resources (Para mag-red ang cards sa ibang tab)
                    google.script.run.withSuccessHandler(function(resResponse) {
                        if (resResponse.success) {
                            window.allResourcesData = resResponse.resources;
                            // Optional: Refresh Admin View if open
                            if (document.getElementById('adminDashboardContainer').style.display !== 'none') {
                                renderAdminResourceList(resResponse.resources);
                            }
                        }
                    }).getAllResources(currentUser.email);
                };
            }
            successModal.style.display = 'flex';
        })
        .withFailureHandler(function(error) {
            closeConfirmActionModal();
            modalBtn.disabled = false;
            alert('Server Error: ' + error.toString());
            
            // Re-enable buttons sa card kung nag-fail
            if (pendingApprovalButtonElement) {
                const card = pendingApprovalButtonElement.closest('.reservation-card');
                if (card) {
                    card.querySelector('.reject-button').disabled = false;
                    card.querySelector('.approve-button').disabled = false;
                }
            }
        })
        .updateReservationApprovalStatus(rowNumber, status);
});
// --- ZOOM & PAN VARIABLES ---
let mapScale = 1;
let mapPanning = false;
let mapPointX = 0;
let mapPointY = 0;
let mapStartX = 0;
let mapStartY = 0;

/**
 * Initialize Event Listeners para sa Dragging
 */
function initZoomPan() {
    const container = document.getElementById('mapContainer');
    const content = document.getElementById('mapContent');

    if (!container || !content) return;

    // Reset variables pag nag-load ang bagong map
    mapScale = 1;
    mapPointX = 0;
    mapPointY = 0;
    updateTransform();

    // Mouse Down (Start Drag)
    container.addEventListener('mousedown', (e) => {
        if (e.target.closest('.zoom-controls')) return; // Ignore buttons
        e.preventDefault();
        mapStartX = e.clientX - mapPointX;
        mapStartY = e.clientY - mapPointY;
        mapPanning = true;
    });

    // Mouse Up (Stop Drag)
    document.addEventListener('mouseup', () => {
        mapPanning = false;
    });

    // Mouse Move (Dragging)
    container.addEventListener('mousemove', (e) => {
        if (!mapPanning) return;
        e.preventDefault();
        mapPointX = e.clientX - mapStartX;
        mapPointY = e.clientY - mapStartY;
        updateTransform();
    });
    
    // Optional: Mouse Wheel Zoom
    container.addEventListener('wheel', (e) => {
        e.preventDefault();
        const direction = e.deltaY > 0 ? -0.1 : 0.1;
        zoomMap(direction);
    });
}

/**
 * Apply CSS Transform based on current variables
 */
function updateTransform() {
    const content = document.getElementById('mapContent');
    if (content) {
        content.style.transform = `translate(${mapPointX}px, ${mapPointY}px) scale(${mapScale})`;
    }
}

/**
 * Zoom Function (+ / -)
 */
function zoomMap(amount) {
    mapScale += amount;
    // Limit Zoom Level (Min: 0.5x, Max: 4x)
    if (mapScale < 0.5) mapScale = 0.5;
    if (mapScale > 4) mapScale = 4;
    updateTransform();
}

/**
 * Reset Function (Balik sa gitna)
 */
function resetMap() {
    mapScale = 1;
    mapPointX = 0;
    mapPointY = 0;
    updateTransform();
}
// --- NEW: SSO Login Handler ---
document.getElementById('ssoLoginBtn').addEventListener('click', function() {
    const btn = this;
    const originalText = btn.textContent;
    
    // UI Feedback
    btn.textContent = 'Verifying Google Account...';
    btn.disabled = true;
    clearLoginError(); // Linisin ang error message kung meron

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                // Reuse the existing handleResponse function!
                handleResponse(response);
            } else {
                showLoginError(response.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        })
        .withFailureHandler(function(error) {
            showLoginError('SSO Error: ' + error);
            btn.textContent = originalText;
            btn.disabled = false;
        })
        .loginWithSSO();
});
// ---------------------------------------------------------
// FIX: Add New User Form Handler (With Error Modal)
// ---------------------------------------------------------
document.getElementById('addNewUserForm').addEventListener('submit', function(e) {
    e.preventDefault(); 
    
    const form = e.target;
    
    // 1. Get Values
    const firstName = document.getElementById('userFirstName').value.trim();
    const middleName = document.getElementById('userMiddleName').value.trim();
    const lastName = document.getElementById('userLastName').value.trim();
    const email = document.getElementById('userEmail').value.trim();
    const password = document.getElementById('userPassword').value;
    const confirmPassword = document.getElementById('userConfirmPassword').value;
    const businessUnit = document.getElementById('userBusinessUnit').value;

    // 2. Validation
    if (!firstName || !lastName || !email || !password) {
        showErrorModal("Validation Error", "Please fill in all required fields.");
        return;
    }

    if (password !== confirmPassword) {
        showErrorModal("Validation Error", "Passwords do not match.");
        return;
    }

    const roles = Array.from(form.querySelectorAll('input[name="roles"]:checked')).map(cb => cb.value);
    if (roles.length === 0) {
        showErrorModal("Validation Error", "Please select at least one role.");
        return;
    }

    // 3. Prepare Data
    const userData = {
        firstName: firstName,
        middleName: middleName,
        lastName: lastName,
        email: email,
        password: password,
        roles: roles,
        businessUnit: businessUnit
    };

    // 4. Disable Button & Show Loading
    const submitBtn = form.querySelector('.add-user-button');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Adding...';
    submitBtn.disabled = true;

    // 5. Send to Google Apps Script
    google.script.run
        .withSuccessHandler(function(response) {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;

            const modal = document.getElementById('successModal');
            const okButton = modal.querySelector('.modal-ok-button');

            if (response.success) {
                // SUCCESS: Close Add Form & Show Success Modal
                document.getElementById('addUserModal').style.display = 'none';
                form.reset(); 
                
                document.getElementById('modalTitle').textContent = "Success";
                document.getElementById('modalMessage').textContent = response.message;
                
                // Gawing GREEN ang button pag success
                if(okButton) {
                    okButton.style.backgroundColor = '#4CAF50'; 
                    okButton.onclick = function() {
                        document.getElementById('successModal').style.display = 'none';
                        // Refresh User List
                        const usersListDiv = document.getElementById('usersList');
                        usersListDiv.textContent = 'Refreshing list...';
                        google.script.run
                            .withSuccessHandler(function(res) { renderUserList(res.users); })
                            .getAllUsers(currentUser.email);
                    };
                }
                modal.style.display = 'flex';

            } else {
                // ERROR: Show Error Modal (Gamitin ang existing successModal pero ibahin ang laman)
                document.getElementById('modalTitle').textContent = "Error"; // Title
                document.getElementById('modalMessage').textContent = response.message; // Error Message galing backend
                
                // Gawing RED ang button pag error para warning effect
                if(okButton) {
                    okButton.style.backgroundColor = '#e53935'; 
                    okButton.onclick = function() {
                        document.getElementById('successModal').style.display = 'none';
                        // Huwag isara ang Add User Modal para ma-edit nila ang email
                    };
                }
                modal.style.display = 'flex';
            }
        })
        .withFailureHandler(function(error) {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            showErrorModal("System Error", error);
        })
        .addNewUser(userData);
});
// --- HELPER: SHOW ERROR MODAL ---
function showErrorModal(title, message) {
    const modal = document.getElementById('successModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const okButton = modal.querySelector('.modal-ok-button');

    // Set Content
    modalTitle.textContent = title;
    modalMessage.textContent = message;

    // Set Color to Red (Error Style)
    if (okButton) {
        okButton.style.backgroundColor = '#e53935'; 
        // Reset onclick to just close the modal
        okButton.onclick = function() {
            modal.style.display = 'none';
        };
    }

    modal.style.display = 'flex';
}
/**
 * Helper function to create a single Utilization Report list item.
 */
function createUtilizationReportItem(reportItem) {
    const item = document.createElement('div');
    item.className = 'reservation-list-item'; // Re-use the existing style
    item.style.borderBottom = '1px solid #eee';
    item.style.padding = '10px 15px';
    item.style.display = 'flex';
    item.style.alignItems = 'center';
    
    // Resource Type in parentheses (Room, Desk, etc.)
    
    item.innerHTML = `
        <span style="width: 45%; font-weight: 500;">${reportItem.resourceName}</span>
        <span style="width: 35%; color: #777;">${reportItem.date}</span>
        <span style="width: 20%; text-align: right; font-weight: bold; color: #e53935;">${reportItem.totalHours} hrs</span>
    `;

    return item;
}

/**
 * Renders the fetched Utilization Report.
 */
function renderUtilizationReport(report) {
    const listDiv = document.getElementById('adminReportsList');
    listDiv.innerHTML = ''; // Clear previous content

    if (report.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">No approved reservations found to generate a report.</p>';
        return;
    }

    report.forEach(item => {
        listDiv.appendChild(createUtilizationReportItem(item));
    });
}

/**
 * Fetches and Renders the Utilization Report from the server.
 */
function loadUtilizationReport() {
    const listDiv = document.getElementById('adminReportsList');
    const button = document.getElementById('generateReportButton');
    
    listDiv.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">Generating report...</p>';
    button.textContent = 'Generating...';
    button.disabled = true;

    google.script.run
        .withSuccessHandler(function(response) {
            button.textContent = 'Generate Report';
            button.disabled = false;
            if (response.success) {
                renderUtilizationReport(response.report);
            } else {
                listDiv.innerHTML = `<p style="text-align: center; color: #e53935; padding: 20px;">Error generating report: ${response.message}</p>`;
            }
        })
        .withFailureHandler(function(error) {
            button.textContent = 'Generate Report';
            button.disabled = false;
            listDiv.innerHTML = `<p style="text-align: center; color: #e53935; padding: 20px;">Server Error: ${error.toString()}</p>`;
        })
        .generateUtilizationReport();
}

// NEW EVENT LISTENER: Generate Report Button
document.getElementById('generateReportButton').addEventListener('click', loadUtilizationReport);

// NEW: Helper function to display the import report
function showImportResults(response) {
    const container = document.getElementById('importReportContainer');
    const summaryText = document.getElementById('importSummaryText');
    const errorDetails = document.getElementById('importErrorDetails');
    const errorList = document.getElementById('importErrorList');

    if (!response || !response.report) {
        showErrorModal('Import Failed', 'No valid response received from the server.');
        return;
    }

    const report = response.report;
    container.style.display = 'block';
    errorList.innerHTML = ''; // Clear previous errors
    
    // 1. Update Summary Text
    summaryText.innerHTML = `
        Status: <strong>${response.success ? 'Success' : 'Partial Success'}</strong><br>
        Total Records in File (excluding header): <strong>${report.totalRecords}</strong><br>
        Successfully Imported: <strong style="color: #4CAF50;">${report.imported}</strong><br>
        Skipped / Errors: <strong style="color: ${report.errors.length > 0 ? '#e53935' : '#777'};">${report.skipped}</strong>
    `;

    // 2. Update Error Details
    if (report.errors.length > 0) {
        errorDetails.style.display = 'block';
        report.errors.forEach(err => {
            const li = document.createElement('li');
            li.textContent = err;
            errorList.appendChild(li);
        });
    } else {
        errorDetails.style.display = 'none';
    }
}

// NEW EVENT LISTENER: Import Users Form Submission
document.getElementById('importUsersForm').addEventListener('submit', function(e) {
    e.preventDefault(); 
    
    const form = e.target;
    const fileInput = document.getElementById('csvFile');
    const submitBtn = document.getElementById('submitImportButton');
    
    if (!fileInput.files || fileInput.files.length === 0) {
        showErrorModal("File Missing", "Please select a CSV file to upload.");
        return;
    }

    // Disable Button & Show Loading
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Uploading & Importing...';
    submitBtn.disabled = true;

    // Send to Google Apps Script
    google.script.run
        .withSuccessHandler(function(response) {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            
            // Show the detailed report
            showImportResults(response);
            
            // Reload the Admin Users list in the background
            google.script.run
                .withSuccessHandler(function(res) { 
                    if (document.getElementById('adminUsersView').style.display === 'block') {
                        renderUserList(res.users); 
                    }
                })
                .getAllUsers(currentUser.email);
        })
        .withFailureHandler(function(error) {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            showErrorModal("System Error", 'File upload failed: ' + error.toString());
        })
        .importUsersFromCSV(form); // <--- NEW SERVER CALL
});
/**
 * Sets the MAX date attribute for date inputs to 1 month from today.
 */
function setMaxDateLimit() {
    const today = new Date();
    const maxDate = new Date();
    maxDate.setMonth(maxDate.getMonth() + 1); // Add 1 Month

    // Format to YYYY-MM-DD
    const maxDateString = maxDate.toISOString().split('T')[0];

    // 1. Set limit sa Reservation Modal Date Input
    const reserveDateInput = document.getElementById('reserveDate');
    if (reserveDateInput) {
        reserveDateInput.setAttribute('max', maxDateString);
    }

    // 2. Set limit sa Car/Vehicle Filter Date Input (kung meron)
    const carFilterDate = document.querySelector('#carSeatView input[type="date"]');
    if (carFilterDate) {
        carFilterDate.setAttribute('max', maxDateString);
    }
    
    // 3. Set limit sa Calendar View Date Input
    const calendarViewDate = document.getElementById('calendarViewDate');
    if (calendarViewDate) {
        calendarViewDate.setAttribute('max', maxDateString);
    }
}
/**
 * Applies Search, Date, Status filters AND Sorting to the data.
 */
function applyAdminFilters() {
    // 1. Get Filter Values
    const searchText = document.getElementById('adminSearchInput').value.toLowerCase();
    const dateValue = document.getElementById('adminDateFilter').value; // YYYY-MM-DD
    const statusValue = document.getElementById('adminStatusFilter').value;

    // 2. Filter Data
    let filteredData = allAdminReservationsData.filter(item => {
        // Search Filter (Matches Resource Name, User Name, or Resource Type)
        const matchesSearch = 
            item.resourceName.toLowerCase().includes(searchText) ||
            item.requesterName.toLowerCase().includes(searchText) ||
            item.resourceType.toLowerCase().includes(searchText);

        // Date Filter (Requires exact match, need to convert format if necessary)
        // item.date is usually "MM/dd/yyyy" from backend formatter
        let matchesDate = true;
        if (dateValue) {
            const itemDateObj = new Date(item.date);
            const itemDateStr = itemDateObj.getFullYear() + '-' + 
                                String(itemDateObj.getMonth() + 1).padStart(2, '0') + '-' + 
                                String(itemDateObj.getDate()).padStart(2, '0');
            matchesDate = (itemDateStr === dateValue);
        }

        // Status Filter
        let matchesStatus = true;
        if (statusValue !== 'All') {
            // Note: Check item.approvalStatus (Approved/Pending/Rejected) OR item.status (Cancelled)
            // Logic: If filter is "Cancelled", check item.status. 
            // Else check item.approvalStatus.
            if (statusValue === 'Cancelled') {
                matchesStatus = (item.status === 'Cancelled');
            } else {
                matchesStatus = (item.approvalStatus === statusValue && item.status !== 'Cancelled');
            }
        }

        return matchesSearch && matchesDate && matchesStatus;
    });

    // 3. Sort Data
    filteredData.sort((a, b) => {
        let valA, valB;

        switch (currentSortColumn) {
            case 'resource':
                valA = a.resourceName.toLowerCase();
                valB = b.resourceName.toLowerCase();
                break;
            case 'user':
                valA = a.requesterName.toLowerCase();
                valB = b.requesterName.toLowerCase();
                break;
            case 'status':
                valA = a.approvalStatus.toLowerCase();
                valB = b.approvalStatus.toLowerCase();
                break;
            case 'date':
            default:
                // Combine Date + Start Time for accurate sorting
                valA = new Date(a.date + ' ' + a.startTime).getTime();
                valB = new Date(b.date + ' ' + b.startTime).getTime();
                break;
        }

        if (valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
        if (valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
        return 0;
    });

    // 4. Update Header Icons
    updateSortIcons();

    // 5. Render
    renderAdminReservations(filteredData);
}

/**
 * Triggered when a header is clicked. Sets sort col/order.
 */
function sortAdminReservations(column) {
    if (currentSortColumn === column) {
        // Toggle Order
        currentSortOrder = (currentSortOrder === 'asc') ? 'desc' : 'asc';
    } else {
        // New Column, Default to Ascending (except Date, usually Descending first)
        currentSortColumn = column;
        currentSortOrder = (column === 'date') ? 'desc' : 'asc';
    }
    applyAdminFilters();
}

/**
 * Updates the arrows on table headers.
 */
function updateSortIcons() {
    // 1. Remove classes from all headers
    document.querySelectorAll('.sortable-header').forEach(el => {
        el.classList.remove('asc', 'desc');
    });

    // 2. Find the active header and apply the class
    document.querySelectorAll('.sortable-header').forEach(header => {
        // Ito ang critical line na gumagamit ng data-column
        if (header.getAttribute('data-column') === currentSortColumn) {
            header.classList.add(currentSortOrder);
        }
    });
}

/**
 * Resets all filters.
 */
function clearAdminFilters() {
    document.getElementById('adminSearchInput').value = '';
    document.getElementById('adminDateFilter').value = '';
    document.getElementById('adminStatusFilter').value = 'All';
    
    // Reset Sort
    currentSortColumn = 'date';
    currentSortOrder = 'desc';
    
    applyAdminFilters();
}
// NEW: Handle Vehicle Request Form Submission
document.getElementById('vehicleRequestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.target;
    const submitBtn = document.getElementById('submitVehicleRequestButton');
    
    // Gathers all data needed for a reservation
    const formData = {
        // Required Fields for Generic Reservation
        resourceName: form.resourceName.value, // "Vehicle Request"
        resourceType: form.resourceType.value, // "vehicle"
        requesterEmail: form.requesterEmail.value,
        date: form.date.value,
        startTime: form.startTime.value,
        endTime: form.endTime.value,
        participants: form.participants.value, // Number of Pax
        
        // Details provided by the user, appended to notes
        notes: `DESTINATION: ${form.destination.value} | PURPOSE: ${form.notes.value}` 
    };

    if (formData.startTime >= formData.endTime) {
        showErrorModal('Time Error', 'Start Time must be before End Time.');
        return;
    }

    submitBtn.textContent = 'Submitting Request...';
    submitBtn.disabled = true;

    // Call the existing addNewReservation function on the server
    google.script.run
        .withSuccessHandler(function(response) {
            submitBtn.textContent = 'Submit Vehicle Request';
            submitBtn.disabled = false;
            
            // Reuse existing success modal logic
            const modal = document.getElementById('successModal');
            const okButton = modal.querySelector('.modal-ok-button');
            
            document.getElementById('modalTitle').textContent = response.success ? "Request Submitted" : "Submission Error";
            document.getElementById('modalMessage').textContent = response.message;

            if(okButton) {
                okButton.style.backgroundColor = response.success ? '#4CAF50' : '#e53935';
                okButton.onclick = function() {
                    document.getElementById('successModal').style.display = 'none';
                    if (response.success) {
                        form.reset();
                        updateContent('my-reservations'); // Redirect to My Reservations to see the 'Pending' request
                    }
                };
            }
            modal.style.display = 'flex';
        })
        .withFailureHandler(function(error) {
            showErrorModal('System Error', 'Server Error: ' + error);
            submitBtn.textContent = 'Submit Vehicle Request';
            submitBtn.disabled = false;
        })
        .addNewReservation(formData);
});
</script>
</body>
</html>
